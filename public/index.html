<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SB TEMPUS | GenMineTOP SFA/CRM</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Helvetica Neue',sans-serif;background:#f3f3f3;color:#333}
.app{display:flex;height:100vh}
.sidebar{width:250px;background:#1a252f;color:#fff;overflow-y:auto;flex-shrink:0}
.sidebar-hdr{padding:16px 20px;border-bottom:1px solid #2d3e50}
.sidebar-hdr h2{font-size:15px;color:#0176d3;letter-spacing:.5px}
.sidebar-hdr small{color:#8899aa;font-size:11px}
.nav-sec{padding:8px 0;border-top:1px solid #2d3e50}
.nav-sec-title{padding:8px 20px;font-size:10px;font-weight:700;text-transform:uppercase;color:#667;letter-spacing:.5px}
.nav-item{padding:10px 20px;cursor:pointer;font-size:13px;border-left:3px solid transparent;transition:all .15s}
.nav-item:hover{background:#2d3e50;border-left-color:#0176d3}
.nav-item.active{background:#0176d3;border-left-color:#0176d3;font-weight:600}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.topbar{background:#fff;border-bottom:1px solid #e0e0e0;padding:12px 24px;display:flex;justify-content:space-between;align-items:center;height:56px}
.topbar h1{font-size:17px;font-weight:600}
.user-area{display:flex;align-items:center;gap:12px;font-size:13px}
.badge{background:#0176d3;color:#fff;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600}
.btn{padding:8px 16px;background:#0176d3;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600}
.btn:hover{background:#015ba8}
.btn.sec{background:#e0e0e0;color:#333}
.btn.sm{padding:5px 10px;font-size:11px}
.content{flex:1;overflow-y:auto;padding:24px;background:#f3f3f3}
.card{background:#fff;border:1px solid #e0e0e0;border-radius:6px;padding:20px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.card h3{font-size:15px;font-weight:600;margin-bottom:12px}
.grid{display:grid;gap:16px}.grid-2{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:1fr 1fr 1fr}.grid-4{grid-template-columns:1fr 1fr 1fr 1fr}.grid-6{grid-template-columns:repeat(6,1fr)}
.kpi-card{background:#fff;border:1px solid #e0e0e0;border-radius:6px;padding:16px;text-align:center;cursor:pointer;transition:box-shadow .2s,border-color .2s}
.kpi-card:hover{box-shadow:0 2px 8px rgba(0,0,0,.1);border-color:#0176d3}
.kpi-card .kv{font-size:28px;font-weight:700;color:#0176d3}
.kpi-card .kl{font-size:11px;color:#888;margin-top:4px}
.kpi-card .ks{font-size:11px;color:#2ecc71;margin-top:2px}
table{width:100%;border-collapse:collapse}
thead{background:#f5f5f5;border-bottom:2px solid #e0e0e0}
th{padding:10px 12px;text-align:left;font-weight:600;font-size:11px;color:#555;text-transform:uppercase}
td{padding:10px 12px;border-bottom:1px solid #eee;font-size:13px}
tbody tr:hover{background:#f9f9f9;cursor:pointer}
.sb{display:inline-block;padding:3px 8px;border-radius:10px;font-size:11px;font-weight:600}
.sg{background:#e8f5e9;color:#2e7d32}.sbl{background:#e3f2fd;color:#1565c0}.so{background:#fff3e0;color:#e65100}.sr{background:#ffebee;color:#c62828}.sgy{background:#f5f5f5;color:#666}
.chart-box{background:#fff;border:1px solid #e0e0e0;border-radius:6px;padding:16px}
.chart-box h4{font-size:13px;font-weight:600;margin-bottom:10px;color:#555}
.chart-box canvas{max-height:300px}
.kanban{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;padding:12px 0}
.kanban-col{background:#f5f5f5;border-radius:6px;padding:12px}
.kanban-hdr{font-weight:600;font-size:12px;margin-bottom:10px;padding-bottom:8px;border-bottom:2px solid #0176d3;display:flex;justify-content:space-between}
.kanban-hdr .cnt{background:#0176d3;color:#fff;border-radius:10px;padding:1px 7px;font-size:10px}
.kcard{background:#fff;border:1px solid #e0e0e0;border-radius:4px;padding:10px;margin-bottom:8px;cursor:pointer;font-size:12px}
.kcard:hover{box-shadow:0 2px 8px rgba(0,0,0,.1);transform:translateY(-1px)}
.kcard strong{display:block;margin-bottom:3px}
.kcard small{color:#999}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.detail-field label{font-size:11px;color:#888;font-weight:600;display:block;margin-bottom:4px}
.detail-field .val{background:#f5f5f5;padding:8px 12px;border-radius:4px;font-size:13px;min-height:36px}
.timeline{list-style:none}.timeline li{padding:8px 0 8px 20px;border-left:2px solid #e0e0e0;position:relative;font-size:12px}
.timeline li::before{content:'';position:absolute;left:-5px;top:12px;width:8px;height:8px;background:#0176d3;border-radius:50%}
.perm-table td,.perm-table th{text-align:center;padding:8px}.perm-table td:first-child,.perm-table th:first-child{text-align:left}
.py{color:#2ecc71;font-weight:700;font-size:16px}.pn{color:#e74c3c;font-weight:700;font-size:16px}
.pbar{height:8px;background:#e0e0e0;border-radius:4px;overflow:hidden;margin-top:4px}
.pbar .fill{height:100%;border-radius:4px}
.funnel-row{display:flex;align-items:center;margin:6px 0}
.funnel-bar{height:32px;background:#0176d3;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:11px;font-weight:600;min-width:60px}
.funnel-label{width:120px;font-size:12px;color:#555;flex-shrink:0}
.funnel-val{margin-left:8px;font-size:12px;color:#888;width:100px}
.tab-bar{display:flex;gap:0;border-bottom:1px solid #e0e0e0;margin-bottom:16px;flex-wrap:wrap}
.tab-btn{padding:10px 20px;cursor:pointer;font-size:13px;font-weight:500;border-bottom:3px solid transparent;color:#666}
.tab-btn.active{color:#0176d3;border-bottom-color:#0176d3}
textarea.code{width:100%;height:500px;padding:16px;font-family:Monaco,Menlo,monospace;font-size:12px;border:1px solid #e0e0e0;border-radius:4px;resize:vertical;background:#f8f8f8}
.xml-view{font-family:Monaco,Menlo,monospace;font-size:11px;white-space:pre-wrap;word-break:break-all;background:#f8f8f8;padding:16px;border:1px solid #e0e0e0;border-radius:4px;max-height:600px;overflow:auto;line-height:1.5}
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000}
.modal{background:#fff;border-radius:8px;width:600px;max-width:90vw;max-height:85vh;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,.2)}
.modal-hdr{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid #e0e0e0}
.modal-hdr h3{margin:0;font-size:16px}
.modal-body{padding:20px}
.modal-footer{padding:12px 20px;border-top:1px solid #e0e0e0;display:flex;justify-content:flex-end;gap:8px}
.form-group{margin-bottom:14px}
.form-group label{display:block;font-size:11px;color:#555;font-weight:600;margin-bottom:4px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:8px 10px;border:1px solid #ccc;border-radius:4px;font-size:13px}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#0176d3;box-shadow:0 0 0 2px rgba(1,118,211,.15)}
.btn.danger{background:#e74c3c}.btn.danger:hover{background:#c0392b}
.toast{position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:6px;color:#fff;font-size:13px;font-weight:500;z-index:2000;animation:fadeIn .3s}
.toast.success{background:#2ecc71}.toast.error{background:#e74c3c}
@keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
.inline-edit{background:#fff;border:1px solid #0176d3;padding:6px 10px;border-radius:4px;font-size:13px;width:100%}
@media(max-width:1200px){.grid-4,.grid-6{grid-template-columns:1fr 1fr 1fr}}
/* Calendar */
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:#e0e0e0}
.cal-hdr{background:#1a252f;color:#fff;padding:8px;text-align:center;font-size:11px;font-weight:600}
.cal-day{background:#fff;min-height:80px;padding:4px;font-size:11px;cursor:pointer;transition:background .15s}
.cal-day:hover{background:#f5f7fa}
.cal-day.other{background:#f8f8f8;color:#ccc;cursor:default}
.cal-day.other:hover{background:#f8f8f8}
.cal-day .dn{font-weight:600;margin-bottom:2px}
.cal-evt{background:#e3f2fd;border-left:2px solid #0176d3;padding:2px 4px;margin:1px 0;font-size:10px;border-radius:2px;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cal-evt.good{border-left-color:#2ecc71;background:#e8f5e9}
.cal-evt.hold{border-left-color:#f39c12;background:#fff3e0}
.cal-evt.bad{border-left-color:#e74c3c;background:#ffebee}
/* Flow */
.flow-steps{display:flex;gap:0;align-items:center;margin:20px 0;flex-wrap:wrap}
.flow-step{flex:1;min-width:120px;padding:12px;text-align:center;background:#fff;border:1px solid #e0e0e0;border-radius:6px;position:relative}
.flow-step.active{background:#e3f2fd;border-color:#0176d3}
.flow-step.done{background:#e8f5e9;border-color:#2ecc71}
.flow-arr{font-size:20px;color:#ccc;padding:0 4px}
/* Pipeline columns */
.pipe-wrap{display:flex;gap:8px;overflow-x:auto;padding-bottom:8px}
.pipe-col{min-width:180px;flex:1;background:#f5f5f5;border-radius:6px;padding:8px}
.pipe-col-hdr{font-size:12px;font-weight:700;padding:8px;border-bottom:1px solid #ddd;margin-bottom:8px}
.pipe-card{background:#fff;border:1px solid #e0e0e0;border-radius:4px;padding:8px;margin-bottom:6px;cursor:pointer;font-size:12px}
.pipe-card:hover{box-shadow:0 2px 6px rgba(0,0,0,.1)}
/* Review */
.review-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.review-panel{background:#fff;border:1px solid #e0e0e0;border-radius:6px;padding:16px}
.review-panel h4{margin-bottom:12px;font-size:14px}
/* Barcode */
.bc-item{display:flex;align-items:center;gap:12px;padding:10px;border-bottom:1px solid #eee;font-size:13px}
.bc-code{font-family:Monaco,Menlo,monospace;font-size:14px;font-weight:700;letter-spacing:2px;background:#f5f5f5;padding:4px 8px;border-radius:4px}
/* Quote */
.quote-line{display:grid;grid-template-columns:3fr 1fr 1fr 1fr;gap:8px;padding:8px 0;border-bottom:1px solid #eee;align-items:center}
.quote-line input,.quote-line select{padding:6px;border:1px solid #ccc;border-radius:4px;font-size:12px}
</style>
</head>
<body>
<div class="app">
<div class="sidebar">
<div class="sidebar-hdr"><h2>SB TEMPUS</h2><small>GenMineTOP SFA/CRM</small><div style="margin-top:8px;display:flex;gap:6px"><button onclick="expandAll()" style="flex:1;padding:3px;font-size:10px;background:#2d3e50;color:#8899aa;border:1px solid #3d4e60;border-radius:3px;cursor:pointer">å…¨å±•é–‹</button><button onclick="collapseAll()" style="flex:1;padding:3px;font-size:10px;background:#2d3e50;color:#8899aa;border:1px solid #3d4e60;border-radius:3px;cursor:pointer">å…¨æŠ˜ç•³</button></div></div>

<div class="nav-sec" data-sec="mgmt">
<div class="nav-sec-title" onclick="toggleSec(this)">çµŒå–¶</div>
<div class="nav-items">
<div class="nav-item active" onclick="nav('dashboard')">ğŸ“Š çµŒå–¶ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
<div class="nav-item" onclick="nav('exec-dash')">ğŸ“ˆ ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–DB</div>
<div class="nav-item" onclick="nav('report-kpi')">ğŸ“ˆ KPI</div>
<div class="nav-item" onclick="nav('compliance-dash')">ğŸ›¡ï¸ ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹</div>
</div></div>

<div class="nav-sec" data-sec="sales">
<div class="nav-sec-title" onclick="toggleSec(this)">å–¶æ¥­</div>
<div class="nav-items">
<div class="nav-item" onclick="nav('mr-dash')">ğŸ‘¤ MRãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
<div class="nav-item" onclick="nav('visit-cal')">ğŸ“… è¨ªå•ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
<div class="nav-item" onclick="nav('doc360')">ğŸ‘¨â€âš•ï¸ Doctor 360Â°</div>
<div class="nav-item" onclick="nav('report-sales')">ğŸ’° å–¶æ¥­æˆç¸¾</div>
<div class="nav-item" onclick="nav('report-pipeline')">ğŸ“Š ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³</div>
<div class="nav-item" onclick="nav('quote')">ğŸ§® è¦‹ç©ã‚‚ã‚Šæ”¯æ´</div>
<div class="nav-item" onclick="nav('report-sales-team')">ğŸ‘¥ å–¶æ¥­ãƒãƒ¼ãƒ ãƒ¬ãƒãƒ¼ãƒˆ</div>
<div class="nav-item" onclick="nav('kol-map')">ğŸŒŸ KOLãƒãƒƒãƒ—</div>
<div class="nav-item" onclick="nav('competitive-intel')">ğŸ” ç«¶åˆæƒ…å ±</div>
<div class="nav-item" onclick="nav('territory')">ğŸ—ºï¸ ãƒ†ãƒªãƒˆãƒªãƒ¼åˆ†æ</div>
<div class="nav-item" onclick="nav('visit-target')">ğŸ¯ è¨ªå•ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ</div>
<div class="nav-item" onclick="nav('doctor-assign')">ğŸ”„ ãƒ‰ã‚¯ã‚¿ãƒ¼ã‚¢ã‚µã‚¤ãƒ³</div>
<div class="nav-item" onclick="nav('schedule')">ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</div>
</div></div>

<div class="nav-sec" data-sec="ma">
<div class="nav-sec-title" onclick="toggleSec(this)">MA / å‹‰å¼·ä¼š</div>
<div class="nav-items">
<div class="nav-item" onclick="nav('report-ma')">ğŸ“‹ MAæ´»å‹•ãƒ¬ãƒãƒ¼ãƒˆ</div>
<div class="nav-item" onclick="nav('seminar-dash')">ğŸ“ å‹‰å¼·ä¼šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
<div class="nav-item" onclick="nav('seminar-cal')">ğŸ“… å‹‰å¼·ä¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
<div class="nav-item" onclick="nav('bento')">ğŸ± å¼å½“æ‰‹é…</div>
<div class="nav-item" onclick="nav('seminar-reg')">ğŸ“ å‡ºå¸­è€…ç™»éŒ²</div>
<div class="nav-item" onclick="nav('msl-dash')">ğŸ‘©â€ğŸ”¬ MSLãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
<div class="nav-item" onclick="nav('seminar-attendees')">ğŸ“‹ å‡ºå¸­è€…ç®¡ç†</div>
</div></div>

<div class="nav-sec" data-sec="lab">
<div class="nav-sec-title" onclick="toggleSec(this)">ãƒ©ãƒœ / æ¤œæŸ»</div>
<div class="nav-items">
<div class="nav-item" onclick="nav('lab-dash')">ğŸ§¬ ãƒ©ãƒœãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
<div class="nav-item" onclick="nav('specimen-pipe')">ğŸ”¬ æ¤œä½“ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³</div>
<div class="nav-item" onclick="nav('test-flow')">âš—ï¸ æ¤œæŸ»ãƒ•ãƒ­ãƒ¼</div>
<div class="nav-item" onclick="nav('barcode')">ğŸ“Š ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç®¡ç†</div>
<div class="nav-item" onclick="nav('monthly-report')">ğŸ“ˆ æœˆæ¬¡æ¤œæŸ»ãƒ¬ãƒãƒ¼ãƒˆ</div>
<div class="nav-item" onclick="nav('specimen-review')">ğŸ” æ¤œä½“ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
<div class="nav-item" onclick="nav('specimen-tracker')">ğŸ“¦ æ¤œä½“ãƒˆãƒ©ãƒƒã‚«ãƒ¼</div>
<div class="nav-item" onclick="nav('report-testing')">ğŸ“Š æ¤œæŸ»ãƒ¬ãƒãƒ¼ãƒˆ</div>
</div></div>

<div class="nav-sec" data-sec="workflow">
<div class="nav-sec-title" onclick="toggleSec(this)">ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼</div>
<div class="nav-items">
<div class="nav-item" onclick="nav('workflow')">ğŸ”„ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç®¡ç†</div>
<div class="nav-item" onclick="nav('approval-queue')">âœ… æ‰¿èªã‚­ãƒ¥ãƒ¼</div>
<div class="nav-item" onclick="nav('daily-report')">ğŸ“ æ—¥å ±ç®¡ç†</div>
<div class="nav-item" onclick="nav('expense-report')">ğŸ’° çµŒè²»ç²¾ç®—</div>
</div></div>

<div class="nav-sec collapsed" data-sec="reg">
<div class="nav-sec-title" onclick="toggleSec(this)">è¦åˆ¶ / ä»£ç†åº—</div>
<div class="nav-items">
<div class="nav-item" onclick="nav('pmda-dash')">ğŸ“‹ PMDAãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
<div class="nav-item" onclick="nav('lsi-dash')">ğŸ¢ LSIãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
</div></div>

<div class="nav-sec collapsed" data-sec="map">
<div class="nav-sec-title" onclick="toggleSec(this)">ãƒãƒƒãƒ—</div>
<div class="nav-items">
<div class="nav-item" onclick="nav('facility-map')">ğŸ—ºï¸ æ–½è¨­ãƒãƒƒãƒ—</div>
</div></div>

<div class="nav-sec collapsed" data-sec="data">
<div class="nav-sec-title" onclick="toggleSec(this)">ãƒ‡ãƒ¼ã‚¿</div>
<div class="nav-items">
<div class="nav-item" onclick="nav('obj','Medical_Institution__c')">ğŸ¥ åŒ»ç™‚æ©Ÿé–¢</div>
<div class="nav-item" onclick="nav('obj','Doctor__c')">ğŸ‘¨â€âš•ï¸ ãƒ‰ã‚¯ã‚¿ãƒ¼</div>
<div class="nav-item" onclick="nav('obj','Pharma_Opportunity__c')">ğŸ’¼ è£½è–¬å•†è«‡</div>
<div class="nav-item" onclick="nav('obj','Visit_Record__c')">ğŸ“ è¨ªå•è¨˜éŒ²</div>
<div class="nav-item" onclick="nav('obj','Genomic_Project__c')">ğŸ§¬ ã‚²ãƒãƒ æ¡ˆä»¶</div>
<div class="nav-item" onclick="nav('obj','Specimen__c')">ğŸ§ª æ¤œä½“</div>
<div class="nav-item" onclick="nav('obj','Lab__c')">âš—ï¸ ãƒ©ãƒœ</div>
<div class="nav-item" onclick="nav('obj','MA_Activity__c')">ğŸ¤ MAæ´»å‹•</div>
<div class="nav-item" onclick="nav('obj','Seminar__c')">ğŸ“š å‹‰å¼·ä¼š</div>
<div class="nav-item" onclick="nav('obj','Joint_Research__c')">ğŸ”¬ å…±åŒç ”ç©¶</div>
<div class="nav-item" onclick="nav('obj','Bento_Order__c')">ğŸ± å¼å½“æ³¨æ–‡</div>
<div class="nav-item" onclick="nav('obj','Seminar_Attendee__c')">ğŸ“‹ å‹‰å¼·ä¼šå‡ºå¸­è€…</div>
<div class="nav-item" onclick="nav('obj','Testing_Order__c')">ğŸ§¬ æ¤œæŸ»ã‚ªãƒ¼ãƒ€ãƒ¼</div>
<div class="nav-item" onclick="nav('obj','Daily_Report__c')">ğŸ“ æ—¥å ±</div>
<div class="nav-item" onclick="nav('obj','Approval_Request__c')">âœ… æ‰¿èªç”³è«‹</div>
<div class="nav-item" onclick="nav('obj','Expense_Report__c')">ğŸ’° çµŒè²»ç²¾ç®—</div>
<div class="nav-item" onclick="nav('obj','Competitive_Intel__c')">ğŸ” ç«¶åˆæƒ…å ±</div>
<div class="nav-item" onclick="nav('obj','Visit_Target__c')">ğŸ¯ è¨ªå•ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ</div>
<div class="nav-item" onclick="nav('obj','Workflow_Instance__c')">ğŸ”„ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼</div>
<div class="nav-item" onclick="nav('obj','Account')">ğŸ¢ å–å¼•å…ˆ</div>
<div class="nav-item" onclick="nav('obj','Contact')">ğŸ‘¤ å–å¼•å…ˆè²¬ä»»è€…</div>
<div class="nav-item" onclick="nav('obj','Lead')">ğŸ¯ ãƒªãƒ¼ãƒ‰</div>
<div class="nav-item" onclick="nav('obj','Opportunity')">ğŸ’° å•†è«‡</div>
<div class="nav-item" onclick="nav('obj','Campaign')">ğŸ“£ ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</div>
<div class="nav-item" onclick="nav('obj','Case')">ğŸ“‹ ã‚±ãƒ¼ã‚¹</div>
<div class="nav-item" onclick="nav('obj','Task')">âœ… ToDo</div>
<div class="nav-item" onclick="nav('obj','Event')">ğŸ“… è¡Œå‹•</div>
<div class="nav-item" onclick="nav('obj','Product2')">ğŸ“¦ å•†å“</div>
<div class="nav-item" onclick="nav('obj','Quote')">ğŸ“„ è¦‹ç©</div>
<div class="nav-item" onclick="nav('obj','Contract')">ğŸ“ å¥‘ç´„</div>
<div class="nav-item" onclick="nav('obj','Order')">ğŸ›’ æ³¨æ–‡</div>
<div class="nav-item" onclick="nav('obj','User')">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶</div>
</div></div>

<div class="nav-sec collapsed" data-sec="admin">
<div class="nav-sec-title" onclick="toggleSec(this)">ç®¡ç†</div>
<div class="nav-items">
<div class="nav-item" onclick="nav('admin-users')">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</div>
<div class="nav-item" onclick="nav('soql')">ğŸ’» SOQL</div>
<div class="nav-item" onclick="nav('editor')">ğŸ“ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç·¨é›†</div>
<div class="nav-item" onclick="nav('metadata')">ğŸ“¦ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
<div class="nav-item" onclick="nav('access')">ğŸ”’ ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™</div>
</div></div>

</div>
<div class="main">
<div id="impersonateBanner" style="display:none;background:#e65100;color:#fff;padding:8px 24px;font-size:13px;font-weight:600;display:none;align-items:center;justify-content:space-between">
<span id="impersonateMsg"></span>
<button onclick="stopImpersonate()" style="background:#fff;color:#e65100;border:none;padding:4px 14px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600">å…ƒã«æˆ»ã‚‹</button>
</div>
<div class="topbar">
<h1 id="pageTitle">çµŒå–¶ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
<div class="user-area">
<span id="userName">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
<span class="badge" id="userBadge">Sales_Rep</span>
<button class="btn sm sec" onclick="location.href='/auth/logout'">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
</div>
</div>
<div class="content" id="C"></div>
</div>
</div>
<script>
const CL=['#0176d3','#2ecc71','#f39c12','#e74c3c','#9b59b6','#1abc9c','#e67e22','#3498db','#16a085','#c0392b'];
const sc=s=>({å°å…¥å®Œäº†:'sg',æˆç´„:'sg',å®Œäº†:'sg',è§£æå®Œäº†:'sg',ãƒ¬ãƒãƒ¼ãƒˆç™ºè¡Œæ¸ˆ:'sg',é–‹å‚¬æ¸ˆ:'sg',å®Ÿæ–½æ¸ˆ:'sg',æ‰¿èªæ¸ˆ:'sg',QCåˆæ ¼:'sg',é€šå¸¸ç¨¼åƒ:'sg',é…é”æ¸ˆ:'sg',å‡ºå¸­:'sg',å°å…¥ä¸­:'sbl',è§£æä¸­:'sbl',æº–å‚™ä¸­:'sbl',å¥‘ç´„äº¤æ¸‰:'sbl',è¬›å¸«ç¢ºå®š:'sbl',QCä¸­:'sbl',è§£æå®Ÿæ–½ä¸­:'sbl',ãƒ‡ãƒ¼ã‚¿æº–å‚™:'sbl',è«–æ–‡åŸ·ç­†:'sbl',ç™ºæ³¨æ¸ˆ:'sbl',å‡ºå¸­ç¢ºèª:'sbl',ç™»éŒ²æ¸ˆ:'so',æ¤œä½“å¾…ã¡:'so',ä¼ç”»ä¸­:'so',ãƒªãƒ¼ãƒ‰:'so',ä¼ç”»ç«‹æ¡ˆ:'so',å—é ˜å¾…ã¡:'so',ç«‹ã¡ä¸Šã’ä¸­:'so',é«˜è² è·:'so',å€«ç†å¯©æŸ»:'so',ç™ºæ³¨å‰:'so',å¤±æ³¨:'sr',ä¸æ¡ç”¨:'sr',QCä¸åˆæ ¼:'sr',ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸­:'sr',å´ä¸‹:'sr',ã‚­ãƒ£ãƒ³ã‚»ãƒ«:'sr',æ¬ å¸­:'sr','Closed Won':'sg','Closed':'sg','æœ‰åŠ¹':'sg','å—è«¾':'sg','Prospecting':'so','Qualification':'sbl','Needs Analysis':'sbl','Value Proposition':'sbl','Negotiation/Review':'sbl','Closed Lost':'sr','ä¸é©æ ¼':'sr','æ‹’å¦':'sr','ä¸­æ­¢':'sr','æ–°è¦':'so','é€£çµ¡æ¸ˆ':'sbl','é©æ ¼':'sg','è»¢æ›æ¸ˆ':'sg','è¨ˆç”»ä¸­':'so','é€²è¡Œä¸­':'sbl','å¯¾å¿œä¸­':'sbl','ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³':'sr','é«˜':'sr','ä¸­':'so','ä½':'sgy','ãƒ‰ãƒ©ãƒ•ãƒˆ':'sgy','æ‰¿èªãƒ—ãƒ­ã‚»ã‚¹ä¸­':'sbl','æ‰¿èªå¾…ã¡':'so','æœªç€æ‰‹':'so','å¾…æ©Ÿä¸­':'sgy','å»¶æœŸ':'sr','Available':'sg','Pre Market':'so','Under Agreement':'sbl','Contracted':'sbl','æå‡ºæ¸ˆ':'sbl','å·®æˆ»ã—':'sr','ä¸‹æ›¸ã':'sgy','ç”³è«‹ä¸­':'so','æ”¯æ‰•æ¸ˆ':'sg','å–ä¸‹ã’':'sgy','é”æˆ':'sg','æœªé”':'sr','USæ‰¿èª':'sg','USå¯©æŸ»ä¸­':'sbl','USå·®æˆ»ã—':'sr','æœªé€ä¿¡':'sgy','ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­':'so','ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ':'sbl','æ¤œæŸ»ä¸­':'sbl','æ¤œä½“å¾…ã¡':'so','å—ä»˜':'so','ç·Šæ€¥':'sr','Aï¼ˆæœ€å„ªå…ˆï¼‰':'sr','Bï¼ˆé‡è¦ï¼‰':'so','Cï¼ˆé€šå¸¸ï¼‰':'sbl','Dï¼ˆä½ï¼‰':'sgy','é€šå¸¸':'sgy'})[s]||'sgy';
const USERS=[
{id:'U001',name:'ç”°ä¸­å¤ªéƒ',role:'å–¶æ¥­ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼',team:'Sales',photo:'ğŸ§‘â€ğŸ’¼'},
{id:'U002',name:'ä½è—¤èŠ±å­',role:'MR',team:'Sales',photo:'ğŸ‘©â€ğŸ’¼'},
{id:'U003',name:'éˆ´æœ¨ä¸€éƒ',role:'MR',team:'Sales',photo:'ğŸ‘¨â€ğŸ’¼'},
{id:'U004',name:'é«˜æ©‹ç¾å’²',role:'MSL',team:'MA',photo:'ğŸ‘©â€ğŸ”¬'},
{id:'U005',name:'æ¸¡è¾ºå¥å¤ª',role:'MSL',team:'MA',photo:'ğŸ‘¨â€ğŸ”¬'},
{id:'U006',name:'ä¼Šè—¤ç›´æ¨¹',role:'ãƒ©ãƒœãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼',team:'Lab',photo:'ğŸ§‘â€ğŸ”¬'},
{id:'U009',name:'è—¤ç”°å„ªå­',role:'éºä¼å­æ¤œæŸ»ã‚¹ã‚¿ãƒƒãƒ•',team:'Lab',photo:'ğŸ‘©â€ğŸ”¬'},
{id:'U010',name:'å²¡ç”°çœŸä¸€',role:'éºä¼å­æ¤œæŸ»ã‚¹ã‚¿ãƒƒãƒ•',team:'Lab',photo:'ğŸ‘¨â€ğŸ”¬'},
{id:'U011',name:'æ²¹è°·ä¸äºŒå¤«',role:'ç ”ç©¶ä¸»ä»»ï¼ˆæ±å¤§ï¼‰',team:'Research',photo:'ğŸ‘¨â€ğŸ«'},
{id:'U012',name:'å‰ç”°ç ”ç©¶å“¡',role:'ç ”ç©¶å“¡ï¼ˆæ±å¤§ï¼‰',team:'Research',photo:'ğŸ§‘â€ğŸ”¬'},
{id:'U007',name:'å±±æœ¬æµç†',role:'äº‹æ¥­éƒ¨é•·',team:'Executive',photo:'ğŸ‘©â€ğŸ’»'},
{id:'U008',name:'ä¸­æ‘å¤§è¼”',role:'ä»£è¡¨å–ç· å½¹',team:'Executive',photo:'ğŸ¤µ'},
{id:'U013',name:'Tempus US Reviewer',role:'External Reviewer',team:'External',photo:'ğŸŒ'}
];
const MONTHLY_TESTING_DATA=[
{month:'2025-04',orders:45,completed:42,avgTAT:13.2},
{month:'2025-05',orders:52,completed:48,avgTAT:12.8},
{month:'2025-06',orders:58,completed:55,avgTAT:12.1},
{month:'2025-07',orders:63,completed:60,avgTAT:11.5},
{month:'2025-08',orders:55,completed:52,avgTAT:11.8},
{month:'2025-09',orders:70,completed:67,avgTAT:11.2},
{month:'2025-10',orders:78,completed:74,avgTAT:10.8},
{month:'2025-11',orders:82,completed:79,avgTAT:10.5},
{month:'2025-12',orders:75,completed:71,avgTAT:10.9},
{month:'2026-01',orders:88,completed:84,avgTAT:10.2},
{month:'2026-02',orders:65,completed:45,avgTAT:9.8}
];
const WORKFLOW_TEMPLATES={
'å¼•ãç¶™ã':{name:'æ‹…å½“å¼•ãç¶™ããƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼',icon:'ğŸ”„',color:'#1565c0',steps:['å¼•ãç¶™ãç”³è«‹','ä¸Šé•·æ‰¿èª','å¼•ãç¶™ãå†…å®¹æ•´ç†','å¾Œä»»è€…ã¸ã®èª¬æ˜ä¼š','ãƒ‡ãƒ¼ã‚¿ç§»è¡Œå®Ÿè¡Œ','å®Œäº†ç¢ºèªãƒ»å ±å‘Š'],sla:30},
'æ¤œæŸ»ã‚ªãƒ¼ãƒ€ãƒ¼':{name:'éºä¼å­ãƒ‘ãƒãƒ«æ¤œæŸ»ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼',icon:'ğŸ§¬',color:'#2e7d32',steps:['æ¤œä½“å—ä»˜ãƒ»å“è³ªç¢ºèª','DNAæŠ½å‡ºãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª¿è£½','ã‚·ãƒ¼ã‚±ãƒ³ã‚·ãƒ³ã‚°ãƒ»è§£æ','æ±å¤§ãƒãƒ¼ãƒ ãƒ¬ãƒ“ãƒ¥ãƒ¼','US Tempusãƒ¬ãƒ“ãƒ¥ãƒ¼','ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ','ãƒ¬ãƒãƒ¼ãƒˆé€ä»˜ãƒ»å®Œäº†'],sla:21},
'çµŒè²»æ‰¿èª':{name:'çµŒè²»æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼',icon:'ğŸ’´',color:'#e65100',steps:['çµŒè²»ç”³è«‹','ä¸Šé•·æ‰¿èª','çµŒç†æ‰¿èª','æ”¯æ‰•ã„å‡¦ç†'],sla:7},
'å‹‰å¼·ä¼šé–‹å‚¬':{name:'å‹‰å¼·ä¼šé–‹å‚¬ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼',icon:'ğŸ“š',color:'#6a1b9a',steps:['ä¼ç”»æ›¸ä½œæˆ','è¬›å¸«ä¾é ¼ãƒ»èª¿æ•´','ä¼šå ´æ‰‹é…','æ¡ˆå†…çŠ¶é€ä»˜ãƒ»é›†å®¢','å¼å½“ãƒ»å‚™å“æ‰‹é…','è³‡æ–™æº–å‚™ãƒ»æœ€çµ‚ç¢ºèª','å‹‰å¼·ä¼šé–‹å‚¬','ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ãƒ»å ±å‘Š'],sla:60},
'å•†è«‡æ‰¿èª':{name:'å•†è«‡æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼',icon:'ğŸ’¼',color:'#c62828',steps:['ææ¡ˆæ›¸ä½œæˆ','ä¸Šé•·æ‰¿èª','äº‹æ¥­éƒ¨é•·æ‰¿èª','è¦‹ç©æ›¸ç™ºè¡Œ','å¥‘ç´„ç· çµãƒ»å®Œäº†'],sla:30},
'PMDAç”³è«‹':{name:'PMDAç”³è«‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼',icon:'ğŸ›ï¸',color:'#00695c',steps:['ç”³è«‹æ›¸é¡æº–å‚™','ç¤¾å†…å“è³ªãƒ¬ãƒ“ãƒ¥ãƒ¼','PMDAç”³è«‹æå‡º','PMDAå¯©æŸ»å¯¾å¿œ','å°‚é–€å”è­°','å¯©æŸ»å ±å‘Šæ›¸ç¢ºèª','æ‰¿èªå–å¾—'],sla:180}
};
const userName=id=>{const u=USERS.find(u=>u.id===id);return u?u.name:id||'-'};
let D={};
let pageState={};// {objectName:{page,pageSize,totalSize,pageCount,q,sortBy,sortDir}}
let lookupNamesCache={};// {id: displayName}
async function loadData(){
  try{
    const names=await fetch('/api/schema').then(r=>r.json());
    window.objectNames=names.objects||[];
  }catch(e){console.error('Failed to load schema:',e)}
}
async function loadPage(obj,page,opts){
  page=page||1;opts=opts||{};
  const ps=pageState[obj]||{pageSize:25,sortBy:'LastModifiedDate',sortDir:'DESC'};
  const params=new URLSearchParams({page:page,pageSize:ps.pageSize||25});
  if(opts.sortBy)params.set('sortBy',opts.sortBy);
  else if(ps.sortBy)params.set('sortBy',ps.sortBy);
  if(opts.sortDir)params.set('sortDir',opts.sortDir);
  else if(ps.sortDir)params.set('sortDir',ps.sortDir);
  if(opts.q)params.set('q',opts.q);
  else if(ps.q)params.set('q',ps.q);
  const resp=await fetch('/api/data/'+obj+'?'+params).then(r=>r.json());
  D[obj]=resp.records||[];
  pageState[obj]={page:resp.page,pageSize:resp.pageSize,totalSize:resp.totalSize,pageCount:resp.pageCount,q:opts.q||ps.q||'',sortBy:opts.sortBy||ps.sortBy||'LastModifiedDate',sortDir:opts.sortDir||ps.sortDir||'DESC'};
  if(resp.lookupNames)Object.assign(lookupNamesCache,resp.lookupNames);
  return resp;
}
const OL={Account:'å–å¼•å…ˆ',Contact:'å–å¼•å…ˆè²¬ä»»è€…',Lead:'ãƒªãƒ¼ãƒ‰',Opportunity:'å•†è«‡',OpportunityLineItem:'å•†è«‡å•†å“',OpportunityContactRole:'å•†è«‡å–å¼•å…ˆè²¬ä»»è€…ã®å½¹å‰²',Campaign:'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³',CampaignMember:'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ¡ãƒ³ãƒãƒ¼',Case:'ã‚±ãƒ¼ã‚¹',Task:'ToDo',Event:'è¡Œå‹•',Product2:'å•†å“',Pricebook2:'ä¾¡æ ¼è¡¨',PricebookEntry:'ä¾¡æ ¼è¡¨ã‚¨ãƒ³ãƒˆãƒª',Quote:'è¦‹ç©',QuoteLineItem:'è¦‹ç©å“ç›®',Contract:'å¥‘ç´„',Order:'æ³¨æ–‡',OrderItem:'æ³¨æ–‡å“ç›®',User:'ãƒ¦ãƒ¼ã‚¶',Note:'ãƒ¡ãƒ¢',ContentDocument:'ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ',Medical_Institution__c:'åŒ»ç™‚æ©Ÿé–¢',Doctor__c:'ãƒ‰ã‚¯ã‚¿ãƒ¼',Genomic_Project__c:'ã‚²ãƒãƒ æ¡ˆä»¶',Pharma_Opportunity__c:'è£½è–¬å•†è«‡',Visit_Record__c:'è¨ªå•è¨˜éŒ²',MA_Activity__c:'MAæ´»å‹•',Seminar__c:'å‹‰å¼·ä¼š',Specimen__c:'æ¤œä½“',Lab__c:'ãƒ©ãƒœ',Joint_Research__c:'å…±åŒç ”ç©¶',Bento_Order__c:'å¼å½“æ³¨æ–‡',Seminar_Attendee__c:'å‹‰å¼·ä¼šå‡ºå¸­è€…',Testing_Order__c:'æ¤œæŸ»ã‚ªãƒ¼ãƒ€ãƒ¼',Daily_Report__c:'æ—¥å ±',Approval_Request__c:'æ‰¿èªç”³è«‹',Expense_Report__c:'çµŒè²»ç²¾ç®—',Competitive_Intel__c:'ç«¶åˆæƒ…å ±',Visit_Target__c:'è¨ªå•ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ',Workflow_Instance__c:'ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼'};
const FL={Name:'åå‰',FirstName:'å',LastName:'å§“',AccountId:'å–å¼•å…ˆ',ContactId:'å–å¼•å…ˆè²¬ä»»è€…',LeadId:'ãƒªãƒ¼ãƒ‰',OpportunityId:'å•†è«‡',CampaignId:'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³',OwnerId:'æ‰€æœ‰è€…',Industry:'æ¥­ç¨®',Type:'ç¨®åˆ¥',Phone:'é›»è©±',Fax:'FAX',Website:'Webã‚µã‚¤ãƒˆ',Email:'ãƒ¡ãƒ¼ãƒ«',MobilePhone:'æºå¸¯',Title:'å½¹è·',Department:'éƒ¨é–€',Description:'èª¬æ˜',Amount:'é‡‘é¡',CloseDate:'å®Œäº†äºˆå®šæ—¥',StageName:'ãƒ•ã‚§ãƒ¼ã‚º',Probability:'ç¢ºåº¦%',NextStep:'æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—',Subject:'ä»¶å',Status:'çŠ¶æ…‹',Priority:'å„ªå…ˆåº¦',Origin:'ç™ºç”Ÿæº',ActivityDate:'æœŸæ—¥',StartDateTime:'é–‹å§‹',EndDateTime:'çµ‚äº†',Location:'å ´æ‰€',ProductCode:'å•†å“ã‚³ãƒ¼ãƒ‰',Family:'å•†å“ãƒ•ã‚¡ãƒŸãƒª',UnitPrice:'å˜ä¾¡',Quantity:'æ•°é‡',TotalPrice:'åˆè¨ˆé‡‘é¡',Discount:'å‰²å¼•%',ExpirationDate:'æœ‰åŠ¹æœŸé™',ContractTerm:'å¥‘ç´„æœŸé–“',EffectiveDate:'æœ‰åŠ¹é–‹å§‹æ—¥',OrderNumber:'æ³¨æ–‡ç•ªå·',IsActive:'æœ‰åŠ¹',IsClosed:'ã‚¯ãƒ­ãƒ¼ã‚ºæ¸ˆ',IsConverted:'è»¢æ›æ¸ˆ',IsHighPriority:'é«˜å„ªå…ˆåº¦',Role:'å½¹å‰²',IsPrimary:'ä¸»æ‹…å½“è€…',Company:'ä¼šç¤¾å',LeadSource:'ãƒªãƒ¼ãƒ‰ã‚½ãƒ¼ã‚¹',ForecastCategory:'ãƒ•ã‚©ãƒ¼ã‚­ãƒ£ã‚¹ãƒˆåˆ†é¡',BillingCity:'è«‹æ±‚å…ˆå¸‚åŒºç”ºæ‘',BillingState:'è«‹æ±‚å…ˆéƒ½é“åºœçœŒ',ShippingCity:'é…é€å…ˆå¸‚åŒºç”ºæ‘',NumberOfEmployees:'å¾“æ¥­å“¡æ•°',AnnualRevenue:'å¹´é–“å£²ä¸Š',StartDate:'é–‹å§‹æ—¥',EndDate:'çµ‚äº†æ—¥',BudgetedCost:'äºˆç®—',ActualCost:'å®Ÿç¸¾ã‚³ã‚¹ãƒˆ',ExpectedRevenue:'æœŸå¾…åç›Š',Subtotal:'å°è¨ˆ',Tax:'ç¨é¡',GrandTotal:'ç·åˆè¨ˆ',Username:'ãƒ¦ãƒ¼ã‚¶å',Alias:'åˆ¥å',IsAllDayEvent:'çµ‚æ—¥',WhoId:'åå‰(Who)',WhatId:'é–¢é€£å…ˆ(What)',Facility_Type__c:'æ–½è¨­ç¨®åˆ¥',Prefecture__c:'éƒ½é“åºœçœŒ',Adapter_Status__c:'å°å…¥çŠ¶æ³',Bed_Count__c:'ç—…åºŠæ•°',Department__c:'è¨ºç™‚ç§‘',Title__c:'å½¹è·',Relationship_Level__c:'é–¢ä¿‚æ§‹ç¯‰åº¦',Is_KOL__c:'KOL',KOL_Score__c:'KOLã‚¹ã‚³ã‚¢',Assigned_MR__c:'æ‹…å½“MR',Visit_Count__c:'è¨ªå•å›æ•°',Referred_Specimen_Count__c:'ç´¹ä»‹æ¤œä½“',Cancer_Type__c:'ãŒã‚“ç¨®',Status__c:'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',Sample_Count__c:'ã‚µãƒ³ãƒ—ãƒ«æ•°',Pharma_Company__c:'è£½è–¬ä¼æ¥­',Phase__c:'ãƒ•ã‚§ãƒ¼ã‚º',Amount__c:'é‡‘é¡(ä¸‡å††)',Service_Type__c:'ã‚µãƒ¼ãƒ“ã‚¹',Owner_Name__c:'æ‹…å½“å–¶æ¥­',Probability__c:'ç¢ºåº¦%',Doctor__c:'ãƒ‰ã‚¯ã‚¿ãƒ¼',Visit_Date__c:'è¨ªå•æ—¥',Meeting_Result__c:'é¢è«‡çµæœ',Visit_Purpose__c:'ç›®çš„',Next_Action__c:'æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³',Activity_Type__c:'æ´»å‹•ç¨®åˆ¥',Activity_Date__c:'å®Ÿæ–½æ—¥',Budget__c:'äºˆç®—(ä¸‡å††)',Participant_Count__c:'å‚åŠ è€…',Assigned_MSL__c:'æ‹…å½“MSL',Compliance_Check__c:'ã‚³ãƒ³ãƒ—ãƒ©',Event_Format__c:'å½¢å¼',Progress_Status__c:'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',Event_Date__c:'é–‹å‚¬æ—¥',Attendee_Count__c:'å‚åŠ äººæ•°',Speaker_Fee__c:'è¬›å¸«è¬é‡‘',Operation_Cost__c:'é‹å–¶è²»',Specimen_Status__c:'æ¤œä½“çŠ¶æ…‹',Analysis_Panel__c:'è§£æãƒ‘ãƒãƒ«',Received_Date__c:'å—é ˜æ—¥',Is_Retest__c:'å†æ¤œæŸ»',Location__c:'æ‰€åœ¨åœ°',Lab_Type__c:'ãƒ©ãƒœç¨®åˆ¥',Operation_Status__c:'ç¨¼åƒçŠ¶æ³',Monthly_Capacity__c:'æœˆé–“å®¹é‡',Current_Processing__c:'å‡¦ç†æ•°',Principal_Investigator__c:'ç ”ç©¶è²¬ä»»è€…',Medical_Institution__c:'åŒ»ç™‚æ©Ÿé–¢',Phone__c:'é›»è©±',Mobile_Phone__c:'æºå¸¯',Email__c:'ãƒ¡ãƒ¼ãƒ«',Latitude__c:'ç·¯åº¦',Longitude__c:'çµŒåº¦',Description__c:'èª¬æ˜',Order_Date__c:'æ³¨æ–‡æ—¥',Delivery_Time__c:'é…é”æ™‚é–“',Menu_Type__c:'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç¨®é¡',Vendor__c:'æ¥­è€…',Notes__c:'å‚™è€ƒ',Affiliation__c:'æ‰€å±',Registration_Date__c:'ç™»éŒ²æ—¥',Attendance_Status__c:'å‡ºæ¬ çŠ¶æ³',Venue__c:'ä¼šå ´',Venue_Address__c:'ä¼šå ´ä½æ‰€',Venue_Latitude__c:'ä¼šå ´ç·¯åº¦',Venue_Longitude__c:'ä¼šå ´çµŒåº¦',Specialty__c:'å°‚é–€åˆ†é‡',Seminar__c:'å‹‰å¼·ä¼š',Quantity__c:'æ•°é‡',Panel__c:'ãƒ‘ãƒãƒ«',Reviewer__c:'ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼',US_Review_Status__c:'USå¯©æŸ»çŠ¶æ…‹',Report_Date__c:'ãƒ¬ãƒãƒ¼ãƒˆæ—¥',TAT_Days__c:'TATæ—¥æ•°',Report_Type__c:'å ±å‘Šç¨®åˆ¥',Visit_Summary__c:'è¨ªå•ä»¶æ•°',Key_Activities__c:'ä¸»ãªæ´»å‹•',Key_Findings__c:'ä¸»ãªæ°—ã¥ã',Issues__c:'èª²é¡Œãƒ»å•é¡Œ',Tomorrow_Plan__c:'ç¿Œæ—¥äºˆå®š',Approval_Status__c:'æ‰¿èªçŠ¶æ…‹',Approved_By__c:'æ‰¿èªè€…',Approval_Date__c:'æ‰¿èªæ—¥',Approval_Comment__c:'æ‰¿èªã‚³ãƒ¡ãƒ³ãƒˆ',Request_Type__c:'ç”³è«‹ç¨®åˆ¥',Related_Object__c:'é–¢é€£ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ',Related_Record_Id__c:'é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰ID',Submitted_Date__c:'ç”³è«‹æ—¥',Approved_Date__c:'æ‰¿èªæ—¥',Approver_Comment__c:'æ‰¿èªè€…ã‚³ãƒ¡ãƒ³ãƒˆ',Approver__c:'æ‰¿èªè€…',Expense_Type__c:'çµŒè²»ç¨®åˆ¥',Related_Visit__c:'é–¢é€£è¨ªå•',Related_Seminar__c:'é–¢é€£å‹‰å¼·ä¼š',Receipt_Attached__c:'é ˜åæ›¸æ·»ä»˜',Competitor__c:'ç«¶åˆä¼æ¥­/è£½å“',Intel_Type__c:'æƒ…å ±ç¨®åˆ¥',Source__c:'æƒ…å ±æº',Date__c:'æ—¥ä»˜',Summary__c:'æ¦‚è¦',Impact__c:'å½±éŸ¿åº¦',Action_Required__c:'å¿…è¦ã‚¢ã‚¯ã‚·ãƒ§ãƒ³',Target_Month__c:'å¯¾è±¡æœˆ',Target_Visits__c:'ç›®æ¨™è¨ªå•æ•°',Actual_Visits__c:'å®Ÿç¸¾è¨ªå•æ•°',Achievement_Rate__c:'é”æˆç‡',Last_Visit_Date__c:'æœ€çµ‚è¨ªå•æ—¥',Next_Visit_Date__c:'æ¬¡å›è¨ªå•äºˆå®š',Workflow_Type__c:'ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç¨®åˆ¥',Current_Step__c:'ç¾åœ¨ã‚¹ãƒ†ãƒƒãƒ—',Total_Steps__c:'ç·ã‚¹ãƒ†ãƒƒãƒ—æ•°',Requested_By__c:'ç”³è«‹è€…',Current_Assignee__c:'ç¾åœ¨ã®æ‹…å½“è€…',Start_Date__c:'é–‹å§‹æ—¥',Due_Date__c:'æœŸé™æ—¥',Completed_Date__c:'å®Œäº†æ—¥',Related_Record__c:'é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰',Institution__c:'åŒ»ç™‚æ©Ÿé–¢',Note__c:'å‚™è€ƒ'};
const fl=f=>FL[f]||f;
const OK={Account:['Name','Industry','Type','Phone','BillingState'],Contact:['LastName','FirstName','AccountId','Email','Phone'],Lead:['LastName','Company','Status','Email','Phone'],Opportunity:['Name','AccountId','StageName','Amount','CloseDate'],OpportunityLineItem:['Product2Id','Quantity','UnitPrice','TotalPrice'],OpportunityContactRole:['ContactId','Role','IsPrimary'],Campaign:['Name','Type','Status','StartDate','BudgetedCost'],CampaignMember:['CampaignId','ContactId','Status'],Case:['Subject','Status','Priority','AccountId','ContactId'],Task:['Subject','Status','Priority','ActivityDate','OwnerId'],Event:['Subject','StartDateTime','EndDateTime','Location'],Product2:['Name','ProductCode','Family','IsActive'],Pricebook2:['Name','IsActive','IsStandard'],PricebookEntry:['Product2Id','UnitPrice','IsActive'],Quote:['Name','OpportunityId','Status','ExpirationDate','GrandTotal'],QuoteLineItem:['Product2Id','Quantity','UnitPrice','TotalPrice'],Contract:['AccountId','Status','StartDate','EndDate'],Order:['AccountId','Status','EffectiveDate','TotalAmount'],OrderItem:['Product2Id','Quantity','UnitPrice'],User:['Username','LastName','FirstName','Email','IsActive'],Note:['Title','ParentId'],ContentDocument:['Title','FileType','ContentSize'],Medical_Institution__c:['Name','Facility_Type__c','Prefecture__c','Adapter_Status__c','Bed_Count__c'],Doctor__c:['Name','Medical_Institution__c','Department__c','Title__c','Relationship_Level__c','Assigned_MR__c','Is_KOL__c'],Pharma_Opportunity__c:['Name','Pharma_Company__c','Phase__c','Amount__c','Owner_Name__c'],Visit_Record__c:['Name','Doctor__c','Visit_Date__c','Meeting_Result__c','Visit_Purpose__c'],MA_Activity__c:['Name','Activity_Type__c','Status__c','Assigned_MSL__c','Budget__c'],Seminar__c:['Name','Event_Format__c','Progress_Status__c','Event_Date__c','Venue__c'],Specimen__c:['Name','Cancer_Type__c','Specimen_Status__c','Analysis_Panel__c','Received_Date__c'],Lab__c:['Name','Location__c','Operation_Status__c','Monthly_Capacity__c','Current_Processing__c'],Genomic_Project__c:['Name','Cancer_Type__c','Status__c','Sample_Count__c'],Joint_Research__c:['Name','Pharma_Company__c','Status__c','Budget__c'],Bento_Order__c:['Name','Seminar__c','Order_Date__c','Menu_Type__c','Quantity__c','Amount__c','Status__c'],Seminar_Attendee__c:['Name','Seminar__c','Affiliation__c','Email__c','Attendance_Status__c','Registration_Date__c'],Testing_Order__c:['Name','Specimen__c','Doctor__c','Institution__c','Status__c','TAT_Days__c'],Daily_Report__c:['Name','Report_Date__c','Report_Type__c','Visit_Summary__c','Approval_Status__c','OwnerId'],Approval_Request__c:['Name','Request_Type__c','Amount__c','Status__c','Priority__c','Submitted_Date__c'],Expense_Report__c:['Name','Report_Date__c','Expense_Type__c','Amount__c','Status__c','OwnerId'],Competitive_Intel__c:['Name','Competitor__c','Intel_Type__c','Impact__c','Date__c'],Visit_Target__c:['Name','Doctor__c','Target_Visits__c','Actual_Visits__c','Achievement_Rate__c','Status__c'],Workflow_Instance__c:['Name','Workflow_Type__c','Status__c','Priority__c','Current_Step__c','Due_Date__c']};
const KF={Doctor__c:'Relationship_Level__c',Pharma_Opportunity__c:'Phase__c',Specimen__c:'Specimen_Status__c',MA_Activity__c:'Status__c',Genomic_Project__c:'Status__c',Opportunity:'StageName',Lead:'Status',Case:'Status',Task:'Status',Campaign:'Status',Quote:'Status',Contract:'Status',Order:'Status',Bento_Order__c:'Status__c',Seminar_Attendee__c:'Attendance_Status__c',Testing_Order__c:'Status__c',Daily_Report__c:'Approval_Status__c',Approval_Request__c:'Status__c',Expense_Report__c:'Status__c',Competitive_Intel__c:'Impact__c',Visit_Target__c:'Status__c',Workflow_Instance__c:'Status__c'};
const fmt=n=>{if(n>=10000)return'Â¥'+(n/10000).toFixed(1)+'å„„';return'Â¥'+n.toLocaleString()+'ä¸‡'};
const pct=(a,b)=>b>0?Math.round(a/b*100):0;
const dn=id=>{
  if(!id)return'-';
  if(lookupNamesCache[id])return lookupNamesCache[id];
  for(const obj of Object.keys(D)){
    const rec=(D[obj]||[]).find(r=>r.Id===id);
    if(rec){const n=rec.Name||rec.LastName||rec.Subject||rec.Title||id;lookupNamesCache[id]=n;return n}
  }
  return id;
};
const mi=id=>{
  if(!id)return'-';
  const rec=(D.Medical_Institution__c||[]).find(r=>r.Id===id);
  return rec?rec.Name:id;
};
let charts={};
function dc(id){if(charts[id]){charts[id].destroy();delete charts[id]}}
function mc(id,cfg,clickTarget){dc(id);const ctx=document.getElementById(id);if(!ctx)return;if(clickTarget){if(!cfg.options)cfg.options={};cfg.options.onClick=function(e,els){if(clickTarget.startsWith('obj:'))nav('obj',clickTarget.slice(4));else nav(clickTarget)};ctx.style.cursor='pointer'}charts[id]=new Chart(ctx,cfg)}
let cv='dashboard',co=null,cr=null;
// ã‚»ã‚¯ã‚·ãƒ§ãƒ³æŠ˜ã‚ŠãŸãŸã¿
function toggleSec(el){el.parentElement.classList.toggle('collapsed');saveSecState()}
function saveSecState(){const s={};document.querySelectorAll('.nav-sec[data-sec]').forEach(n=>s[n.dataset.sec]=n.classList.contains('collapsed'));try{localStorage.setItem('sfa-nav-sec',JSON.stringify(s))}catch(e){}}
function loadSecState(){try{const s=JSON.parse(localStorage.getItem('sfa-nav-sec'));if(s)Object.entries(s).forEach(([k,v])=>{const el=document.querySelector(`.nav-sec[data-sec="${k}"]`);if(el){if(v)el.classList.add('collapsed');else el.classList.remove('collapsed')}})}catch(e){}}
function expandAll(){document.querySelectorAll('.nav-sec').forEach(n=>n.classList.remove('collapsed'));saveSecState()}
function collapseAll(){document.querySelectorAll('.nav-sec').forEach(n=>n.classList.add('collapsed'));saveSecState()}
loadSecState();
async function nav(v,o,skipPush){cv=v;co=o||null;cr=null;document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));if(event&&event.target){event.target.classList.add('active');const sec=event.target.closest('.nav-sec');if(sec&&sec.classList.contains('collapsed')){sec.classList.remove('collapsed');saveSecState()}}
if(v==='obj'&&o){await loadPage(o,1,{q:''})}
if(!skipPush)history.pushState({cv:v,co:o||null,crId:null},'');
R()}
function R(){
  const c=document.getElementById('C'),t=document.getElementById('pageTitle');
  const rv={
    'dashboard':['çµŒå–¶ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',rDash,iDash],
    'mr-dash':['MRãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',rMRDash,bMRDash],
    'visit-cal':['è¨ªå•ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼',rVisitCal,iVisitCal],
    'doc360':['Doctor 360Â°',rDoc360,iDoc360],
    'report-sales':['å–¶æ¥­æˆç¸¾ãƒ¬ãƒãƒ¼ãƒˆ',rSales,iSales],
    'report-pipeline':['ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³åˆ†æ',rPipe,iPipe],
    'report-kpi':['KPIãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',rKPI],
    'report-ma':['MAæ´»å‹•ãƒ¬ãƒãƒ¼ãƒˆ',rMA,iMA],
    'seminar-dash':['å‹‰å¼·ä¼šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',rSemDash,iSemDash],
    'seminar-cal':['å‹‰å¼·ä¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼',rSemCal,iSemCal],
    'bento':['å¼å½“æ‰‹é…',rBento],
    'seminar-reg':['å‡ºå¸­è€…ç™»éŒ²',rSemReg],
    'lab-dash':['ãƒ©ãƒœãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',rLabDash,iLabDash],
    'specimen-pipe':['æ¤œä½“ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³',rSpecPipe],
    'test-flow':['æ¤œæŸ»ãƒ•ãƒ­ãƒ¼ (Illumina)',rTestFlow],
    'barcode':['ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç®¡ç†',rBarcode],
    'monthly-report':['æœˆæ¬¡æ¤œæŸ»ãƒ¬ãƒãƒ¼ãƒˆ',rMonthly,iMonthly],
    'specimen-review':['æ¤œä½“ãƒ¬ãƒ“ãƒ¥ãƒ¼',rSpecReview],
    'pmda-dash':['PMDAãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',rPMDA,iPMDA],
    'lsi-dash':['LSIãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',rLSI,iLSI],
    'facility-map':['æ–½è¨­ãƒãƒƒãƒ—',rFacMap,iFacMap],
    'quote':['è¦‹ç©ã‚‚ã‚Šæ”¯æ´',rQuote],
    'obj':[OL[co]||co,()=>rObj(co)],
    'detail':['ãƒ¬ã‚³ãƒ¼ãƒ‰è©³ç´°',rDet,bindDetEvents],
    'access':['ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™',rAccess],
    'admin-users':['ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†',rAdminUsers,bAdminUsers],
    'editor':['ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç·¨é›†',rEditor],
    'soql':['SOQLã‚³ãƒ³ã‚½ãƒ¼ãƒ«',rSOQL],
    'metadata':['ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†',rMetadata],
    'exec-dash':['ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',rExecDash,iExecDash],
    'msl-dash':['MSLãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',rMSLDash,bMSLDash],
    'compliance-dash':['ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',rCompDash],
    'daily-report':['æ—¥å ±ç®¡ç†',rDailyRep],
    'report-testing':['æ¤œæŸ»ãƒ¬ãƒãƒ¼ãƒˆ',rTestRep,iTestRep],
    'report-sales-team':['å–¶æ¥­ãƒãƒ¼ãƒ ãƒ¬ãƒãƒ¼ãƒˆ',rSalesTeam],
    'approval-queue':['æ‰¿èªã‚­ãƒ¥ãƒ¼',rApproval],
    'workflow':['ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç®¡ç†',rWorkflow],
    'workflow-detail':['ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è©³ç´°',rWfDetail],
    'workflow-new':['ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ–°è¦ä½œæˆ',rWfNew,bWfNew],
    'kol-map':['KOLãƒãƒƒãƒ—',rKOLMap],
    'competitive-intel':['ç«¶åˆæƒ…å ±',rCompIntel],
    'territory':['ãƒ†ãƒªãƒˆãƒªãƒ¼åˆ†æ',rTerritory],
    'visit-target':['è¨ªå•ã‚¿ãƒ¼ã‚²ãƒƒãƒˆç®¡ç†',rVisitTarget],
    'doctor-assign':['ãƒ‰ã‚¯ã‚¿ãƒ¼ã‚¢ã‚µã‚¤ãƒ³',rDocAssign],
    'specimen-tracker':['æ¤œä½“ãƒˆãƒ©ãƒƒã‚«ãƒ¼',rSpecTracker],
    'expense-report':['çµŒè²»ç²¾ç®—',rExpense],
    'schedule':['ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«',rSchedule,bSchedule],
    'seminar-attendees':['å‹‰å¼·ä¼šå‡ºå¸­è€…ç®¡ç†',rSemAttendees]
  };
  const r=rv[cv];if(!r)return;
  t.textContent=r[0];
  // For dashboard views that need D[] data, load it on demand
  const dashViews=['dashboard','mr-dash','report-sales','report-pipeline','report-kpi','report-ma','seminar-dash','lab-dash','specimen-pipe','exec-dash','msl-dash','facility-map','kol-map','competitive-intel','territory','doctor-assign','specimen-tracker','bento','seminar-reg','seminar-attendees','daily-report','report-testing','approval-queue','expense-report','schedule','visit-target','compliance-dash','report-sales-team','specimen-review','barcode','monthly-report','test-flow','quote','workflow'];
  if(dashViews.includes(cv)&&!window._dashLoaded){
    const viewAtLoad=cv;
    c.innerHTML='<div style="text-align:center;padding:40px;color:#999">èª­ã¿è¾¼ã¿ä¸­...</div>';
    loadDashData().then(()=>{window._dashLoaded=true;if(cv===viewAtLoad){c.innerHTML=typeof r[1]==='function'?r[1]():'';if(r[2])r[2]()}else{R()}});
  }else{
    c.innerHTML=typeof r[1]==='function'?r[1]():'';
    if(r[2])r[2]();
  }
  if(cv==='obj'){var nb=document.getElementById('btnNew');if(nb)nb.addEventListener('click',function(){openNew(this.dataset.obj)})}
}
async function loadDashData(){
  // Load all data for dashboard views (backward compat â€” no pagination)
  try{
    const names=window.objectNames||[];
    const results=await Promise.all(names.map(n=>fetch('/api/data/'+n).then(r=>r.json()).catch(()=>({records:[]}))));
    names.forEach((n,i)=>{D[n]=results[i].records||[]});
  }catch(e){console.error('Failed to load dashboard data:',e)}
}

// ===== çµŒå–¶ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ =====
function rDash(){
const docs=D.Doctor__c||[],specs=D.Specimen__c||[],opps=D.Pharma_Opportunity__c||[],vis=D.Visit_Record__c||[];
const instAdopted=(D.Medical_Institution__c||[]).filter(i=>i.Adapter_Status__c==='å°å…¥å®Œäº†').length;
const kols=docs.filter(d=>d.Is_KOL__c).length;
const pipe=opps.filter(o=>!['æˆç´„','å¤±æ³¨'].includes(o.Phase__c)).reduce((s,o)=>s+(o.Amount__c||0),0);
const specActive=specs.filter(s=>['è§£æä¸­','QCä¸­','QCåˆæ ¼','å—é ˜æ¸ˆ'].includes(s.Specimen_Status__c)).length;
const nowM=new Date().toISOString().slice(0,7);
const thisMonthVis=vis.filter(v=>(v.Visit_Date__c||'').startsWith(nowM)).length;
const monthlySpec=specs.length;
return`<div class="grid grid-6" style="margin-bottom:20px">
<div class="kpi-card" onclick="nav('obj','Specimen__c')"><div class="kv">${monthlySpec}</div><div class="kl">æœˆé–“æ¤œæŸ»ä»¶æ•°</div></div>
<div class="kpi-card" onclick="nav('obj','Medical_Institution__c')"><div class="kv">${instAdopted}</div><div class="kl">GenMineTOPåˆ©ç”¨æ–½è¨­</div></div>
<div class="kpi-card" onclick="nav('obj','Doctor__c')"><div class="kv">${kols}</div><div class="kl">KOLæ•°</div><div class="ks">KOLç‡${pct(kols,docs.length)}%</div></div>
<div class="kpi-card" onclick="nav('obj','Pharma_Opportunity__c')"><div class="kv">${fmt(pipe)}</div><div class="kl">ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³é‡‘é¡</div></div>
<div class="kpi-card" onclick="nav('specimen-pipe')"><div class="kv">${specActive}</div><div class="kl">é€²è¡Œä¸­æ¤œä½“</div></div>
<div class="kpi-card" onclick="nav('obj','Visit_Record__c')"><div class="kv">${thisMonthVis}</div><div class="kl">ä»Šæœˆè¨ªå•</div></div>
</div><div class="grid grid-2">
<div class="chart-box"><h4>æœˆæ¬¡æ¤œæŸ»ä»¶æ•°æ¨ç§»</h4><canvas id="cd0"></canvas></div>
<div class="chart-box"><h4>å•†è«‡ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³</h4><canvas id="cd1"></canvas></div>
<div class="chart-box"><h4>æ¤œä½“å‡¦ç†çŠ¶æ³</h4><canvas id="cd3"></canvas></div>
<div class="chart-box"><h4>æœˆæ¬¡è¨ªå•æ¨ç§»</h4><canvas id="cd4"></canvas></div></div>`}
function iDash(){
const specs=D.Specimen__c||[],vis=D.Visit_Record__c||[],opps=D.Pharma_Opportunity__c||[];
const ms=['08æœˆ','09æœˆ','10æœˆ','11æœˆ','12æœˆ'];const mp=['2025-08','2025-09','2025-10','2025-11','2025-12'];
mc('cd0',{type:'line',data:{labels:ms,datasets:[{label:'æ¤œæŸ»ä»¶æ•°',data:mp.map(m=>specs.filter(s=>(s.Received_Date__c||'').startsWith(m)).length),borderColor:'#0176d3',backgroundColor:'rgba(1,118,211,.1)',fill:true,tension:.3}]},options:{responsive:true,plugins:{legend:{display:false}}}},'obj:Specimen__c');
const ph=['ãƒªãƒ¼ãƒ‰','ãƒ’ã‚¢ãƒªãƒ³ã‚°','ææ¡ˆ','ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯©æŸ»','å¥‘ç´„äº¤æ¸‰','æˆç´„','å¤±æ³¨'];
mc('cd1',{type:'bar',data:{labels:ph,datasets:[{data:ph.map(p=>opps.filter(o=>o.Phase__c===p).length),backgroundColor:CL}]},options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false}}}},'obj:Pharma_Opportunity__c');
const ss=['å—é ˜å¾…ã¡','å—é ˜æ¸ˆ','QCä¸­','QCåˆæ ¼','QCä¸åˆæ ¼','è§£æä¸­','è§£æå®Œäº†','ãƒ¬ãƒãƒ¼ãƒˆç™ºè¡Œæ¸ˆ'];
mc('cd3',{type:'bar',data:{labels:ss,datasets:[{data:ss.map(s=>specs.filter(x=>x.Specimen_Status__c===s).length),backgroundColor:CL}]},options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false}}}},'specimen-pipe');
mc('cd4',{type:'line',data:{labels:ms,datasets:[{label:'è¨ªå•æ•°',data:mp.map(m=>vis.filter(v=>(v.Visit_Date__c||'').startsWith(m)).length),borderColor:'#2ecc71',backgroundColor:'rgba(46,204,113,.1)',fill:true,tension:.3}]},options:{responsive:true,plugins:{legend:{display:false}}}},'obj:Visit_Record__c')}

// ===== MRãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ =====
function rMRDash(){
const mrs=[...new Set((D.Doctor__c||[]).map(d=>d.Assigned_MR__c).filter(Boolean))];
let h='<div class="tab-bar" id="mrTabs">';
mrs.forEach((m,i)=>h+=`<div class="tab-btn${i===0?' active':''}" onclick="showMR('${m}',this)">${m}</div>`);
h+='</div><div id="mrContent"></div>';
return h}
function bMRDash(){
const mrs=[...new Set((D.Doctor__c||[]).map(d=>d.Assigned_MR__c).filter(Boolean))];
if(mrs.length)showMR(mrs[0])}
function showMR(mr,tab){
if(tab){document.querySelectorAll('#mrTabs .tab-btn').forEach(t=>t.classList.remove('active'));tab.classList.add('active')}
const docs=(D.Doctor__c||[]).filter(d=>d.Assigned_MR__c===mr);
const docIds=docs.map(d=>d.Id);
const opps=(D.Pharma_Opportunity__c||[]).filter(o=>o.Owner_Name__c===mr);
const visits=(D.Visit_Record__c||[]).filter(v=>docIds.includes(v.Doctor__c));
const kols=docs.filter(d=>d.Is_KOL__c);
const pipe=opps.filter(o=>!['æˆç´„','å¤±æ³¨'].includes(o.Phase__c)).reduce((s,o)=>s+(o.Amount__c||0),0);
const won=opps.filter(o=>o.Phase__c==='æˆç´„').reduce((s,o)=>s+(o.Amount__c||0),0);
const closed=opps.filter(o=>['æˆç´„','å¤±æ³¨'].includes(o.Phase__c));
const wr=closed.length?pct(opps.filter(o=>o.Phase__c==='æˆç´„').length,closed.length):0;
const totalSpec=docs.reduce((s,d)=>s+(d.Referred_Specimen_Count__c||0),0);
let h=`<div class="grid grid-6" style="margin-bottom:20px">
<div class="kpi-card" onclick="nav('obj','Pharma_Opportunity__c')"><div class="kv">${fmt(pipe)}</div><div class="kl">ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³</div><div class="ks">${opps.filter(o=>!['æˆç´„','å¤±æ³¨'].includes(o.Phase__c)).length}ä»¶</div></div>
<div class="kpi-card" onclick="nav('obj','Pharma_Opportunity__c')"><div class="kv">${fmt(won)}</div><div class="kl">æˆç´„æ¸ˆ</div><div class="ks">æˆç´„ç‡ ${wr}%</div></div>
<div class="kpi-card" onclick="nav('obj','Doctor__c')"><div class="kv">${docs.length}</div><div class="kl">æ‹…å½“ãƒ‰ã‚¯ã‚¿ãƒ¼</div><div class="ks">KOL ${kols.length}å</div></div>
<div class="kpi-card" onclick="nav('obj','Visit_Record__c')"><div class="kv">${visits.length}</div><div class="kl">è¨ªå•ä»¶æ•°</div><div class="ks">å¥½æ„Ÿè§¦ ${visits.filter(v=>v.Meeting_Result__c==='å¥½æ„Ÿè§¦').length}ä»¶</div></div>
<div class="kpi-card" onclick="nav('obj','Specimen__c')"><div class="kv">${totalSpec}</div><div class="kl">ç´¹ä»‹æ¤œä½“æ•°</div></div>
<div class="kpi-card" onclick="nav('obj','Pharma_Opportunity__c')"><div class="kv">${opps.length}</div><div class="kl">å•†è«‡æ•°</div><div class="ks">é€²è¡Œä¸­ ${opps.filter(o=>!['æˆç´„','å¤±æ³¨'].includes(o.Phase__c)).length}ä»¶</div></div>
</div>`;
h+=`<div class="grid grid-2">
<div class="chart-box"><h4>å•†è«‡ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼ˆãƒ•ã‚§ãƒ¼ã‚ºåˆ¥ï¼‰</h4><canvas id="mrc1"></canvas></div>
<div class="chart-box"><h4>ãƒ‰ã‚¯ã‚¿ãƒ¼é–¢ä¿‚æ§‹ç¯‰åº¦</h4><canvas id="mrc2"></canvas></div>
<div class="chart-box"><h4>è¨ªå•çµæœå†…è¨³</h4><canvas id="mrc3"></canvas></div>
<div class="chart-box"><h4>æœˆåˆ¥è¨ªå•ä»¶æ•°æ¨ç§»</h4><canvas id="mrc4"></canvas></div>
</div>`;
const acts=[
...visits.map(v=>({d:v.Visit_Date__c,t:`${dn(v.Doctor__c)} ã‚’è¨ªå• (${v.Visit_Purpose__c})`,s:v.Meeting_Result__c,i:'ğŸ“'}))
].sort((a,b)=>(b.d||'').localeCompare(a.d||'')).slice(0,8);
h+=`<div class="card"><h3>æ´»å‹•ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h3>`;
if(acts.length){h+=`<ul style="list-style:none;padding:0">`;acts.forEach(a=>h+=`<li style="padding:8px 16px;border-bottom:1px solid #eee;font-size:13px"><span style="color:#888;margin-right:8px">${a.i} ${a.d||'-'}</span>${a.t} <span class="sb ${sc(a.s)}" style="margin-left:4px">${a.s||''}</span></li>`);h+=`</ul>`}
else h+=`<p style="padding:16px;color:#888">æ´»å‹•å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>`;
h+=`</div>`;
h+=`<div class="card"><h3>æ‹…å½“å•†è«‡ (${opps.length}ä»¶)</h3><table><thead><tr><th>å•†è«‡å</th><th>ä¼æ¥­</th><th>ãƒ•ã‚§ãƒ¼ã‚º</th><th>é‡‘é¡</th><th>ç¢ºåº¦</th></tr></thead><tbody>`;
opps.forEach(o=>h+=`<tr onclick="sd('Pharma_Opportunity__c','${o.Id}')"><td>${o.Name}</td><td>${o.Pharma_Company__c}</td><td><span class="sb ${sc(o.Phase__c)}">${o.Phase__c}</span></td><td>Â¥${(o.Amount__c||0).toLocaleString()}ä¸‡</td><td>${o.Probability__c||0}%</td></tr>`);
h+=`</tbody></table></div>`;
h+=`<div class="card"><h3>æ‹…å½“ãƒ‰ã‚¯ã‚¿ãƒ¼ (${docs.length}å)</h3><table><thead><tr><th>æ°å</th><th>åŒ»ç™‚æ©Ÿé–¢</th><th>è¨ºç™‚ç§‘</th><th>å½¹è·</th><th>é–¢ä¿‚æ§‹ç¯‰åº¦</th><th>è¨ªå•å›æ•°</th><th>KOLã‚¹ã‚³ã‚¢</th><th>ç´¹ä»‹æ¤œä½“</th></tr></thead><tbody>`;
docs.forEach(d=>h+=`<tr onclick="sd('Doctor__c','${d.Id}')"><td>${d.Name}</td><td>${mi(d.Medical_Institution__c)}</td><td>${d.Department__c||'-'}</td><td>${d.Title__c||'-'}</td><td><span class="sb ${sc(d.Relationship_Level__c)}">${d.Relationship_Level__c}</span></td><td>${d.Visit_Count__c||0}</td><td>${d.KOL_Score__c||0}</td><td>${d.Referred_Specimen_Count__c||0}</td></tr>`);
h+=`</tbody></table></div>`;
h+=`<div class="card"><h3>è¨ªå•è¨˜éŒ² (${visits.length}ä»¶)</h3><table><thead><tr><th>è¨ªå•ç•ªå·</th><th>ãƒ‰ã‚¯ã‚¿ãƒ¼</th><th>è¨ªå•æ—¥</th><th>ç›®çš„</th><th>çµæœ</th><th>æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th></tr></thead><tbody>`;
visits.sort((a,b)=>(b.Visit_Date__c||'').localeCompare(a.Visit_Date__c||'')).forEach(v=>h+=`<tr onclick="sd('Visit_Record__c','${v.Id}')"><td>${v.Name}</td><td>${dn(v.Doctor__c)}</td><td>${v.Visit_Date__c}</td><td>${v.Visit_Purpose__c||'-'}</td><td><span class="sb ${sc(v.Meeting_Result__c)}">${v.Meeting_Result__c||'-'}</span></td><td>${v.Next_Action__c||'-'}</td></tr>`);
h+=`</tbody></table></div>`;
document.getElementById('mrContent').innerHTML=h;
setTimeout(()=>iMRCharts(mr),100)}
function iMRCharts(mr){
const docs=(D.Doctor__c||[]).filter(d=>d.Assigned_MR__c===mr);
const docIds=docs.map(d=>d.Id);
const opps=(D.Pharma_Opportunity__c||[]).filter(o=>o.Owner_Name__c===mr);
const visits=(D.Visit_Record__c||[]).filter(v=>docIds.includes(v.Doctor__c));
const ph=['ãƒªãƒ¼ãƒ‰','ãƒ’ã‚¢ãƒªãƒ³ã‚°','ææ¡ˆ','ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯©æŸ»','å¥‘ç´„äº¤æ¸‰','æˆç´„','å¤±æ³¨'];
mc('mrc1',{type:'bar',data:{labels:ph,datasets:[{label:'ä¸‡å††',data:ph.map(p=>opps.filter(o=>o.Phase__c===p).reduce((s,o)=>s+(o.Amount__c||0),0)),backgroundColor:CL}]},options:{responsive:true,plugins:{legend:{display:false}}}},'obj:Pharma_Opportunity__c');
const lv=['æœªæ¥è§¦','åˆå›é¢è«‡æ¸ˆ','é–¢å¿ƒã‚ã‚Š','æ¤œè¨ä¸­','æ¨é€²è€…','ãƒ•ã‚¡ãƒ³ï¼ˆKOLï¼‰'];
mc('mrc2',{type:'doughnut',data:{labels:lv,datasets:[{data:lv.map(l=>docs.filter(d=>d.Relationship_Level__c===l).length),backgroundColor:CL}]},options:{responsive:true,plugins:{legend:{position:'right'}}}},'obj:Doctor__c');
const rs=['å¥½æ„Ÿè§¦','ç¶™ç¶šæ¤œè¨','ä¿ç•™','å†è¨ªå•è¦'];
mc('mrc3',{type:'pie',data:{labels:rs,datasets:[{data:rs.map(r=>visits.filter(v=>v.Meeting_Result__c===r).length),backgroundColor:['#2ecc71','#3498db','#f39c12','#e74c3c']}]},options:{responsive:true,plugins:{legend:{position:'right'}}}},'obj:Visit_Record__c');
const ms=['08æœˆ','09æœˆ','10æœˆ','11æœˆ','12æœˆ'];const mk=['2025-08','2025-09','2025-10','2025-11','2025-12'];
mc('mrc4',{type:'line',data:{labels:ms,datasets:[{label:'è¨ªå•æ•°',data:mk.map(m=>visits.filter(v=>v.Visit_Date__c&&v.Visit_Date__c.startsWith(m)).length),borderColor:'#0176d3',backgroundColor:'rgba(1,118,211,.1)',fill:true,tension:.3}]},options:{responsive:true,plugins:{legend:{display:false}}}},'obj:Visit_Record__c')}

// ===== å–¶æ¥­æˆç¸¾ãƒ¬ãƒãƒ¼ãƒˆ =====
function rSales(){const o=D.Pharma_Opportunity__c||[],won=o.filter(x=>x.Phase__c==='æˆç´„'),lost=o.filter(x=>x.Phase__c==='å¤±æ³¨'),pipe=o.filter(x=>!['æˆç´„','å¤±æ³¨'].includes(x.Phase__c));
const tp=pipe.reduce((s,x)=>s+(x.Amount__c||0),0),wa=won.reduce((s,x)=>s+(x.Amount__c||0),0),wp=pipe.reduce((s,x)=>s+(x.Amount__c||0)*(x.Probability__c||0)/100,0);
return`<div class="grid grid-4" style="margin-bottom:20px">
<div class="kpi-card" onclick="nav('obj','Pharma_Opportunity__c')"><div class="kv">${fmt(tp)}</div><div class="kl">ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³</div></div>
<div class="kpi-card" onclick="nav('obj','Pharma_Opportunity__c')"><div class="kv">${fmt(wa)}</div><div class="kl">æˆç´„é‡‘é¡</div></div>
<div class="kpi-card" onclick="nav('obj','Pharma_Opportunity__c')"><div class="kv">${fmt(Math.round(wp))}</div><div class="kl">åŠ é‡ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³</div></div>
<div class="kpi-card" onclick="nav('obj','Pharma_Opportunity__c')"><div class="kv">${pct(won.length,won.length+lost.length)}%</div><div class="kl">æˆç´„ç‡</div><div class="ks">${won.length}å‹/${lost.length}æ•—</div></div></div>
<div class="grid grid-2">
<div class="chart-box"><h4>æ‹…å½“è€…åˆ¥å•†è«‡é‡‘é¡</h4><canvas id="cs1"></canvas></div>
<div class="chart-box"><h4>ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥é‡‘é¡</h4><canvas id="cs2"></canvas></div>
<div class="chart-box"><h4>å•†è«‡ãƒ•ã‚§ãƒ¼ã‚ºåˆ†å¸ƒ</h4><canvas id="cs3"></canvas></div>
<div class="chart-box"><h4>ã‚µãƒ¼ãƒ“ã‚¹ç¨®åˆ¥</h4><canvas id="cs4"></canvas></div></div>
<div class="card" style="margin-top:16px"><h3>å•†è«‡ä¸€è¦§ï¼ˆé‡‘é¡é †ï¼‰</h3><table><thead><tr><th>å•†è«‡å</th><th>ä¼æ¥­</th><th>é‡‘é¡</th><th>ãƒ•ã‚§ãƒ¼ã‚º</th><th>æ‹…å½“</th></tr></thead><tbody>
${o.sort((a,b)=>(b.Amount__c||0)-(a.Amount__c||0)).map(x=>`<tr onclick="sd('Pharma_Opportunity__c','${x.Id}')"><td>${x.Name}</td><td>${x.Pharma_Company__c}</td><td>Â¥${(x.Amount__c||0).toLocaleString()}ä¸‡</td><td><span class="sb ${sc(x.Phase__c)}">${x.Phase__c}</span></td><td>${x.Owner_Name__c}</td></tr>`).join('')}</tbody></table></div>`}
function iSales(){const o=D.Pharma_Opportunity__c||[];
const reps=[...new Set(o.map(x=>x.Owner_Name__c))];
mc('cs1',{type:'bar',data:{labels:reps,datasets:[{label:'ä¸‡å††',data:reps.map(r=>o.filter(x=>x.Owner_Name__c===r).reduce((s,x)=>s+(x.Amount__c||0),0)),backgroundColor:CL}]},options:{responsive:true,plugins:{legend:{display:false}}}},'obj:Pharma_Opportunity__c');
const ph=['ãƒªãƒ¼ãƒ‰','ãƒ’ã‚¢ãƒªãƒ³ã‚°','ææ¡ˆ','ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯©æŸ»','å¥‘ç´„äº¤æ¸‰','æˆç´„','å¤±æ³¨'];
mc('cs2',{type:'bar',data:{labels:ph,datasets:[{label:'ä¸‡å††',data:ph.map(p=>o.filter(x=>x.Phase__c===p).reduce((s,x)=>s+(x.Amount__c||0),0)),backgroundColor:CL}]},options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false}}}},'obj:Pharma_Opportunity__c');
mc('cs3',{type:'doughnut',data:{labels:ph,datasets:[{data:ph.map(p=>o.filter(x=>x.Phase__c===p).length),backgroundColor:CL}]},options:{responsive:true}},'obj:Pharma_Opportunity__c');
const sv=[...new Set(o.map(x=>x.Service_Type__c).filter(Boolean))];
mc('cs4',{type:'pie',data:{labels:sv,datasets:[{data:sv.map(s=>o.filter(x=>x.Service_Type__c===s).length),backgroundColor:CL}]},options:{responsive:true}},'obj:Pharma_Opportunity__c')}

// ===== ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³åˆ†æ =====
function rPipe(){const o=D.Pharma_Opportunity__c||[],ph=['ãƒªãƒ¼ãƒ‰','ãƒ’ã‚¢ãƒªãƒ³ã‚°','ææ¡ˆ','ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯©æŸ»','å¥‘ç´„äº¤æ¸‰','æˆç´„'];
const mx=Math.max(...ph.map(p=>o.filter(x=>x.Phase__c===p).length));
const dl=['æœªæ¥è§¦','åˆå›é¢è«‡æ¸ˆ','é–¢å¿ƒã‚ã‚Š','æ¤œè¨ä¸­','æ¨é€²è€…','ãƒ•ã‚¡ãƒ³ï¼ˆKOLï¼‰'];
const mxd=Math.max(...dl.map(l=>(D.Doctor__c||[]).filter(d=>d.Relationship_Level__c===l).length));
return`<div class="card"><h3>å•†è«‡ãƒ•ã‚¡ãƒãƒ«</h3>${ph.map((p,i)=>{const c=o.filter(x=>x.Phase__c===p);const a=c.reduce((s,x)=>s+(x.Amount__c||0),0);const w=Math.max(pct(c.length,mx),15);return`<div class="funnel-row"><div class="funnel-label">${p}</div><div class="funnel-bar" style="width:${w}%;background:${CL[i]}">${c.length}ä»¶</div><div class="funnel-val">${fmt(a)}</div></div>`}).join('')}</div>
<div class="card"><h3>ãƒ‰ã‚¯ã‚¿ãƒ¼é–¢ä¿‚æ§‹ç¯‰ãƒ•ã‚¡ãƒãƒ«</h3>${dl.map((l,i)=>{const c=(D.Doctor__c||[]).filter(d=>d.Relationship_Level__c===l);const w=Math.max(pct(c.length,mxd),15);return`<div class="funnel-row"><div class="funnel-label">${l}</div><div class="funnel-bar" style="width:${w}%;background:${CL[i]}">${c.length}å</div><div class="funnel-val"></div></div>`}).join('')}</div>
<div class="grid grid-2"><div class="chart-box"><h4>æ¤œä½“ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³</h4><canvas id="cp1"></canvas></div><div class="chart-box"><h4>ã‚²ãƒãƒ æ¡ˆä»¶çŠ¶æ³</h4><canvas id="cp2"></canvas></div></div>`}
function iPipe(){
const ss=['å—é ˜å¾…ã¡','å—é ˜æ¸ˆ','QCä¸­','QCåˆæ ¼','QCä¸åˆæ ¼','è§£æä¸­','è§£æå®Œäº†','ãƒ¬ãƒãƒ¼ãƒˆç™ºè¡Œæ¸ˆ'];
mc('cp1',{type:'bar',data:{labels:ss,datasets:[{data:ss.map(s=>(D.Specimen__c||[]).filter(x=>x.Specimen_Status__c===s).length),backgroundColor:CL}]},options:{responsive:true,plugins:{legend:{display:false}}}},'obj:Specimen__c');
const gs=['æ¤œä½“å¾…ã¡','è§£æä¸­','ãƒ¬ãƒãƒ¼ãƒˆä½œæˆä¸­','ãƒ¬ãƒãƒ¼ãƒˆå®Œäº†','ç´å“æ¸ˆ'];
mc('cp2',{type:'bar',data:{labels:gs,datasets:[{data:gs.map(s=>(D.Genomic_Project__c||[]).filter(x=>x.Status__c===s).length),backgroundColor:CL}]},options:{responsive:true,plugins:{legend:{display:false}}}},'obj:Genomic_Project__c')}

// ===== KPIãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ =====
function rKPI(){const docs=D.Doctor__c||[],kols=docs.filter(d=>d.Is_KOL__c),o=D.Pharma_Opportunity__c||[],won=o.filter(x=>x.Phase__c==='æˆç´„'),lost=o.filter(x=>x.Phase__c==='å¤±æ³¨');
const nowM=new Date().toISOString().slice(0,7);
const vis=(D.Visit_Record__c||[]).filter(v=>(v.Visit_Date__c||'').startsWith(nowM)).length;
const kr=pct(kols.length,docs.length),wr=pct(won.length,won.length+lost.length),tr=85,vr=pct(vis,50);
const bar=(v,tgt,c)=>`<div class="pbar" style="margin-top:8px"><div class="fill" style="width:${Math.min(v,100)}%;background:${c}"></div></div><div style="font-size:10px;color:#999;margin-top:2px">ç›®æ¨™:${tgt}%</div>`;
return`<div class="grid grid-2">
<div class="card"><h3>ãƒ‰ã‚¯ã‚¿ãƒ¼KOLåŒ–ç‡</h3><div style="font-size:36px;font-weight:700;color:#0176d3;text-align:center;margin:16px 0">${kr}%</div>${bar(kr,20,'#0176d3')}<div style="text-align:center;font-size:12px;color:#888;margin-top:4px">${kols.length}å/${docs.length}å</div></div>
<div class="card"><h3>å•†è«‡æˆç´„ç‡</h3><div style="font-size:36px;font-weight:700;color:#2ecc71;text-align:center;margin:16px 0">${wr}%</div>${bar(wr,30,'#2ecc71')}<div style="text-align:center;font-size:12px;color:#888;margin-top:4px">${won.length}ä»¶/${won.length+lost.length}ä»¶</div></div>
<div class="card"><h3>æ¤œä½“TATé”æˆç‡</h3><div style="font-size:36px;font-weight:700;color:#f39c12;text-align:center;margin:16px 0">${tr}%</div>${bar(tr,90,'#f39c12')}</div>
<div class="card"><h3>æœˆé–“è¨ªå•é”æˆç‡</h3><div style="font-size:36px;font-weight:700;color:#9b59b6;text-align:center;margin:16px 0">${vr}%</div>${bar(vr,100,'#9b59b6')}<div style="text-align:center;font-size:12px;color:#888;margin-top:4px">${vis}ä»¶/ç›®æ¨™50ä»¶</div></div></div>`}

// ===== MAæ´»å‹•ãƒ¬ãƒãƒ¼ãƒˆ =====
function rMA(){const ma=D.MA_Activity__c||[],msls=[...new Set(ma.map(m=>m.Assigned_MSL__c).filter(Boolean))];
return`<div class="grid grid-3" style="margin-bottom:20px">
<div class="kpi-card" onclick="nav('obj','MA_Activity__c')"><div class="kv">${ma.length}</div><div class="kl">MAæ´»å‹•ç·æ•°</div></div>
<div class="kpi-card" onclick="nav('obj','MA_Activity__c')"><div class="kv">${ma.filter(m=>m.Status__c==='å®Ÿæ–½æ¸ˆ'||m.Status__c==='å®Œäº†').length}</div><div class="kl">å®Ÿæ–½æ¸ˆãƒ»å®Œäº†</div></div>
<div class="kpi-card" onclick="nav('obj','MA_Activity__c')"><div class="kv">Â¥${ma.reduce((s,m)=>s+(m.Budget__c||0),0).toLocaleString()}ä¸‡</div><div class="kl">äºˆç®—åˆè¨ˆ</div></div></div>
<div class="grid grid-2">
<div class="chart-box"><h4>MSLåˆ¥æ´»å‹•ä»¶æ•°</h4><canvas id="cm1"></canvas></div>
<div class="chart-box"><h4>MSLåˆ¥äºˆç®—æ¶ˆåŒ–</h4><canvas id="cm2"></canvas></div>
<div class="chart-box"><h4>æ´»å‹•ã‚¿ã‚¤ãƒ—åˆ†å¸ƒ</h4><canvas id="cm3"></canvas></div>
<div class="chart-box"><h4>ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹çŠ¶æ³</h4><canvas id="cm4"></canvas></div></div>
<div class="card" style="margin-top:16px"><h3>MSLåˆ¥ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸€è¦§</h3><table><thead><tr><th>MSL</th><th>ä»¶æ•°</th><th>ä¼ç”»ä¸­</th><th>æº–å‚™ä¸­</th><th>å®Ÿæ–½æ¸ˆ</th><th>å®Œäº†</th><th>äºˆç®—è¨ˆ</th></tr></thead><tbody>
${msls.map(m=>{const a=ma.filter(x=>x.Assigned_MSL__c===m);const bs=s=>a.filter(x=>x.Status__c===s).length;const tb=a.reduce((s,x)=>s+(x.Budget__c||0),0);return`<tr><td><strong>${m}</strong></td><td>${a.length}</td><td>${bs('ä¼ç”»ä¸­')}</td><td>${bs('æº–å‚™ä¸­')}</td><td>${bs('å®Ÿæ–½æ¸ˆ')}</td><td>${bs('å®Œäº†')}</td><td>Â¥${tb.toLocaleString()}ä¸‡</td></tr>`}).join('')}</tbody></table></div>
<div class="card"><h3>å…¨MAæ´»å‹•ä¸€è¦§</h3><table><thead><tr><th>æ´»å‹•å</th><th>ç¨®åˆ¥</th><th>MSL</th><th>çŠ¶æ…‹</th><th>æ—¥ä»˜</th><th>äºˆç®—</th></tr></thead><tbody>
${ma.sort((a,b)=>(b.Activity_Date__c||'').localeCompare(a.Activity_Date__c||'')).map(m=>`<tr onclick="sd('MA_Activity__c','${m.Id}')"><td>${m.Name}</td><td>${m.Activity_Type__c}</td><td><strong>${m.Assigned_MSL__c}</strong></td><td><span class="sb ${sc(m.Status__c)}">${m.Status__c}</span></td><td>${m.Activity_Date__c||'-'}</td><td>Â¥${(m.Budget__c||0).toLocaleString()}ä¸‡</td></tr>`).join('')}</tbody></table></div>`}
function iMA(){const ma=D.MA_Activity__c||[],msls=[...new Set(ma.map(m=>m.Assigned_MSL__c).filter(Boolean))];
mc('cm1',{type:'bar',data:{labels:msls,datasets:[{label:'ä»¶æ•°',data:msls.map(m=>ma.filter(a=>a.Assigned_MSL__c===m).length),backgroundColor:CL}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}}},'obj:MA_Activity__c');
mc('cm2',{type:'bar',data:{labels:msls,datasets:[{label:'ä¸‡å††',data:msls.map(m=>ma.filter(a=>a.Assigned_MSL__c===m).reduce((s,a)=>s+(a.Budget__c||0),0)),backgroundColor:CL}]},options:{responsive:true,plugins:{legend:{display:false}}}},'obj:MA_Activity__c');
const types=[...new Set(ma.map(m=>m.Activity_Type__c))];
mc('cm3',{type:'doughnut',data:{labels:types,datasets:[{data:types.map(t=>ma.filter(m=>m.Activity_Type__c===t).length),backgroundColor:CL}]},options:{responsive:true,plugins:{legend:{position:'right',labels:{font:{size:10}}}}}},'obj:MA_Activity__c');
const cs=['æ‰¿èªæ¸ˆ','ç¢ºèªä¸­','æœªç¢ºèª'];
mc('cm4',{type:'bar',data:{labels:cs,datasets:[{data:cs.map(s=>ma.filter(m=>m.Compliance_Check__c===s).length),backgroundColor:['#2ecc71','#f39c12','#e74c3c']}]},options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false}}}},'obj:MA_Activity__c')}

// ========================================================
// SB TEMPUS SFA/CRM - Department Views
// ========================================================

// === 1. Visit Calendar ===
var calMonth=new Date(new Date().getFullYear(),new Date().getMonth(),1);
var calVisits=[];
function renderVisitCalHTML(){var m=calMonth,y=m.getFullYear(),mo=m.getMonth(),ml=['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
var h=`<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><button class="btn sm sec" onclick="navCal(-1)">&larr; å‰æœˆ</button><h3 style="margin:0">${y}å¹´${ml[mo]}</h3><button class="btn sm sec" onclick="navCal(1)">æ¬¡æœˆ &rarr;</button></div>`;
h+=`<div class="cal-grid"><div class="cal-hdr">æ—¥</div><div class="cal-hdr">æœˆ</div><div class="cal-hdr">ç«</div><div class="cal-hdr">æ°´</div><div class="cal-hdr">æœ¨</div><div class="cal-hdr">é‡‘</div><div class="cal-hdr">åœŸ</div>`;
var fd=new Date(y,mo,1).getDay(),ld=new Date(y,mo+1,0).getDate(),vs=calVisits;
var pad=s=>String(s).padStart(2,'0');
for(var i=0;i<fd;i++)h+=`<div class="cal-day other"></div>`;
for(var d=1;d<=ld;d++){var ds=y+'-'+pad(mo+1)+'-'+pad(d);var dv=vs.filter(v=>v.Visit_Date__c===ds);
h+=`<div class="cal-day" onclick="openNew('Visit_Record__c',{Visit_Date__c:'${ds}'})"><div style="font-weight:600;font-size:11px;margin-bottom:2px">${d}</div>`;
dv.forEach(v=>{var cls=v.Meeting_Result__c==='å¥½æ„Ÿè§¦'?'cal-evt good':v.Meeting_Result__c==='ä¿ç•™'?'cal-evt hold':v.Meeting_Result__c==='å†è¨ªå•è¦'?'cal-evt bad':'cal-evt';
h+=`<div class="${cls}" onclick="event.stopPropagation();sd('Visit_Record__c','${v.Id}')" title="${dn(v.Doctor__c)}">${dn(v.Doctor__c).slice(0,4)}</div>`});
h+=`</div>`}
var rem=(fd+ld)%7;if(rem>0)for(var i=0;i<7-rem;i++)h+=`<div class="cal-day other"></div>`;
return h+`</div></div>`}
async function loadCalVisits(){
var m=calMonth,y=m.getFullYear(),mo=m.getMonth();
var pad=s=>String(s).padStart(2,'0');
var from=y+'-'+pad(mo+1)+'-01';
var to=y+'-'+pad(mo+1)+'-'+pad(new Date(y,mo+1,0).getDate());
try{
var reqs=[fetch('/api/data/Visit_Record__c?from='+from+'&to='+to+'&dateField=Visit_Date__c').then(r=>r.json())];
if(!D.Doctor__c||!D.Doctor__c.length)reqs.push(fetch('/api/data/Doctor__c').then(r=>r.json()));
var results=await Promise.all(reqs);
calVisits=results[0].records||[];
if(results[1])D.Doctor__c=results[1].records||[];
}catch(e){
calVisits=(D.Visit_Record__c||[]).filter(v=>{var d=v.Visit_Date__c||'';return d>=from&&d<=to});
}
}
function rVisitCal(){return'<div style="text-align:center;padding:40px;color:#999">èª­ã¿è¾¼ã¿ä¸­...</div>'}
function iVisitCal(){loadCalVisits().then(()=>{document.getElementById('C').innerHTML=renderVisitCalHTML()})}
function navCal(d){calMonth=new Date(calMonth.getFullYear(),calMonth.getMonth()+d,1);document.getElementById('C').innerHTML='<div style="text-align:center;padding:40px;color:#999">èª­ã¿è¾¼ã¿ä¸­...</div>';loadCalVisits().then(()=>{document.getElementById('C').innerHTML=renderVisitCalHTML()})}

// === 2. Doctor 360 View ===
function rDoc360(){var docs=D.Doctor__c||[];
var h=`<div class="card"><h3>ãƒ‰ã‚¯ã‚¿ãƒ¼360Â°ãƒ“ãƒ¥ãƒ¼</h3><select id="doc360sel" onchange="selDoc360()" style="width:100%;padding:8px;font-size:13px;border:1px solid #ccc;border-radius:4px"><option value="">-- ãƒ‰ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠ --</option>`;
docs.forEach(d=>h+=`<option value="${d.Id}">${d.Name} (${d.Department__c||''})</option>`);
h+=`</select></div><div id="doc360body"></div>`;return h}
function iDoc360(){}
function selDoc360(){var id=document.getElementById('doc360sel').value;if(!id){document.getElementById('doc360body').innerHTML='';return}
var d=(D.Doctor__c||[]).find(r=>r.Id===id);if(!d)return;
var vs=(D.Visit_Record__c||[]).filter(v=>v.Doctor__c===id).sort((a,b)=>(b.Visit_Date__c||'').localeCompare(a.Visit_Date__c||''));
var sp=(D.Specimen__c||[]).filter(s=>s.Referring_Doctor__c===id);
var ops=D.Pharma_Opportunity__c||[];
var h=`<div class="card"><div class="grid grid-2"><div><h3 style="margin-bottom:8px">${d.Name}</h3>`;
h+=`<div class="detail-field"><label>å½¹è·</label><div class="val">${d.Title__c||'-'}</div></div>`;
h+=`<div class="detail-field"><label>è¨ºç™‚ç§‘</label><div class="val">${d.Department__c||'-'}</div></div>`;
h+=`<div class="detail-field"><label>æ‰€å±åŒ»ç™‚æ©Ÿé–¢</label><div class="val">${dn(d.Medical_Institution__c)}</div></div>`;
h+=`<div class="detail-field"><label>é–¢ä¿‚æ§‹ç¯‰åº¦</label><div class="val"><span class="sb ${sc(d.Relationship_Level__c)}">${d.Relationship_Level__c}</span></div></div>`;
h+=`</div><div>`;
h+=`<div class="detail-field"><label>KOL</label><div class="val">${d.Is_KOL__c?'KOL':'-'}</div></div>`;
h+=`<div class="detail-field"><label>KOLã‚¹ã‚³ã‚¢</label><div class="val">${d.KOL_Score__c||0}</div></div>`;
h+=`<div class="detail-field"><label>æ‹…å½“MR</label><div class="val">${d.Assigned_MR__c||'-'}</div></div>`;
h+=`<div class="detail-field"><label>è¨ªå•å›æ•°</label><div class="val">${d.Visit_Count__c||0}</div></div>`;
h+=`<div class="detail-field"><label>ç´¹ä»‹æ¤œä½“æ•°</label><div class="val">${d.Referred_Specimen_Count__c||0}</div></div>`;
h+=`</div></div></div>`;
// Visit history
h+=`<div class="card"><h3>è¨ªå•å±¥æ­´ (${vs.length}ä»¶)</h3><table><thead><tr><th>è¨ªå•ç•ªå·</th><th>è¨ªå•æ—¥</th><th>ç›®çš„</th><th>çµæœ</th><th>æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th></tr></thead><tbody>`;
vs.forEach(v=>h+=`<tr onclick="sd('Visit_Record__c','${v.Id}')"><td>${v.Name}</td><td>${v.Visit_Date__c||'-'}</td><td>${v.Visit_Purpose__c||'-'}</td><td><span class="sb ${sc(v.Meeting_Result__c)}">${v.Meeting_Result__c||'-'}</span></td><td>${v.Next_Action__c||'-'}</td></tr>`);
h+=`</tbody></table></div>`;
// Specimens
h+=`<div class="card"><h3>é–¢é€£æ¤œä½“</h3><table><thead><tr><th>æ¤œä½“ID</th><th>ãŒã‚“ç¨®</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>ãƒ‘ãƒãƒ«</th><th>å—é ˜æ—¥</th></tr></thead><tbody>`;
sp.forEach(s=>h+=`<tr onclick="sd('Specimen__c','${s.Id}')"><td>${s.Name}</td><td>${s.Cancer_Type__c}</td><td><span class="sb ${sc(s.Specimen_Status__c)}">${s.Specimen_Status__c}</span></td><td>${s.Analysis_Panel__c||'-'}</td><td>${s.Received_Date__c||'-'}</td></tr>`);
if(!sp.length)h+=`<tr><td colspan="5" style="color:#888">é–¢é€£æ¤œä½“ãªã—</td></tr>`;
h+=`</tbody></table></div>`;
// Pharma opportunities
h+=`<div class="card"><h3>é–¢é€£å•†è«‡</h3><table><thead><tr><th>å•†è«‡å</th><th>ä¼æ¥­</th><th>ãƒ•ã‚§ãƒ¼ã‚º</th><th>é‡‘é¡</th></tr></thead><tbody>`;
ops.slice(0,5).forEach(o=>h+=`<tr onclick="sd('Pharma_Opportunity__c','${o.Id}')"><td>${o.Name}</td><td>${o.Pharma_Company__c}</td><td><span class="sb ${sc(o.Phase__c)}">${o.Phase__c}</span></td><td>Â¥${(o.Amount__c||0).toLocaleString()}ä¸‡</td></tr>`);
h+=`</tbody></table></div>`;
// Visit trend chart
h+=`<div class="chart-box"><h4>è¨ªå•æ¨ç§»</h4><canvas id="doc360ch"></canvas></div>`;
document.getElementById('doc360body').innerHTML=h;
var mk=['2025-07','2025-08','2025-09','2025-10','2025-11','2025-12'],ml=['7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
mc('doc360ch',{type:'line',data:{labels:ml,datasets:[{label:'è¨ªå•æ•°',data:mk.map(m=>vs.filter(v=>v.Visit_Date__c&&v.Visit_Date__c.startsWith(m)).length),borderColor:'#0176d3',backgroundColor:'rgba(1,118,211,.1)',fill:true,tension:.3}]},options:{responsive:true,plugins:{legend:{display:false}}}},'obj:Visit_Record__c')}

// === 3. Lab Dashboard ===
function rLabDash(){var labs=D.Lab__c||[],sp=D.Specimen__c||[];
var tot=sp.length,proc=sp.filter(s=>['QCä¸­','QCåˆæ ¼','è§£æä¸­'].includes(s.Specimen_Status__c)).length;
var active=labs.filter(l=>l.Operation_Status__c==='é€šå¸¸ç¨¼åƒ'||l.Operation_Status__c==='é«˜è² è·').length;
var ur=labs.length?pct(active,labs.length):0;
var h=`<div class="grid grid-4" style="margin-bottom:20px">`;
h+=`<div class="kpi-card" onclick="nav('obj','Specimen__c')"><div class="kv">${tot}</div><div class="kl">ç·æ¤œä½“æ•°</div></div>`;
h+=`<div class="kpi-card" onclick="nav('specimen-pipe')"><div class="kv">${proc}</div><div class="kl">å‡¦ç†ä¸­</div></div>`;
h+=`<div class="kpi-card" onclick="nav('obj','Lab__c')"><div class="kv">${active}/${labs.length}</div><div class="kl">ç¨¼åƒãƒ©ãƒœ/å…¨ãƒ©ãƒœ</div></div>`;
h+=`<div class="kpi-card" onclick="nav('obj','Lab__c')"><div class="kv">${ur}%</div><div class="kl">ç¨¼åƒç‡</div></div></div>`;
h+=`<div class="grid grid-2"><div class="chart-box"><h4>ãƒ©ãƒœåˆ¥å‡¦ç†çŠ¶æ³</h4><canvas id="labch1"></canvas></div>`;
h+=`<div class="chart-box"><h4>æ¤œä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ†å¸ƒ</h4><canvas id="labch2"></canvas></div></div>`;
h+=`<div class="card" style="margin-top:16px"><h3>Illumina Sequencer Management</h3><table><thead><tr><th>ãƒ©ãƒœå</th><th>æ‰€åœ¨åœ°</th><th>ç¨®åˆ¥</th><th>ç¨¼åƒçŠ¶æ…‹</th><th>æœˆé–“å®¹é‡</th><th>å‡¦ç†ä¸­</th><th>ç¨¼åƒç‡%</th></tr></thead><tbody>`;
labs.forEach(l=>{var u=l.Monthly_Capacity__c?pct(l.Current_Processing__c||0,l.Monthly_Capacity__c):0;
h+=`<tr onclick="sd('Lab__c','${l.Id}')"><td>${l.Name}</td><td>${l.Location__c||'-'}</td><td>${l.Lab_Type__c||'-'}</td><td><span class="sb ${sc(l.Operation_Status__c)}">${l.Operation_Status__c}</span></td><td>${l.Monthly_Capacity__c||0}</td><td>${l.Current_Processing__c||0}</td><td>${u}%</td></tr>`});
h+=`</tbody></table></div>`;
var pend=sp.filter(s=>['å—é ˜å¾…ã¡','å—é ˜æ¸ˆ'].includes(s.Specimen_Status__c)).sort((a,b)=>(a.Received_Date__c||'').localeCompare(b.Received_Date__c||''));
h+=`<div class="card"><h3>æ¤œä½“ã‚­ãƒ¥ãƒ¼ï¼ˆå¾…æ©Ÿä¸­ï¼‰</h3><table><thead><tr><th>æ¤œä½“ID</th><th>ãŒã‚“ç¨®</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>å—é ˜æ—¥</th><th>ãƒ‘ãƒãƒ«</th></tr></thead><tbody>`;
pend.forEach(s=>h+=`<tr onclick="sd('Specimen__c','${s.Id}')"><td>${s.Name}</td><td>${s.Cancer_Type__c}</td><td><span class="sb ${sc(s.Specimen_Status__c)}">${s.Specimen_Status__c}</span></td><td>${s.Received_Date__c||'-'}</td><td>${s.Analysis_Panel__c||'-'}</td></tr>`);
h+=`</tbody></table></div>`;return h}
function iLabDash(){var labs=D.Lab__c||[],sp=D.Specimen__c||[];
mc('labch1',{type:'bar',data:{labels:labs.map(l=>l.Name),datasets:[{label:'å‡¦ç†ä¸­',data:labs.map(l=>l.Current_Processing__c||0),backgroundColor:'#0176d3'},{label:'å®¹é‡',data:labs.map(l=>l.Monthly_Capacity__c||0),backgroundColor:'#e0e0e0'}]},options:{responsive:true,plugins:{legend:{position:'top'}}}},'obj:Lab__c');
var ss=['å—é ˜å¾…ã¡','å—é ˜æ¸ˆ','QCä¸­','QCåˆæ ¼','QCä¸åˆæ ¼','è§£æä¸­','è§£æå®Œäº†','ãƒ¬ãƒãƒ¼ãƒˆç™ºè¡Œæ¸ˆ'];
mc('labch2',{type:'doughnut',data:{labels:ss,datasets:[{data:ss.map(s=>sp.filter(x=>x.Specimen_Status__c===s).length),backgroundColor:CL}]},options:{responsive:true,plugins:{legend:{position:'right'}}}},'obj:Specimen__c')}

// === 4. Specimen Pipeline (Kanban) ===
function rSpecPipe(){var sp=D.Specimen__c||[];
var cols=['å—é ˜å¾…ã¡','å—é ˜æ¸ˆ','QCä¸­','QCåˆæ ¼','è§£æä¸­','è§£æå®Œäº†','ãƒ¬ãƒãƒ¼ãƒˆç™ºè¡Œæ¸ˆ','QCä¸åˆæ ¼'];
var h=`<div class="card"><h3>æ¤œä½“ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³</h3></div><div class="pipe-wrap">`;
cols.forEach(c=>{var items=sp.filter(s=>s.Specimen_Status__c===c);
h+=`<div class="pipe-col"><div class="pipe-col-hdr">${c} <span class="cnt" style="background:#0176d3;color:#fff;border-radius:10px;padding:1px 7px;font-size:10px;margin-left:4px">${items.length}</span></div>`;
items.forEach(s=>h+=`<div class="pipe-card" onclick="sd('Specimen__c','${s.Id}')"><strong>${s.Name}</strong><div style="font-size:11px;color:#555;margin-top:2px">${s.Cancer_Type__c}</div><div style="font-size:11px;color:#888">${s.Analysis_Panel__c||'-'}</div><div style="font-size:10px;color:#aaa">${s.Received_Date__c||'-'}</div></div>`);
h+=`</div>`});
return h+`</div>`}

// === 5. Illumina Testing Flow ===
function rTestFlow(){var sp=D.Specimen__c||[];
var steps=[
{n:'æ¤œä½“å—é ˜',st:['å—é ˜å¾…ã¡','å—é ˜æ¸ˆ']},{n:'ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ä»˜ä¸',st:['å—é ˜æ¸ˆ']},{n:'DNA/RNAæŠ½å‡º',st:['QCä¸­']},
{n:'QC',st:['QCä¸­']},{n:'ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª¿è£½',st:['QCåˆæ ¼']},{n:'ã‚·ãƒ¼ã‚±ãƒ³ã‚·ãƒ³ã‚°',st:['è§£æä¸­']},
{n:'ãƒ‡ãƒ¼ã‚¿è§£æ',st:['è§£æä¸­']},{n:'ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ',st:['è§£æå®Œäº†']},{n:'å®Œäº†',st:['ãƒ¬ãƒãƒ¼ãƒˆç™ºè¡Œæ¸ˆ']}];
var h=`<div class="card"><h3>Illuminaæ¤œæŸ»ãƒ•ãƒ­ãƒ¼</h3><div class="flow-steps">`;
steps.forEach((s,i)=>{var cnt=sp.filter(x=>s.st.includes(x.Specimen_Status__c)).length;
var cls=cnt>0?'flow-step active':'flow-step';
h+=`<div class="${cls}"><div style="font-size:20px;font-weight:700;color:#0176d3">${cnt}</div><div style="font-size:11px">${s.n}</div></div>`;
if(i<steps.length-1)h+=`<div class="flow-arr">&rarr;</div>`});
h+=`</div></div>`;
// Table per step
h+=`<div class="card"><h3>ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¥æ¤œä½“ä¸€è¦§</h3>`;
steps.forEach(s=>{var items=sp.filter(x=>s.st.includes(x.Specimen_Status__c));
if(!items.length)return;
h+=`<h4 style="margin:12px 0 6px;font-size:13px;color:#555">${s.n} (${items.length}ä»¶)</h4><table><thead><tr><th>æ¤œä½“ID</th><th>ãŒã‚“ç¨®</th><th>ãƒ‘ãƒãƒ«</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>å—é ˜æ—¥</th></tr></thead><tbody>`;
items.forEach(x=>h+=`<tr onclick="sd('Specimen__c','${x.Id}')"><td>${x.Name}</td><td>${x.Cancer_Type__c}</td><td>${x.Analysis_Panel__c||'-'}</td><td><span class="sb ${sc(x.Specimen_Status__c)}">${x.Specimen_Status__c}</span></td><td>${x.Received_Date__c||'-'}</td></tr>`);
h+=`</tbody></table>`});
return h+`</div>`}

// === 6. Barcode Management ===
function rBarcode(){var sp=D.Specimen__c||[];
var h=`<div class="card"><h3>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç®¡ç†</h3><div style="display:flex;gap:8px;margin-bottom:12px"><input type="text" id="bcSearch" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰/æ¤œä½“åã§æ¤œç´¢..." oninput="filtBC(this.value)" oncompositionstart="imeOn=true" oncompositionend="imeOn=false;filtBC(this.value)" onkeydown="if(!imeOn&&event.key==='Enter'){filtBC(this.value)}" style="flex:1;padding:8px;border:1px solid #ccc;border-radius:4px;font-size:13px"><button class="btn sm" onclick="filtBC(document.getElementById('bcSearch').value)" style="padding:8px 16px">ğŸ” æ¤œç´¢</button></div></div>`;
h+=`<div class="card"><table id="bcTbl"><thead><tr><th>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</th><th>æ¤œä½“å</th><th>ãŒã‚“ç¨®</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>å—é ˜æ—¥</th><th>ãƒ‘ãƒãƒ«</th></tr></thead><tbody>`;
sp.forEach((s,i)=>{var rd=s.Received_Date__c?s.Received_Date__c.replace(/-/g,''):'00000000';
var bc='GMTOP-'+rd+'-'+String(i+1).padStart(4,'0');
h+=`<tr class="bc-item" onclick="sd('Specimen__c','${s.Id}')"><td><span class="bc-code" style="font-family:monospace;font-weight:700;letter-spacing:1px">${bc}</span></td><td>${s.Name}</td><td>${s.Cancer_Type__c}</td><td><span class="sb ${sc(s.Specimen_Status__c)}">${s.Specimen_Status__c}</span></td><td>${s.Received_Date__c||'-'}</td><td>${s.Analysis_Panel__c||'-'}</td></tr>`});
return h+`</tbody></table></div>`}
function filtBC(q){if(imeOn)return;document.querySelectorAll('#bcTbl tbody tr').forEach(r=>{r.style.display=r.textContent.toLowerCase().includes(q.toLowerCase())?'':'none'})}

// === 7. Monthly Test Report ===
function rMonthly(){var sp=D.Specimen__c||[];
var mks=['2025-07','2025-08','2025-09','2025-10','2025-11','2025-12'],mls=['7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
var mc_=mks.map(m=>sp.filter(s=>s.Received_Date__c&&s.Received_Date__c.startsWith(m)).length);
var curM=mc_[mc_.length-1]||0,prevM=mc_[mc_.length-2]||0,ratio=prevM?Math.round(curM/prevM*100):0;
var cumul=sp.length;
var tatDays=sp.filter(s=>s.Received_Date__c&&s.Report_Date__c).map(s=>(new Date(s.Report_Date__c)-new Date(s.Received_Date__c))/(86400000));
var avgTat=tatDays.length?Math.round(tatDays.reduce((a,b)=>a+b,0)/tatDays.length):14;
var h=`<div class="grid grid-4" style="margin-bottom:20px">`;
h+=`<div class="kpi-card" onclick="nav('obj','Specimen__c')"><div class="kv">${curM}</div><div class="kl">ä»Šæœˆæ¤œæŸ»ä»¶æ•°</div></div>`;
h+=`<div class="kpi-card"><div class="kv">${ratio}%</div><div class="kl">å‰æœˆæ¯”</div></div>`;
h+=`<div class="kpi-card" onclick="nav('obj','Specimen__c')"><div class="kv">${cumul}</div><div class="kl">ç´¯è¨ˆä»¶æ•°</div></div>`;
h+=`<div class="kpi-card"><div class="kv">${avgTat}æ—¥</div><div class="kl">å¹³å‡TAT</div></div></div>`;
h+=`<div class="grid grid-2"><div class="chart-box"><h4>æœˆæ¬¡æ¤œæŸ»ä»¶æ•°æ¨ç§»</h4><canvas id="mthch1"></canvas></div>`;
h+=`<div class="chart-box"><h4>ãŒã‚“ç¨®åˆ¥æ¤œæŸ»ä»¶æ•°</h4><canvas id="mthch2"></canvas></div>`;
h+=`<div class="chart-box"><h4>è§£æãƒ‘ãƒãƒ«åˆ¥ä»¶æ•°</h4><canvas id="mthch3"></canvas></div>`;
h+=`<div class="chart-box"><h4>æœˆæ¬¡å‡ºä»¶æ¨ç§»</h4><canvas id="mthch4"></canvas></div></div>`;
return h}
function iMonthly(){var sp=D.Specimen__c||[];
var mks=['2025-07','2025-08','2025-09','2025-10','2025-11','2025-12'],mls=['7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
var mc_=mks.map(m=>sp.filter(s=>s.Received_Date__c&&s.Received_Date__c.startsWith(m)).length);
var tgt=15;
mc('mthch1',{type:'bar',data:{labels:mls,datasets:[{label:'ä»¶æ•°',data:mc_,backgroundColor:'#0176d3'},{label:'ç›®æ¨™',data:mls.map(()=>tgt),type:'line',borderColor:'#e74c3c',borderDash:[5,5],pointRadius:0,fill:false}]},options:{responsive:true,plugins:{legend:{position:'top'}}}},'obj:Specimen__c');
var ct=[...new Set(sp.map(s=>s.Cancer_Type__c))];
mc('mthch2',{type:'doughnut',data:{labels:ct,datasets:[{data:ct.map(c=>sp.filter(s=>s.Cancer_Type__c===c).length),backgroundColor:CL}]},options:{responsive:true,plugins:{legend:{position:'right'}}}},'obj:Specimen__c');
var ap=[...new Set(sp.map(s=>s.Analysis_Panel__c).filter(Boolean))];
mc('mthch3',{type:'bar',data:{labels:ap,datasets:[{label:'ä»¶æ•°',data:ap.map(a=>sp.filter(s=>s.Analysis_Panel__c===a).length),backgroundColor:CL}]},options:{responsive:true,plugins:{legend:{display:false}}}},'obj:Specimen__c');
var done=mks.map(m=>sp.filter(s=>s.Report_Date__c&&s.Report_Date__c.startsWith(m)).length);
mc('mthch4',{type:'line',data:{labels:mls,datasets:[{label:'å‡ºä»¶æ•°',data:done,borderColor:'#2ecc71',backgroundColor:'rgba(46,204,113,.15)',fill:true,tension:.3}]},options:{responsive:true,plugins:{legend:{display:false}}}},'obj:Specimen__c')}

// === 8. Specimen Review ===
function rSpecReview(){var sp=D.Specimen__c||[];
var rev=sp.filter(s=>s.Specimen_Status__c==='è§£æå®Œäº†'||s.Specimen_Status__c==='ãƒ¬ãƒãƒ¼ãƒˆç™ºè¡Œæ¸ˆ');
var left=rev,right=rev;
var h=`<div class="card"><h3>æ¤œä½“ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3></div><div class="review-grid">`;
// Left panel
h+=`<div class="review-panel"><div class="card"><h3>æ±äº¬å¤§å­¦ï¼ˆæ²¹è°·ãƒãƒ¼ãƒ ï¼‰ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3><div style="margin-bottom:8px;font-size:12px;color:#888">ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¸ˆ: ${left.filter((_,i)=>i%2===0).length}ä»¶ / å…¨${left.length}ä»¶</div>`;
h+=`<table><thead><tr><th>æ¤œä½“</th><th>ãŒã‚“ç¨®</th><th>ãƒ‘ãƒãƒ«</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>å—é ˜æ—¥</th><th>ãƒ¬ãƒ“ãƒ¥ãƒ¼</th></tr></thead><tbody>`;
left.forEach((s,i)=>h+=`<tr onclick="sd('Specimen__c','${s.Id}')"><td>${s.Name}</td><td>${s.Cancer_Type__c}</td><td>${s.Analysis_Panel__c||'-'}</td><td><span class="sb ${sc(s.Specimen_Status__c)}">${s.Specimen_Status__c}</span></td><td>${s.Received_Date__c||'-'}</td><td>${i%2===0?'<span style="color:#2ecc71">&#10003; ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¸ˆ</span>':'<span style="color:#f39c12">&#9203; ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡</span>'}</td></tr>`);
h+=`</tbody></table></div></div>`;
// Right panel
h+=`<div class="review-panel"><div class="card"><h3>US TEMPUS ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3><div style="margin-bottom:8px;font-size:12px;color:#888">ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¸ˆ: ${right.filter((_,i)=>i%2===1).length}ä»¶ / å…¨${right.length}ä»¶</div>`;
h+=`<table><thead><tr><th>æ¤œä½“</th><th>ãŒã‚“ç¨®</th><th>ãƒ‘ãƒãƒ«</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>å—é ˜æ—¥</th><th>ãƒ¬ãƒ“ãƒ¥ãƒ¼</th></tr></thead><tbody>`;
right.forEach((s,i)=>h+=`<tr onclick="sd('Specimen__c','${s.Id}')"><td>${s.Name}</td><td>${s.Cancer_Type__c}</td><td>${s.Analysis_Panel__c||'-'}</td><td><span class="sb ${sc(s.Specimen_Status__c)}">${s.Specimen_Status__c}</span></td><td>${s.Received_Date__c||'-'}</td><td>${i%2===1?'<span style="color:#2ecc71">&#10003; ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¸ˆ</span>':'<span style="color:#f39c12">&#9203; ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡</span>'}</td></tr>`);
h+=`</tbody></table></div></div></div>`;
return h}

// === 9. PMDA Dashboard ===
function rPMDA(){var gp=D.Genomic_Project__c||[],sp=D.Specimen__c||[];
var stages=['éè‡¨åºŠè©¦é¨“','æ²»é¨“Phase1','æ²»é¨“Phase2','æ²»é¨“Phase3','æ‰¿èªç”³è«‹','PMDAå¯©æŸ»','æ‰¿èª'];
var approvedIdx=6;
var h=`<div class="card"><h3>PMDAè¦åˆ¶ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ - GenMineTOP</h3><div class="flow-steps">`;
stages.forEach((s,i)=>{var cls=i<approvedIdx?'flow-step done':i===approvedIdx?'flow-step active':'flow-step';
h+=`<div class="${cls}"><div style="font-size:11px">${s}</div>${i===approvedIdx?'<div style="font-size:10px;color:#2ecc71;font-weight:700">æ‰¿èªæ¸ˆ</div>':'<div style="font-size:10px;color:#2ecc71">&#10003;</div>'}</div>`;
if(i<stages.length-1)h+=`<div class="flow-arr">&rarr;</div>`});
h+=`</div></div>`;
var done=sp.filter(s=>s.Specimen_Status__c==='ãƒ¬ãƒãƒ¼ãƒˆç™ºè¡Œæ¸ˆ').length;
h+=`<div class="grid grid-4" style="margin-bottom:20px">`;
h+=`<div class="kpi-card"><div class="kv">1</div><div class="kl">æ‰¿èªæ¸ˆCDx</div><div class="ks">GenMineTOP</div></div>`;
h+=`<div class="kpi-card"><div class="kv">0</div><div class="kl">ç”³è«‹ä¸­</div></div>`;
h+=`<div class="kpi-card"><div class="kv">0</div><div class="kl">å¯©æŸ»ä¸­</div></div>`;
h+=`<div class="kpi-card" onclick="nav('obj','Specimen__c')"><div class="kv">${done}</div><div class="kl">å¹´é–“æ¤œæŸ»å®Ÿç¸¾</div></div></div>`;
h+=`<div class="grid grid-2"><div class="chart-box"><h4>æœˆæ¬¡PMDAæå‡ºä»¶æ•°</h4><canvas id="pmdach1"></canvas></div>`;
h+=`<div class="chart-box"><h4>ã‚²ãƒãƒ æ¡ˆä»¶ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h4><canvas id="pmdach2"></canvas></div></div>`;
h+=`<div class="card" style="margin-top:16px"><h3>è¦åˆ¶é–¢é€£ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</h3><table><thead><tr><th>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</th><th>ãŒã‚“ç¨®</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>ã‚µãƒ³ãƒ—ãƒ«æ•°</th><th>è¦åˆ¶åŒºåˆ†</th></tr></thead><tbody>`;
gp.forEach(g=>h+=`<tr onclick="sd('Genomic_Project__c','${g.Id}')"><td>${g.Name}</td><td>${g.Cancer_Type__c}</td><td><span class="sb ${sc(g.Status__c)}">${g.Status__c}</span></td><td>${g.Sample_Count__c||0}</td><td>CDxé–¢é€£</td></tr>`);
h+=`</tbody></table></div>`;return h}
function iPMDA(){var mls=['7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
mc('pmdach1',{type:'line',data:{labels:mls,datasets:[{label:'æå‡ºä»¶æ•°',data:[2,3,1,4,3,5],borderColor:'#0176d3',backgroundColor:'rgba(1,118,211,.1)',fill:true,tension:.3}]},options:{responsive:true,plugins:{legend:{display:false}}}},'obj:Genomic_Project__c');
var gs=['æ¤œä½“å¾…ã¡','è§£æä¸­','ãƒ¬ãƒãƒ¼ãƒˆä½œæˆä¸­','ãƒ¬ãƒãƒ¼ãƒˆå®Œäº†','ç´å“æ¸ˆ'];
mc('pmdach2',{type:'bar',data:{labels:gs,datasets:[{data:gs.map(s=>(D.Genomic_Project__c||[]).filter(x=>x.Status__c===s).length),backgroundColor:CL}]},options:{responsive:true,plugins:{legend:{display:false}}}},'obj:Genomic_Project__c')}

// === 10. LSI Distributor Dashboard ===
function rLSI(){var ops=D.Pharma_Opportunity__c||[],mi=D.Medical_Institution__c||[];
var lsiOps=ops.filter((_,i)=>i<Math.ceil(ops.length/2));
var lsiAmt=lsiOps.reduce((s,o)=>s+(o.Amount__c||0),0);
var lsiInst=mi.filter((_,i)=>i<Math.ceil(mi.length/2));
var h=`<div class="grid grid-4" style="margin-bottom:20px">`;
h+=`<div class="kpi-card" onclick="nav('obj','Pharma_Opportunity__c')"><div class="kv">${lsiOps.length}</div><div class="kl">LSIçµŒç”±æ¡ˆä»¶æ•°</div></div>`;
h+=`<div class="kpi-card" onclick="nav('obj','Pharma_Opportunity__c')"><div class="kv">${fmt(lsiAmt)}</div><div class="kl">LSIçµŒç”±é‡‘é¡</div></div>`;
h+=`<div class="kpi-card" onclick="nav('obj','Medical_Institution__c')"><div class="kv">${lsiInst.length}</div><div class="kl">LSIæ‹…å½“æ–½è¨­</div></div>`;
h+=`<div class="kpi-card"><div class="kv">8</div><div class="kl">ä»£ç†åº—ã‚¹ã‚¿ãƒƒãƒ•æ•°</div></div></div>`;
h+=`<div class="grid grid-2"><div class="chart-box"><h4>LSIæœˆæ¬¡å£²ä¸Šæ¨ç§»</h4><canvas id="lsich1"></canvas></div>`;
h+=`<div class="chart-box"><h4>LSIãƒ†ãƒªãƒˆãƒªåˆ¥å®Ÿç¸¾</h4><canvas id="lsich2"></canvas></div></div>`;
h+=`<div class="card" style="margin-top:16px"><h3>LSIæ¡ˆä»¶ä¸€è¦§</h3><table><thead><tr><th>å•†è«‡å</th><th>ä¼æ¥­</th><th>ãƒ•ã‚§ãƒ¼ã‚º</th><th>é‡‘é¡</th><th>æ‹…å½“</th></tr></thead><tbody>`;
lsiOps.forEach(o=>h+=`<tr onclick="sd('Pharma_Opportunity__c','${o.Id}')"><td>${o.Name}</td><td>${o.Pharma_Company__c}</td><td><span class="sb ${sc(o.Phase__c)}">${o.Phase__c}</span></td><td>Â¥${(o.Amount__c||0).toLocaleString()}ä¸‡</td><td>${o.Owner_Name__c||'-'}</td></tr>`);
h+=`</tbody></table></div>`;
h+=`<div class="card"><h3>LSIæ‹…å½“æ–½è¨­ä¸€è¦§</h3><table><thead><tr><th>æ–½è¨­å</th><th>éƒ½é“åºœçœŒ</th><th>ç¨®åˆ¥</th><th>å°å…¥çŠ¶æ³</th><th>ç—…åºŠæ•°</th></tr></thead><tbody>`;
lsiInst.forEach(m=>h+=`<tr onclick="sd('Medical_Institution__c','${m.Id}')"><td>${m.Name}</td><td>${m.Prefecture__c||'-'}</td><td>${m.Facility_Type__c||'-'}</td><td><span class="sb ${sc(m.Adapter_Status__c)}">${m.Adapter_Status__c||'-'}</span></td><td>${m.Bed_Count__c||'-'}</td></tr>`);
h+=`</tbody></table></div>`;return h}
function iLSI(){var mls=['7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
mc('lsich1',{type:'line',data:{labels:mls,datasets:[{label:'ä¸‡å††',data:[1200,1500,1800,2200,2000,2500],borderColor:'#0176d3',backgroundColor:'rgba(1,118,211,.1)',fill:true,tension:.3}]},options:{responsive:true,plugins:{legend:{display:false}}}},'obj:Pharma_Opportunity__c');
var prefs=[...new Set((D.Medical_Institution__c||[]).map(m=>m.Prefecture__c).filter(Boolean))];
var ops=D.Pharma_Opportunity__c||[];
mc('lsich2',{type:'bar',data:{labels:prefs.length?prefs:['æ±äº¬éƒ½','å¤§é˜ªåºœ','äº¬éƒ½åºœ','ç¥å¥ˆå·çœŒ','ç¦å²¡çœŒ'],datasets:[{label:'ä»¶æ•°',data:prefs.length?prefs.map((_,i)=>Math.floor(Math.random()*5)+1):[3,2,1,2,1],backgroundColor:CL}]},options:{responsive:true,plugins:{legend:{display:false}}}},'obj:Medical_Institution__c')}

// === 11. Seminar Dashboard ===
function rSemDash(){var sem=D.Seminar__c||[],att=D.Seminar_Attendee__c||[];
var now='2025-12',thisMo=sem.filter(s=>s.Event_Date__c&&s.Event_Date__c.startsWith(now)).length;
var totAtt=sem.reduce((s,x)=>s+(x.Attendee_Count__c||0),0)+att.length;
var totCost=sem.reduce((s,x)=>s+((x.Speaker_Fee__c||0)+(x.Operation_Cost__c||0)),0);
var budgetAll=sem.length*500;
var br=budgetAll?pct(totCost,budgetAll):0;
var h=`<div class="grid grid-4" style="margin-bottom:20px">`;
h+=`<div class="kpi-card" onclick="nav('obj','Seminar__c')"><div class="kv">${sem.length}</div><div class="kl">å‹‰å¼·ä¼šç·æ•°</div></div>`;
h+=`<div class="kpi-card" onclick="nav('seminar-cal')"><div class="kv">${thisMo}</div><div class="kl">ä»Šæœˆé–‹å‚¬</div></div>`;
h+=`<div class="kpi-card" onclick="nav('seminar-attendees')"><div class="kv">${totAtt}</div><div class="kl">ç·å‚åŠ è€…</div></div>`;
h+=`<div class="kpi-card"><div class="kv">${br}%</div><div class="kl">äºˆç®—æ¶ˆåŒ–ç‡</div></div></div>`;
h+=`<div class="grid grid-3"><div class="chart-box"><h4>æœˆæ¬¡é–‹å‚¬æ•°æ¨ç§»</h4><canvas id="semch1"></canvas></div>`;
h+=`<div class="chart-box"><h4>å½¢å¼åˆ¥åˆ†å¸ƒ</h4><canvas id="semch2"></canvas></div>`;
h+=`<div class="chart-box"><h4>é€²æ—åˆ¥çŠ¶æ³</h4><canvas id="semch3"></canvas></div></div>`;
h+=`<div class="card" style="margin-top:16px"><h3>å‹‰å¼·ä¼šä¸€è¦§</h3><table><thead><tr><th>åç§°</th><th>å½¢å¼</th><th>é–‹å‚¬æ—¥</th><th>ä¼šå ´</th><th>å‚åŠ äººæ•°</th><th>çŠ¶æ…‹</th></tr></thead><tbody>`;
sem.sort((a,b)=>(b.Event_Date__c||'').localeCompare(a.Event_Date__c||'')).forEach(s=>{
var attCnt=(s.Attendee_Count__c||0)+(att.filter(a=>a.Seminar__c===s.Id).length);
h+=`<tr onclick="sd('Seminar__c','${s.Id}')"><td>${s.Name}</td><td>${s.Event_Format__c||'-'}</td><td>${s.Event_Date__c||'-'}</td><td>${s.Venue__c||'-'}</td><td>${attCnt}</td><td><span class="sb ${sc(s.Progress_Status__c)}">${s.Progress_Status__c}</span></td></tr>`});
h+=`</tbody></table></div>`;return h}
function iSemDash(){var sem=D.Seminar__c||[];
var mks=['2025-07','2025-08','2025-09','2025-10','2025-11','2025-12'],mls=['7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
mc('semch1',{type:'bar',data:{labels:mls,datasets:[{label:'é–‹å‚¬æ•°',data:mks.map(m=>sem.filter(s=>s.Event_Date__c&&s.Event_Date__c.startsWith(m)).length),backgroundColor:'#0176d3'}]},options:{responsive:true,plugins:{legend:{display:false}}}},'obj:Seminar__c');
var fmts=['é™¢å†…å‹‰å¼·ä¼š','Webè¬›æ¼”ä¼š','ãƒãƒ³ã‚ºã‚ªãƒ³ã‚»ãƒŸãƒŠãƒ¼','å­¦è¡“è¬›æ¼”ä¼š','åœ°åŸŸé€£æºã‚»ãƒŸãƒŠãƒ¼','ãƒ©ãƒ³ãƒãƒ§ãƒ³ã‚»ãƒŸãƒŠãƒ¼'];
var fmtMap={'é™¢å†…å‹‰å¼·ä¼š':'ã‚ªãƒ³ã‚µã‚¤ãƒˆ','Webè¬›æ¼”ä¼š':'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³','ãƒãƒ³ã‚ºã‚ªãƒ³ã‚»ãƒŸãƒŠãƒ¼':'ã‚ªãƒ³ã‚µã‚¤ãƒˆ','å­¦è¡“è¬›æ¼”ä¼š':'ã‚ªãƒ³ã‚µã‚¤ãƒˆ','åœ°åŸŸé€£æºã‚»ãƒŸãƒŠãƒ¼':'ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰','ãƒ©ãƒ³ãƒãƒ§ãƒ³ã‚»ãƒŸãƒŠãƒ¼':'ã‚ªãƒ³ã‚µã‚¤ãƒˆ'};
var cats=['ã‚ªãƒ³ã‚µã‚¤ãƒˆ','ã‚ªãƒ³ãƒ©ã‚¤ãƒ³','ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰'];
mc('semch2',{type:'doughnut',data:{labels:cats,datasets:[{data:cats.map(c=>sem.filter(s=>fmtMap[s.Event_Format__c]===c).length),backgroundColor:['#0176d3','#2ecc71','#f39c12']}]},options:{responsive:true,plugins:{legend:{position:'right'}}}},'obj:Seminar__c');
var ps=['ä¼ç”»ç«‹æ¡ˆ','è¬›å¸«ç¢ºå®š','æº–å‚™ä¸­','é–‹å‚¬æ¸ˆ'];
mc('semch3',{type:'bar',data:{labels:ps,datasets:[{label:'ä»¶æ•°',data:ps.map(p=>sem.filter(s=>s.Progress_Status__c===p).length),backgroundColor:CL}]},options:{responsive:true,plugins:{legend:{display:false}}}},'obj:Seminar__c')}

// === 12. Seminar Calendar ===
var semCalMonth=new Date(new Date().getFullYear(),new Date().getMonth(),1);
var calSeminars=[];
function renderSemCalHTML(){var m=semCalMonth,y=m.getFullYear(),mo=m.getMonth(),ml=['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
var h=`<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><button class="btn sm sec" onclick="navSemCal(-1)">&larr; å‰æœˆ</button><h3 style="margin:0">${y}å¹´${ml[mo]}</h3><button class="btn sm sec" onclick="navSemCal(1)">æ¬¡æœˆ &rarr;</button></div>`;
h+=`<div class="cal-grid"><div class="cal-hdr">æ—¥</div><div class="cal-hdr">æœˆ</div><div class="cal-hdr">ç«</div><div class="cal-hdr">æ°´</div><div class="cal-hdr">æœ¨</div><div class="cal-hdr">é‡‘</div><div class="cal-hdr">åœŸ</div>`;
var fd=new Date(y,mo,1).getDay(),ld=new Date(y,mo+1,0).getDate(),sem=calSeminars;
var pad=s=>String(s).padStart(2,'0');
for(var i=0;i<fd;i++)h+=`<div class="cal-day other"></div>`;
for(var d=1;d<=ld;d++){var ds=y+'-'+pad(mo+1)+'-'+pad(d);var dv=sem.filter(s=>s.Event_Date__c===ds);
h+=`<div class="cal-day" onclick="openNew('Seminar__c',{Event_Date__c:'${ds}'})"><div style="font-weight:600;font-size:11px;margin-bottom:2px">${d}</div>`;
dv.forEach(s=>{var cls=s.Progress_Status__c==='é–‹å‚¬æ¸ˆ'||s.Progress_Status__c==='å®Œäº†'?'cal-evt good':s.Progress_Status__c==='æº–å‚™ä¸­'||s.Progress_Status__c==='æ¡ˆå†…é…ä¿¡æ¸ˆ'||s.Progress_Status__c==='è¬›å¸«ç¢ºå®š'||s.Progress_Status__c==='ä¼šå ´ãƒ»æ—¥ç¨‹èª¿æ•´ä¸­'?'cal-evt hold':s.Progress_Status__c==='ä¼ç”»ç«‹æ¡ˆ'||s.Progress_Status__c==='è¬›å¸«æ‰“è¨ºä¸­'?'cal-evt bad':'cal-evt';
h+=`<div class="${cls}" onclick="event.stopPropagation();sd('Seminar__c','${s.Id}')" title="${s.Name}">${s.Name.slice(0,6)}</div>`});
h+=`</div>`}
var rem=(fd+ld)%7;if(rem>0)for(var i=0;i<7-rem;i++)h+=`<div class="cal-day other"></div>`;
return h+`</div></div>`}
async function loadCalSeminars(){
var m=semCalMonth,y=m.getFullYear(),mo=m.getMonth();
var pad=s=>String(s).padStart(2,'0');
var from=y+'-'+pad(mo+1)+'-01';
var to=y+'-'+pad(mo+1)+'-'+pad(new Date(y,mo+1,0).getDate());
try{var resp=await fetch('/api/data/Seminar__c?from='+from+'&to='+to+'&dateField=Event_Date__c').then(r=>r.json());calSeminars=resp.records||[]}catch(e){calSeminars=(D.Seminar__c||[]).filter(s=>{var d=s.Event_Date__c||'';return d>=from&&d<=to})}
}
function rSemCal(){return'<div style="text-align:center;padding:40px;color:#999">èª­ã¿è¾¼ã¿ä¸­...</div>'}
function iSemCal(){loadCalSeminars().then(()=>{document.getElementById('C').innerHTML=renderSemCalHTML()})}
function navSemCal(d){semCalMonth=new Date(semCalMonth.getFullYear(),semCalMonth.getMonth()+d,1);document.getElementById('C').innerHTML='<div style="text-align:center;padding:40px;color:#999">èª­ã¿è¾¼ã¿ä¸­...</div>';loadCalSeminars().then(()=>{document.getElementById('C').innerHTML=renderSemCalHTML()})}

// === 13. Bento Management ===
function rBento(){var bo=D.Bento_Order__c||[],sem=D.Seminar__c||[];
var tot=bo.length,now='2025-12',thisM=bo.filter(b=>b.Order_Date__c&&b.Order_Date__c.startsWith(now)).length;
var totAmt=bo.reduce((s,b)=>s+(b.Amount__c||0),0);
var h=`<div class="grid grid-3" style="margin-bottom:20px">`;
h+=`<div class="kpi-card" onclick="nav('obj','Bento_Order__c')"><div class="kv">${tot}</div><div class="kl">ç·æ³¨æ–‡æ•°</div></div>`;
h+=`<div class="kpi-card" onclick="nav('obj','Bento_Order__c')"><div class="kv">${thisM}</div><div class="kl">ä»Šæœˆæ³¨æ–‡</div></div>`;
h+=`<div class="kpi-card" onclick="nav('obj','Bento_Order__c')"><div class="kv">Â¥${totAmt.toLocaleString()}</div><div class="kl">åˆè¨ˆé‡‘é¡</div></div></div>`;
h+=`<div style="margin-bottom:12px"><button class="btn" onclick="openNew('Bento_Order__c')">+ æ–°è¦å¼å½“æ³¨æ–‡</button></div>`;
// Group by seminar
var semIds=[...new Set(bo.map(b=>b.Seminar__c).filter(Boolean))];
semIds.forEach(sid=>{var s=sem.find(x=>x.Id===sid);var orders=bo.filter(b=>b.Seminar__c===sid);
var semName=s?s.Name:dn(sid);var semDate=s?s.Event_Date__c:'';var semVenue=s?s.Venue__c:'';
var subQty=orders.reduce((a,b)=>a+(b.Quantity__c||0),0);
var subAmt=orders.reduce((a,b)=>a+(b.Amount__c||0),0);
h+=`<div class="card"><h3>${semName}</h3><div style="font-size:12px;color:#888;margin-bottom:8px">${semDate?'é–‹å‚¬æ—¥: '+semDate:''} ${semVenue?'/ ä¼šå ´: '+semVenue:''}</div>`;
h+=`<table><thead><tr><th>æ³¨æ–‡å</th><th>ãƒ¡ãƒ‹ãƒ¥ãƒ¼</th><th>æ•°é‡</th><th>æ¥­è€…</th><th>é‡‘é¡</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th></tr></thead><tbody>`;
orders.forEach(o=>h+=`<tr onclick="sd('Bento_Order__c','${o.Id}')"><td>${o.Name}</td><td>${o.Menu_Type__c||'-'}</td><td>${o.Quantity__c||0}</td><td>${o.Vendor__c||'-'}</td><td>Â¥${(o.Amount__c||0).toLocaleString()}</td><td><span class="sb ${sc(o.Status__c)}">${o.Status__c||'-'}</span></td></tr>`);
h+=`</tbody></table><div style="text-align:right;font-size:12px;color:#555;margin-top:6px">å°è¨ˆ: ${subQty}é£Ÿ / Â¥${subAmt.toLocaleString()}</div></div>`});
// Unlinked orders
var unlinked=bo.filter(b=>!b.Seminar__c);
if(unlinked.length){h+=`<div class="card"><h3>ã‚»ãƒŸãƒŠãƒ¼æœªç´ä»˜</h3><table><thead><tr><th>æ³¨æ–‡å</th><th>ãƒ¡ãƒ‹ãƒ¥ãƒ¼</th><th>æ•°é‡</th><th>æ¥­è€…</th><th>é‡‘é¡</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th></tr></thead><tbody>`;
unlinked.forEach(o=>h+=`<tr onclick="sd('Bento_Order__c','${o.Id}')"><td>${o.Name}</td><td>${o.Menu_Type__c||'-'}</td><td>${o.Quantity__c||0}</td><td>${o.Vendor__c||'-'}</td><td>Â¥${(o.Amount__c||0).toLocaleString()}</td><td><span class="sb ${sc(o.Status__c)}">${o.Status__c||'-'}</span></td></tr>`);
h+=`</tbody></table></div>`}
return h}

// === 14. Seminar Registration ===
function rSemReg(){var sem=D.Seminar__c||[],att=D.Seminar_Attendee__c||[];
var h=`<div class="card" style="max-width:700px;margin:0 auto"><h3 style="text-align:center;font-size:18px;margin-bottom:16px">ã‚»ãƒŸãƒŠãƒ¼å‚åŠ ç™»éŒ²</h3>`;
h+=`<div class="form-group"><label>ã‚»ãƒŸãƒŠãƒ¼é¸æŠ</label><select id="regSemSel" onchange="updRegInfo()" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;font-size:13px"><option value="">-- ã‚»ãƒŸãƒŠãƒ¼ã‚’é¸æŠ --</option>`;
sem.forEach(s=>h+=`<option value="${s.Id}">${s.Name} (${s.Event_Date__c||''})</option>`);
h+=`</select></div><div id="regSemInfo"></div>`;
h+=`<div class="form-group"><label>ãŠåå‰</label><input type="text" id="regName" placeholder="å±±ç”°å¤ªéƒ"></div>`;
h+=`<div class="form-group"><label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label><input type="email" id="regEmail" placeholder="example@email.com"></div>`;
h+=`<div class="form-group"><label>æ‰€å±</label><input type="text" id="regAffil" placeholder="æ‰€å±æ©Ÿé–¢ãƒ»ä¼æ¥­å"></div>`;
h+=`<div class="form-group"><label>å°‚é–€åˆ†é‡</label><input type="text" id="regSpec" placeholder="å°‚é–€åˆ†é‡"></div>`;
h+=`<button class="btn" onclick="submitReg()" style="width:100%;padding:10px;font-size:14px">ç™»éŒ²ã™ã‚‹</button></div>`;
h+=`<div class="card" style="max-width:700px;margin:16px auto" id="regAttList"><h3>å‚åŠ è€…ä¸€è¦§</h3><p style="color:#888;font-size:12px">ã‚»ãƒŸãƒŠãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</p></div>`;
return h}
function updRegInfo(){var id=document.getElementById('regSemSel').value;
if(!id){document.getElementById('regSemInfo').innerHTML='';document.getElementById('regAttList').innerHTML='<h3>å‚åŠ è€…ä¸€è¦§</h3><p style="color:#888;font-size:12px">ã‚»ãƒŸãƒŠãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</p>';return}
var s=(D.Seminar__c||[]).find(x=>x.Id===id);if(!s)return;
document.getElementById('regSemInfo').innerHTML=`<div style="background:#f5f5f5;padding:12px;border-radius:6px;margin-bottom:12px;font-size:13px"><strong>${s.Name}</strong><br>é–‹å‚¬æ—¥: ${s.Event_Date__c||'-'} / ä¼šå ´: ${s.Venue__c||'-'} / å½¢å¼: ${s.Event_Format__c||'-'}</div>`;
var att=(D.Seminar_Attendee__c||[]).filter(a=>a.Seminar__c===id);
var h=`<h3>å‚åŠ è€…ä¸€è¦§ (${att.length}å)</h3><table><thead><tr><th>åå‰</th><th>ãƒ¡ãƒ¼ãƒ«</th><th>æ‰€å±</th><th>å°‚é–€</th><th>çŠ¶æ³</th></tr></thead><tbody>`;
att.forEach(a=>h+=`<tr><td>${a.Name}</td><td>${a.Email__c||'-'}</td><td>${a.Affiliation__c||'-'}</td><td>${a.Specialty__c||'-'}</td><td><span class="sb ${sc(a.Attendance_Status__c)}">${a.Attendance_Status__c||'-'}</span></td></tr>`);
if(!att.length)h+=`<tr><td colspan="5" style="color:#888">å‚åŠ è€…ãªã—</td></tr>`;
document.getElementById('regAttList').innerHTML=h+`</tbody></table>`}
function submitReg(){var sid=document.getElementById('regSemSel').value;
var nm=document.getElementById('regName').value,em=document.getElementById('regEmail').value;
var af=document.getElementById('regAffil').value,sp=document.getElementById('regSpec').value;
if(!sid||!nm||!em){toast('ã‚»ãƒŸãƒŠãƒ¼ãƒ»åå‰ãƒ»ãƒ¡ãƒ¼ãƒ«ã¯å¿…é ˆã§ã™','error');return}
var body={Name:nm,Email__c:em,Affiliation__c:af,Specialty__c:sp,Seminar__c:sid,Attendance_Status__c:'ç™»éŒ²æ¸ˆ',Registration_Date__c:new Date().toISOString().slice(0,10)};
fetch('/api/data/Seminar_Attendee__c',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)})
.then(r=>{if(!r.ok)throw new Error('ç™»éŒ²å¤±æ•—');return r.json()})
.then(res=>{body.Id=res.Id;if(!D.Seminar_Attendee__c)D.Seminar_Attendee__c=[];D.Seminar_Attendee__c.push(body);
toast('å‚åŠ ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸ');document.getElementById('regName').value='';document.getElementById('regEmail').value='';
document.getElementById('regAffil').value='';document.getElementById('regSpec').value='';updRegInfo()})
.catch(e=>toast(e.message,'error'))}

// === 15. Quote Estimation System ===
function rQuote(){
var items=[
{d:'æ¤œä½“å‡¦ç†è²»',u:50000,unit:'/æ¤œä½“'},{d:'éºä¼å­è§£æè²» - XT(çµ„ç¹”)',u:300000,unit:''},
{d:'éºä¼å­è§£æè²» - xF(ãƒªã‚­ãƒƒãƒ‰)',u:250000,unit:''},{d:'ãƒ¬ãƒãƒ¼ãƒˆä½œæˆè²»',u:80000,unit:''},
{d:'ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²»',u:30000,unit:'/æœˆ'},{d:'æŠ€è¡“ã‚µãƒãƒ¼ãƒˆè²»',u:100000,unit:'/å¹´'}];
var h=`<div class="card"><h3>GenMineTOP ç©ç®—è¦‹ç©</h3>`;
h+=`<table><thead><tr><th>é …ç›®</th><th>å˜ä¾¡</th><th>æ•°é‡</th><th>å°è¨ˆ</th></tr></thead><tbody>`;
items.forEach((it,i)=>h+=`<tr class="quote-line"><td>${it.d} <span style="color:#888;font-size:10px">${it.unit}</span></td><td>Â¥${it.u.toLocaleString()}</td><td><input type="number" id="qq${i}" value="0" min="0" style="width:60px;padding:4px;border:1px solid #ccc;border-radius:3px" onchange="calcQuote()" oninput="calcQuote()"></td><td id="qs${i}" style="text-align:right;font-weight:600">Â¥0</td></tr>`);
h+=`</tbody></table>`;
h+=`<div style="border-top:2px solid #e0e0e0;padding-top:12px;margin-top:12px">`;
h+=`<div style="display:flex;justify-content:space-between;font-size:15px;margin-bottom:8px"><span>å°è¨ˆ</span><span id="qSubtotal" style="font-weight:700">Â¥0</span></div>`;
h+=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span>å€¤å¼•ç‡</span><span><input type="number" id="qDisc" value="0" min="0" max="100" style="width:60px;padding:4px;border:1px solid #ccc;border-radius:3px" onchange="calcQuote()" oninput="calcQuote()"> %</span></div>`;
h+=`<div style="display:flex;justify-content:space-between;font-size:18px;font-weight:700;color:#0176d3"><span>åˆè¨ˆï¼ˆç¨æŠœï¼‰</span><span id="qTotal">Â¥0</span></div>`;
h+=`<div style="display:flex;justify-content:space-between;font-size:14px;color:#555;margin-top:4px"><span>åˆè¨ˆï¼ˆç¨è¾¼10%ï¼‰</span><span id="qTotalTax">Â¥0</span></div>`;
h+=`</div></div>`;return h}
function calcQuote(){
var items=[50000,300000,250000,80000,30000,100000];var sub=0;
items.forEach((u,i)=>{var q=Number(document.getElementById('qq'+i).value)||0;var s=u*q;sub+=s;
document.getElementById('qs'+i).textContent='Â¥'+s.toLocaleString()});
document.getElementById('qSubtotal').textContent='Â¥'+sub.toLocaleString();
var disc=Number(document.getElementById('qDisc').value)||0;
var total=Math.round(sub*(1-disc/100));
document.getElementById('qTotal').textContent='Â¥'+total.toLocaleString();
document.getElementById('qTotalTax').textContent='Â¥'+Math.round(total*1.1).toLocaleString()}

// === 16. Facility Map ===
var facMap=null,facMarkers=[];
function rFacMap(){
var h=`<div class="card"><h3>æ–½è¨­ãƒãƒƒãƒ—</h3></div>`;
h+=`<div id="facMapEl" style="height:500px;border-radius:6px;margin-bottom:16px"></div>`;
h+=`<div class="card" style="margin-bottom:8px"><div style="font-size:12px"><span style="display:inline-block;width:12px;height:12px;background:#2563eb;border-radius:50%;margin-right:4px;vertical-align:middle"></span> åŒ»ç™‚æ©Ÿé–¢ <span style="display:inline-block;width:12px;height:12px;background:#e74c3c;border-radius:50%;margin-right:4px;margin-left:12px;vertical-align:middle"></span> ã‚»ãƒŸãƒŠãƒ¼ä¼šå ´</div></div>`;
var mi=D.Medical_Institution__c||[];
h+=`<div class="card"><h3>æ–½è¨­ä¸€è¦§</h3><table><thead><tr><th>æ–½è¨­å</th><th>ç¨®åˆ¥</th><th>éƒ½é“åºœçœŒ</th><th>å°å…¥çŠ¶æ³</th></tr></thead><tbody>`;
mi.forEach(m=>h+=`<tr onclick="sd('Medical_Institution__c','${m.Id}')"><td>${m.Name}</td><td>${m.Facility_Type__c||'-'}</td><td>${m.Prefecture__c||'-'}</td><td><span class="sb ${sc(m.Adapter_Status__c)}">${m.Adapter_Status__c||'-'}</span></td></tr>`);
h+=`</tbody></table></div>`;return h}
function iFacMap(){
var el=document.getElementById('facMapEl');if(!el)return;
facMap=L.map(el).setView([35.68,139.69],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap',maxZoom:19}).addTo(facMap);
setTimeout(function(){facMap.invalidateSize()},200);
facMarkers=[];
var blueIcon=L.divIcon({className:'',html:'<div style="width:14px;height:14px;background:#2563eb;border:2px solid #fff;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,.3)"></div>',iconSize:[14,14],iconAnchor:[7,7]});
var redIcon=L.divIcon({className:'',html:'<div style="width:14px;height:14px;background:#e74c3c;border:2px solid #fff;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,.3)"></div>',iconSize:[14,14],iconAnchor:[7,7]});
(D.Medical_Institution__c||[]).forEach(m=>{if(!m.Latitude__c||!m.Longitude__c)return;
var mk=L.marker([m.Latitude__c,m.Longitude__c],{icon:blueIcon}).addTo(facMap).bindPopup(`<b>${m.Name}</b><br>${m.Facility_Type__c||''}<br>${m.Prefecture__c||''}<br><span class="sb ${sc(m.Adapter_Status__c)}">${m.Adapter_Status__c||''}</span>`);
facMarkers.push(mk)});
(D.Seminar__c||[]).forEach(s=>{if(!s.Venue_Latitude__c||!s.Venue_Longitude__c)return;
var mk=L.marker([s.Venue_Latitude__c,s.Venue_Longitude__c],{icon:redIcon}).addTo(facMap).bindPopup(`<b>${s.Name}</b><br>${s.Venue__c||''}<br>${s.Event_Date__c||''}<br><span class="sb ${sc(s.Progress_Status__c)}">${s.Progress_Status__c||''}</span>`);
facMarkers.push(mk)});
if(facMarkers.length){var g=L.featureGroup(facMarkers);facMap.fitBounds(g.getBounds().pad(0.1))}}


// ===== Generic Object List =====
function rObj(obj){
  const recs=D[obj]||[];const keys=OK[obj]||['Name'];const kf=KF[obj];
  const ps=pageState[obj]||{};
  const totalSize=ps.totalSize||recs.length;
  const page=ps.page||1;
  const pageCount=ps.pageCount||1;
  const searchVal=ps.q||'';
  let h=`<div style="display:flex;gap:8px;align-items:center;margin-bottom:12px"><input type="text" id="searchInput" placeholder="æ¤œç´¢..." value="${searchVal}" oninput="filt(this.value)" oncompositionstart="imeOn=true" oncompositionend="imeOn=false;filt(this.value)" onkeydown="if(!imeOn&&event.key==='Enter'){clearTimeout(searchTimeout);filt(this.value)}" style="flex:1;padding:8px;border:1px solid #ccc;border-radius:4px;font-size:13px"><button class="btn sm" onclick="clearTimeout(searchTimeout);filt(document.getElementById('searchInput').value)" style="padding:8px 16px">ğŸ” æ¤œç´¢</button><span style="color:#888;font-size:12px">${totalSize}ä»¶</span>`;
  if(kf)h+=`<button class="btn sm sec" onclick="tKan('${obj}','${kf}')">ã‚«ãƒ³ãƒãƒ³</button>`;
  h+=`<button class="btn sm" id="btnNew" data-obj="${obj}">+ æ–°è¦ä½œæˆ</button>`;
  h+=`</div><div id="kan"></div><table id="tbl"><thead><tr>`;
  keys.forEach(k=>h+=`<th style="cursor:pointer" onclick="sortCol('${obj}','${k}')">${fl(k)}</th>`);
  h+=`</tr></thead><tbody>`;
  recs.forEach(r=>{h+=`<tr onclick="sd('${obj}','${r.Id}')">`;keys.forEach(k=>{let v=r[k];
  if(['Doctor__c','Medical_Institution__c','Seminar__c','AccountId','ContactId','OpportunityId','CampaignId','OwnerId','Product2Id','WhoId','WhatId','ParentId'].includes(k))v=dn(v);
  if(['Amount__c','Budget__c','Amount','UnitPrice','TotalPrice','BudgetedCost','ActualCost','ExpectedRevenue','Subtotal','Tax','GrandTotal','TotalAmount','AnnualRevenue','Speaker_Fee__c','Operation_Cost__c'].includes(k))v=v!=null?'Â¥'+Number(v).toLocaleString():'-';
  if(k==='Is_KOL__c')v=v?'â­':'-';if(typeof v==='boolean')v=v?'âœ“':'-';
  const isSt=['Phase__c','Status__c','Specimen_Status__c','Adapter_Status__c','Relationship_Level__c','Meeting_Result__c','Progress_Status__c','Operation_Status__c','Compliance_Check__c','Attendance_Status__c','StageName','Status','Priority','Type','ForecastCategory','Origin','Role','Family'].includes(k);
  h+=isSt&&v?`<td><span class="sb ${sc(v)}">${v}</span></td>`:`<td>${v!=null?v:'-'}</td>`});h+=`</tr>`});
  h+=`</tbody></table>`;
  // Pagination controls
  if(pageCount>1){
    h+=`<div style="display:flex;justify-content:center;align-items:center;gap:12px;margin-top:12px;padding:8px">`;
    h+=`<button class="btn sm sec" onclick="gotoPage('${obj}',${page-1})" ${page<=1?'disabled':''}>â† å‰ã¸</button>`;
    h+=`<span style="color:#666;font-size:13px">ãƒšãƒ¼ã‚¸ ${page} / ${pageCount}</span>`;
    h+=`<button class="btn sm sec" onclick="gotoPage('${obj}',${page+1})" ${page>=pageCount?'disabled':''}>æ¬¡ã¸ â†’</button>`;
    h+=`</div>`;
  }
  return h;
}
async function gotoPage(obj,page){
  if(page<1)return;
  const ps=pageState[obj]||{};
  if(ps.pageCount&&page>ps.pageCount)return;
  await loadPage(obj,page);
  R();
}
function sortCol(obj,field){
  const ps=pageState[obj]||{};
  const newDir=(ps.sortBy===field&&ps.sortDir==='ASC')?'DESC':'ASC';
  loadPage(obj,1,{sortBy:field,sortDir:newDir}).then(()=>R());
}
let searchTimeout;
var imeOn=false;
function filt(q){
  clearTimeout(searchTimeout);
  if(imeOn)return;
  searchTimeout=setTimeout(()=>{
    const ps=pageState[co]||{};
    ps.q=q;
    loadPage(co,1,{q:q}).then(()=>R());
  },300);
}
function tKan(obj,field){const a=document.getElementById('kan');if(a.innerHTML){a.innerHTML='';return}
const recs=D[obj]||[];const vals=[...new Set(recs.map(r=>r[field]).filter(Boolean))];
let h='<div class="kanban">';vals.forEach(v=>{const items=recs.filter(r=>r[field]===v);
h+=`<div class="kanban-col"><div class="kanban-hdr">${v}<span class="cnt">${items.length}</span></div>`;
items.forEach(r=>h+=`<div class="kcard" onclick="sd('${obj}','${r.Id}')"><strong>${r.Name||r.Subject||r.LastName||'-'}</strong><small>${OL[obj]||obj}</small></div>`);h+=`</div>`});
a.innerHTML=h+'</div>'}
async function sd(obj,id,skipPush){
  co=obj;
  try{
    const resp=await fetch('/api/data/'+obj+'/'+id).then(r=>r.json());
    cr=resp;
  }catch(e){cr=(D[obj]||[]).find(r=>r.Id===id)}
  cv='detail';
  if(!skipPush)history.pushState({cv:'detail',co:obj,crId:id},'');
  R();
}

// ===== Record Detail =====
let isEditing=false;
function rDet(){if(!cr)return'';
let h=`<div class="card" style="display:flex;justify-content:space-between;align-items:center"><div><h2 style="margin:0">${cr.Name||cr.Subject||cr.LastName||'-'}</h2><small style="color:#999">${OL[co]||co}</small></div><div style="display:flex;gap:8px" id="detActions">`;
if(isEditing){h+=`<button class="btn" id="btnSave">ä¿å­˜</button><button class="btn sec" id="btnCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>`}
else{h+=`<button class="btn" id="btnEdit">ç·¨é›†</button><button class="btn danger" id="btnDel">å‰Šé™¤</button><button class="btn sec" id="btnBack">â† æˆ»ã‚‹</button>`}
h+=`</div></div><div class="card"><h3>è©³ç´°æƒ…å ±</h3><div class="detail-grid" id="detGrid">`;
Object.keys(cr).forEach(k=>{if(k==='Id')return;
if(isEditing){h+=`<div class="form-group"><label>${fl(k)}</label>${fieldInput(k,cr[k])}</div>`}
else{let v=cr[k];if(['Doctor__c','Medical_Institution__c','Seminar__c','AccountId','ContactId','OpportunityId','CampaignId','OwnerId','Product2Id','WhoId','WhatId','ParentId'].includes(k))v=dn(v);if(['Amount__c','Budget__c','Speaker_Fee__c','Operation_Cost__c','Amount','UnitPrice','TotalPrice','BudgetedCost','ActualCost','ExpectedRevenue','Subtotal','Tax','GrandTotal','TotalAmount','AnnualRevenue'].includes(k))v=v!=null?'Â¥'+Number(v).toLocaleString():'-';if(typeof v==='boolean')v=v?'âœ“ ã¯ã„':'âœ— ã„ã„ãˆ';h+=`<div class="detail-field"><label>${fl(k)}</label><div class="val">${v!=null?v:'-'}</div></div>`}});
return h+'</div></div>'}
function bindDetEvents(){
const be=document.getElementById('btnEdit'),bs=document.getElementById('btnSave'),bc=document.getElementById('btnCancel'),bd=document.getElementById('btnDel'),bb=document.getElementById('btnBack');
if(be)be.addEventListener('click',function(){isEditing=true;R()});
if(bs)bs.addEventListener('click',function(){doSaveEdit()});
if(bc)bc.addEventListener('click',function(){isEditing=false;R()});
if(bd)bd.addEventListener('click',function(){doDelete()});
if(bb)bb.addEventListener('click',function(){isEditing=false;history.back()})
}

// ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ï¼ˆä»£ç†ãƒ­ã‚°ã‚¤ãƒ³ï¼‰ =====
let adminUsersList=[];
const PROFILES=['System_Admin','Sales_Rep','MSL','Lab_Manager','Read_Only'];
function rAdminUsers(){
let h='<div class="card" style="display:flex;justify-content:space-between;align-items:center"><h3 style="margin:0">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h3><button class="btn" onclick="showAddUserModal()">+ ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </button></div>';
h+='<div class="card"><p style="font-size:12px;color:#888;margin-bottom:12px">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã€Œä»£ç†ãƒ­ã‚°ã‚¤ãƒ³ã€ãƒœã‚¿ãƒ³ã§ã€ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ã§ã‚·ã‚¹ãƒ†ãƒ ã‚’é–²è¦§ã§ãã¾ã™</p>';
h+='<table><thead><tr><th>åå‰</th><th>ãƒ¡ãƒ¼ãƒ«</th><th>ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«</th><th>æœ‰åŠ¹</th><th>æ“ä½œ</th></tr></thead><tbody id="adminUsersBody">';
if(adminUsersList.length===0){h+='<tr><td colspan="5" style="text-align:center;color:#999;padding:24px">èª­ã¿è¾¼ã¿ä¸­...</td></tr>'}
else{adminUsersList.forEach(u=>{
const name=(u.FirstName||'')+(u.FirstName?' ':'')+(u.LastName||u.Username||u.Email||'-');
const email=u.Email||u.Username||'-';
const profile=u.ProfileId||'-';
const active=u.IsActive!==false?'<span class="sb sg">æœ‰åŠ¹</span>':'<span class="sb sr">ç„¡åŠ¹</span>';
const esc=s=>(s||'').replace(/'/g,"\\'");
h+=`<tr><td>${name}</td><td>${email}</td><td><span class="badge">${profile}</span></td><td>${active}</td><td style="display:flex;gap:4px"><button class="btn sm" onclick="startImpersonate('${esc(email)}','${esc(name)}')">ä»£ç†ãƒ­ã‚°ã‚¤ãƒ³</button>${u.Id?`<button class="btn sm danger" onclick="deleteUser('${u.Id}','${esc(name)}')">å‰Šé™¤</button>`:''}</td></tr>`})}
h+='</tbody></table></div>';
return h}
function showAddUserModal(){
const o=document.createElement('div');o.className='modal-overlay';o.id='addUserOverlay';
o.innerHTML=`<div class="modal"><div class="modal-hdr"><h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </h3><span style="cursor:pointer;font-size:20px" onclick="document.getElementById('addUserOverlay').remove()">âœ•</span></div><div class="modal-body">
<div class="form-group"><label>å§“ *</label><input id="nuLastName" placeholder="å±±ç”°"></div>
<div class="form-group"><label>å</label><input id="nuFirstName" placeholder="å¤ªéƒ"></div>
<div class="form-group"><label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label><input id="nuEmail" type="email" placeholder="user@example.com"></div>
<div class="form-group"><label>ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«</label><select id="nuProfile">${PROFILES.map(p=>`<option value="${p}">${p}</option>`).join('')}</select></div>
</div><div class="modal-footer"><button class="btn sec" onclick="document.getElementById('addUserOverlay').remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn" onclick="createUser()">ä½œæˆ</button></div></div>`;
document.body.appendChild(o)}
async function createUser(){
const LastName=document.getElementById('nuLastName').value.trim();
const FirstName=document.getElementById('nuFirstName').value.trim();
const Email=document.getElementById('nuEmail').value.trim();
const ProfileId=document.getElementById('nuProfile').value;
if(!LastName){alert('å§“ã¯å¿…é ˆã§ã™');return}
if(!Email){alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¿…é ˆã§ã™');return}
try{const resp=await fetch('/api/admin/users',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({LastName,FirstName,Email,ProfileId})});
const data=await resp.json();if(data.success){document.getElementById('addUserOverlay').remove();bAdminUsers()}else{alert('ä½œæˆå¤±æ•—: '+(data.error||''))}}catch(e){alert('ã‚¨ãƒ©ãƒ¼: '+e.message)}}
async function deleteUser(id,name){
if(!confirm(name+' ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
try{const resp=await fetch('/api/admin/users/'+id,{method:'DELETE'});const data=await resp.json();if(data.success){bAdminUsers()}else{alert('å‰Šé™¤å¤±æ•—: '+(data.error||''))}}catch(e){alert('ã‚¨ãƒ©ãƒ¼: '+e.message)}}
async function bAdminUsers(){
try{
const resp=await fetch('/api/data/User');
const data=await resp.json();
adminUsersList=data.records||[];
}catch(e){adminUsersList=[]; console.error('Failed to load users:',e)}
R()}
async function startImpersonate(email,name){
if(!confirm(name+' ã¨ã—ã¦ä»£ç†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã‹ï¼Ÿ\n\nãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ã§ã‚·ã‚¹ãƒ†ãƒ ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚'))return;
try{const resp=await fetch('/api/admin/impersonate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email})});
const data=await resp.json();if(data.success){location.reload()}else{alert('ä»£ç†ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: '+(data.error||''))}}catch(e){alert('ã‚¨ãƒ©ãƒ¼: '+e.message)}}
async function stopImpersonate(){
try{await fetch('/api/admin/stop-impersonate',{method:'POST',headers:{'Content-Type':'application/json'}});location.reload()}catch(e){alert('ã‚¨ãƒ©ãƒ¼: '+e.message)}}

// ===== ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ =====
function rAccess(){const objs=Object.keys(OL);
const ps=[{n:'System_Admin',l:'ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…',p:Object.fromEntries(objs.map(o=>[o,{c:1,r:1,e:1,d:1}]))},{n:'Sales_Rep',l:'å–¶æ¥­æ‹…å½“(MR)',p:{Medical_Institution__c:{c:1,r:1,e:1,d:0},Doctor__c:{c:1,r:1,e:1,d:0},Visit_Record__c:{c:1,r:1,e:1,d:1},Pharma_Opportunity__c:{c:1,r:1,e:1,d:0},Bento_Order__c:{c:1,r:1,e:1,d:0},Seminar_Attendee__c:{c:1,r:1,e:1,d:0},Genomic_Project__c:{c:0,r:1,e:0,d:0},Specimen__c:{c:0,r:1,e:0,d:0},MA_Activity__c:{c:0,r:1,e:0,d:0},Seminar__c:{c:0,r:1,e:0,d:0},Lab__c:{c:0,r:1,e:0,d:0},Joint_Research__c:{c:0,r:1,e:0,d:0}}},{n:'MSL',l:'MSL',p:{Medical_Institution__c:{c:0,r:1,e:0,d:0},Doctor__c:{c:1,r:1,e:1,d:0},MA_Activity__c:{c:1,r:1,e:1,d:1},Seminar__c:{c:1,r:1,e:1,d:0},Visit_Record__c:{c:1,r:1,e:1,d:0},Pharma_Opportunity__c:{c:0,r:1,e:0,d:0},Specimen__c:{c:0,r:1,e:0,d:0},Genomic_Project__c:{c:0,r:1,e:0,d:0},Lab__c:{c:0,r:1,e:0,d:0},Joint_Research__c:{c:1,r:1,e:1,d:0},Bento_Order__c:{c:1,r:1,e:1,d:0},Seminar_Attendee__c:{c:1,r:1,e:1,d:0}}},{n:'Lab_Manager',l:'ãƒ©ãƒœç®¡ç†è€…',p:{Specimen__c:{c:1,r:1,e:1,d:0},Lab__c:{c:1,r:1,e:1,d:0},Genomic_Project__c:{c:1,r:1,e:1,d:0},Medical_Institution__c:{c:0,r:1,e:0,d:0},Doctor__c:{c:0,r:1,e:0,d:0}}},{n:'PMDA_Manager',l:'PMDAæ‹…å½“',p:{Specimen__c:{c:0,r:1,e:0,d:0},Lab__c:{c:0,r:1,e:0,d:0},Genomic_Project__c:{c:0,r:1,e:0,d:0},Medical_Institution__c:{c:0,r:1,e:0,d:0},Doctor__c:{c:0,r:1,e:0,d:0}}},{n:'LSI_Manager',l:'LSIæ‹…å½“',p:{Specimen__c:{c:0,r:1,e:1,d:0},Lab__c:{c:0,r:1,e:0,d:0},Medical_Institution__c:{c:0,r:1,e:0,d:0}}}];
let h='';ps.forEach(p=>{h+=`<div class="card"><h3>${p.l}ï¼ˆ${p.n}ï¼‰</h3><table class="perm-table"><thead><tr><th style="text-align:left">ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ</th><th>ä½œæˆ</th><th>å‚ç…§</th><th>ç·¨é›†</th><th>å‰Šé™¤</th></tr></thead><tbody>`;
objs.forEach(o=>{const pm=p.p[o]||{c:0,r:0,e:0,d:0};h+=`<tr><td style="text-align:left">${OL[o]}</td><td class="${pm.c?'py':'pn'}">${pm.c?'âœ“':'âœ—'}</td><td class="${pm.r?'py':'pn'}">${pm.r?'âœ“':'âœ—'}</td><td class="${pm.e?'py':'pn'}">${pm.e?'âœ“':'âœ—'}</td><td class="${pm.d?'py':'pn'}">${pm.d?'âœ“':'âœ—'}</td></tr>`});
h+=`</tbody></table></div>`});
h+=`<div class="card"><h3>ãƒ­ãƒ¼ãƒ«éšå±¤</h3><pre style="font-size:12px;line-height:2;padding:12px;background:#f8f8f8;border-radius:4px">ğŸ“Œ CEO
  â”œâ”€â”€ å–¶æ¥­æœ¬éƒ¨é•·
  â”‚   â””â”€â”€ å–¶æ¥­ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ â†’ MR Ã—5
  â”œâ”€â”€ ãƒ¡ãƒ‡ã‚£ã‚«ãƒ«æœ¬éƒ¨é•·
  â”‚   â””â”€â”€ MSLãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ â†’ MSL Ã—3
  â”œâ”€â”€ ãƒ©ãƒœçµ±æ‹¬éƒ¨é•·
  â”‚   â””â”€â”€ ãƒ©ãƒœé•· â†’ æ¤œæŸ»æŠ€å¸«
  â”œâ”€â”€ PMDAæ‹…å½“éƒ¨é•·
  â””â”€â”€ LSIæ‹…å½“</pre></div>`;return h}

// ===== ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç·¨é›† =====
function rEditor(){return`<div class="tab-bar"><div class="tab-btn active" onclick="eTab(this,'yt')">YAML</div><div class="tab-btn" onclick="eTab(this,'xt')">SFDX XML</div></div>
<div id="yt"><textarea class="code" id="yv">apiVersion: "62.0"
objects:
  - apiName: Medical_Institution__c
    label: ææºåŒ»ç™‚æ©Ÿé–¢
    sharingModel: ReadWrite
    deploymentStatus: Deployed
    fields:
      - {apiName: Facility_Type__c, label: æ–½è¨­ç¨®åˆ¥, type: Picklist, values: [å¤§å­¦ç—…é™¢, ãŒã‚“æ‹ ç‚¹ç—…é™¢, ä¸€èˆ¬ç—…é™¢]}
      - {apiName: Adapter_Status__c, label: å°å…¥çŠ¶æ³, type: Picklist, values: [æœªå°å…¥, å°å…¥ä¸­, å°å…¥å®Œäº†]}
      - {apiName: Prefecture__c, label: éƒ½é“åºœçœŒ, type: Text}
  - apiName: Doctor__c
    label: ãƒ‰ã‚¯ã‚¿ãƒ¼ç®¡ç†
    sharingModel: ReadWrite
    deploymentStatus: Deployed
    fields:
      - {apiName: Department__c, label: è¨ºç™‚ç§‘, type: Picklist, values: [è…«ç˜å†…ç§‘, å‘¼å¸å™¨å†…ç§‘, æ¶ˆåŒ–å™¨å†…ç§‘, ä¹³è…ºå¤–ç§‘, ç—…ç†è¨ºæ–­ç§‘]}
      - {apiName: Relationship_Level__c, label: é–¢ä¿‚æ§‹ç¯‰åº¦, type: Picklist, values: [æœªæ¥è§¦, åˆå›é¢è«‡æ¸ˆ, é–¢å¿ƒã‚ã‚Š, æ¤œè¨ä¸­, æ¨é€²è€…, "ãƒ•ã‚¡ãƒ³ï¼ˆKOLï¼‰"]}
      - {apiName: Medical_Institution__c, label: æ‰€å±åŒ»ç™‚æ©Ÿé–¢, type: Lookup, referenceTo: Medical_Institution__c}
  - apiName: Pharma_Opportunity__c
    label: è£½è–¬å•†è«‡
    sharingModel: ReadWrite
    deploymentStatus: Deployed
    fields:
      - {apiName: Phase__c, label: ãƒ•ã‚§ãƒ¼ã‚º, type: Picklist, values: [ãƒªãƒ¼ãƒ‰, ãƒ’ã‚¢ãƒªãƒ³ã‚°, ææ¡ˆ, ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯©æŸ», å¥‘ç´„äº¤æ¸‰, æˆç´„, å¤±æ³¨]}
      - {apiName: Amount__c, label: é‡‘é¡, type: Currency}
      - {apiName: Owner_Name__c, label: æ‹…å½“å–¶æ¥­, type: Text}
  - apiName: MA_Activity__c
    label: MAæ´»å‹•ç®¡ç†
    sharingModel: ReadWrite
    deploymentStatus: Deployed
    fields:
      - {apiName: Activity_Type__c, label: æ´»å‹•ç¨®åˆ¥, type: Picklist, values: [å­¦è¡“è¬›æ¼”ä¼š, ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒªãƒ¼ãƒœãƒ¼ãƒ‰, KOLé¢è«‡, é™¢å†…å‹‰å¼·ä¼š]}
      - {apiName: Status__c, label: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹, type: Picklist, values: [ä¼ç”»ä¸­, æº–å‚™ä¸­, å®Ÿæ–½æ¸ˆ, å®Œäº†]}
      - {apiName: Assigned_MSL__c, label: æ‹…å½“MSL, type: Text}
      - {apiName: Budget__c, label: äºˆç®—, type: Currency}
permissionSets:
  - {apiName: SB_Tempus_Sales, label: å–¶æ¥­æ‹…å½“}
  - {apiName: SB_Tempus_MSL, label: MSL}
  - {apiName: SB_Tempus_Lab_Manager, label: ãƒ©ãƒœç®¡ç†è€…}</textarea>
<div style="margin-top:8px"><button class="btn" onclick="genXML()">SFDX XMLç”Ÿæˆ</button><button class="btn sec" style="margin-left:8px" onclick="expYAML()">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button></div></div>
<div id="xt" style="display:none"><div id="xo" class="xml-view">ã€ŒSFDX XMLç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div></div>`}
function eTab(el,id){document.querySelectorAll('.tab-btn').forEach(t=>t.classList.remove('active'));el.classList.add('active');document.getElementById('yt').style.display=id==='yt'?'':'none';document.getElementById('xt').style.display=id==='xt'?'':'none'}
function genXML(){try{const s=jsyaml.load(document.getElementById('yv').value);let x='';
(s.objects||[]).forEach(obj=>{
x+=`\n${'='.repeat(60)}\nforce-app/main/default/objects/${obj.apiName}/${obj.apiName}.object-meta.xml\n${'='.repeat(60)}\n`;
x+=`<?xml version="1.0" encoding="UTF-8"?>\n<CustomObject xmlns="http://soap.sforce.com/2006/04/metadata">\n`;
x+=`  <label>${obj.label}</label>\n  <sharingModel>${obj.sharingModel||'ReadWrite'}</sharingModel>\n  <deploymentStatus>${obj.deploymentStatus||'Deployed'}</deploymentStatus>\n`;
(obj.fields||[]).forEach(f=>{x+=`  <fields>\n    <fullName>${f.apiName}</fullName>\n    <label>${f.label}</label>\n    <type>${f.type}</type>\n`;
if(f.values){x+=`    <valueSet>\n      <restricted>true</restricted>\n      <valueSetDefinition>\n        <sorted>false</sorted>\n`;f.values.forEach(v=>x+=`        <value><fullName>${v}</fullName><label>${v}</label></value>\n`);x+=`      </valueSetDefinition>\n    </valueSet>\n`}
if(f.referenceTo)x+=`    <referenceTo>${f.referenceTo}</referenceTo>\n    <relationshipName>${f.apiName.replace(/__c$/,'s')}</relationshipName>\n    <deleteConstraint>SetNull</deleteConstraint>\n`;
x+=`  </fields>\n`});x+=`</CustomObject>\n`});
(s.permissionSets||[]).forEach(ps=>{x+=`\n${'='.repeat(60)}\nforce-app/main/default/permissionsets/${ps.apiName}.permissionset-meta.xml\n${'='.repeat(60)}\n`;
x+=`<?xml version="1.0" encoding="UTF-8"?>\n<PermissionSet xmlns="http://soap.sforce.com/2006/04/metadata">\n  <label>${ps.label}</label>\n</PermissionSet>\n`});
document.getElementById('xo').textContent=x;alert('SFDX XMLç”Ÿæˆå®Œäº†ï¼')}catch(e){alert('YAMLè§£æã‚¨ãƒ©ãƒ¼: '+e.message)}}
function expYAML(){const b=new Blob([document.getElementById('yv').value],{type:'text/yaml'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='schema.yaml';a.click()}

// ===== SOQL Console =====
function rSOQL(){return`<div class="card">
<h3>SOQL ã‚¯ã‚¨ãƒª</h3>
<textarea id="soqlInput" style="width:100%;height:100px;padding:12px;font-family:Monaco,Menlo,monospace;font-size:13px;border:1px solid #ccc;border-radius:4px;resize:vertical" placeholder="SELECT Id, Name FROM Account WHERE Industry = 'åŒ»è–¬å“' LIMIT 10">SELECT Id, Name, StageName, Amount FROM Opportunity WHERE StageName = 'Closed Won'</textarea>
<div style="margin-top:8px"><button class="btn" onclick="execSOQL()">å®Ÿè¡Œ</button><span id="soqlTime" style="margin-left:12px;font-size:12px;color:#888"></span></div>
</div><div id="soqlResult"></div>`}
function execSOQL(){
  const q=document.getElementById('soqlInput').value.trim();
  if(!q)return;
  const t0=performance.now();
  fetch('/services/data/v62.0/query/?q='+encodeURIComponent(q))
  .then(r=>r.json()).then(data=>{
    const ms=Math.round(performance.now()-t0);
    document.getElementById('soqlTime').textContent=data.totalSize+' ä»¶ ('+ms+'ms)';
    if(data.errorCode||data[0]?.errorCode){
      document.getElementById('soqlResult').innerHTML='<div class="card" style="color:#c62828">'+JSON.stringify(data,null,2)+'</div>';
      return;
    }
    const recs=data.records||[];
    if(!recs.length){document.getElementById('soqlResult').innerHTML='<div class="card">çµæœãªã—</div>';return}
    const keys=Object.keys(recs[0]).filter(k=>k!=='attributes');
    let h='<div class="card"><table><thead><tr>';
    keys.forEach(k=>h+='<th>'+fl(k)+'</th>');
    h+='</tr></thead><tbody>';
    recs.forEach(r=>{h+='<tr>';keys.forEach(k=>{
      let v=r[k];if(typeof v==='boolean')v=v?'âœ“':'-';
      h+='<td>'+(v!=null?v:'-')+'</td>'});h+='</tr>'});
    h+='</tbody></table></div>';
    document.getElementById('soqlResult').innerHTML=h;
  }).catch(e=>{document.getElementById('soqlResult').innerHTML='<div class="card" style="color:#c62828">Error: '+e.message+'</div>'})
}

// ===== Metadata Management =====
function rMetadata(){return`<div class="card">
<h3>ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
<div class="tab-bar">
<div class="tab-btn active" onclick="metaTab(this,'metaRetrieve')">Retrieve (ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ)</div>
<div class="tab-btn" onclick="metaTab(this,'metaDeploy')">Deploy (ã‚¤ãƒ³ãƒãƒ¼ãƒˆ)</div>
<div class="tab-btn" onclick="metaTab(this,'metaPkg')">package.xml</div>
</div>
<div id="metaRetrieve">
<div style="margin:12px 0"><select id="metaObj"><option value="">å…¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ</option></select>
<select id="metaFmt"><option value="xml">SFDX XML</option><option value="yaml">YAML</option></select>
<button class="btn" onclick="doRetrieve()" style="margin-left:8px">Retrieve</button></div>
<div id="metaOutput" class="xml-view" style="min-height:200px">Retrieveãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
</div>
<div id="metaDeploy" style="display:none">
<p style="font-size:13px;color:#666;margin-bottom:12px">Salesforceã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸCustomObject XMLã‚’è²¼ã‚Šä»˜ã‘ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™</p>
<textarea id="deployXml" style="width:100%;height:300px;padding:12px;font-family:Monaco,Menlo,monospace;font-size:12px;border:1px solid #ccc;border-radius:4px;resize:vertical" placeholder="<?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?>&#10;<CustomObject xmlns=&quot;http://soap.sforce.com/2006/04/metadata&quot;>&#10;  ...&#10;</CustomObject>"></textarea>
<button class="btn" onclick="doDeploy()" style="margin-top:8px">Deploy</button>
<div id="deployResult" style="margin-top:8px"></div>
</div>
<div id="metaPkg" style="display:none"><div id="pkgOutput" class="xml-view" style="min-height:200px">èª­ã¿è¾¼ã¿ä¸­...</div></div>
</div>`}
function metaTab(el,id){
  document.querySelectorAll('.tab-btn').forEach(t=>t.classList.remove('active'));el.classList.add('active');
  ['metaRetrieve','metaDeploy','metaPkg'].forEach(t=>{document.getElementById(t).style.display=t===id?'':'none'});
  if(id==='metaPkg')loadPkgXml();
  if(id==='metaRetrieve'){const sel=document.getElementById('metaObj');if(sel.options.length<=1){Object.keys(OL).forEach(k=>{const o=document.createElement('option');o.value=k;o.textContent=OL[k]+' ('+k+')';sel.appendChild(o)})}}
}
function doRetrieve(){
  const obj=document.getElementById('metaObj').value;
  const f=document.getElementById('metaFmt').value;
  let url='/services/data/v62.0/metadata/retrieve/?format='+f;
  if(obj)url+='&objectName='+obj;
  fetch(url).then(r=>r.text()).then(t=>{document.getElementById('metaOutput').textContent=t}).catch(e=>{document.getElementById('metaOutput').textContent='Error: '+e.message})
}
function doDeploy(){
  const xml=document.getElementById('deployXml').value.trim();
  if(!xml){toast('XMLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','error');return}
  fetch('/services/data/v62.0/metadata/deploy/',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({xmlContent:xml})})
  .then(r=>r.json()).then(res=>{
    if(res.success){document.getElementById('deployResult').innerHTML='<div style="color:#2e7d32;font-weight:600">DeployæˆåŠŸ: '+res.numberComponentsDeployed+'ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ</div>';toast('Deployå®Œäº†')}
    else{document.getElementById('deployResult').innerHTML='<div style="color:#c62828">Deployå¤±æ•—: '+(res.errorMessage||'')+'</div>';toast('Deployå¤±æ•—','error')}
  }).catch(e=>{toast(e.message,'error')})
}
function loadPkgXml(){
  fetch('/services/data/v62.0/metadata/package.xml').then(r=>r.text()).then(t=>{document.getElementById('pkgOutput').textContent=t}).catch(e=>{document.getElementById('pkgOutput').textContent='Error: '+e.message})
}

// ===== Picklist values =====
const PV={
Facility_Type__c:['å¤§å­¦ç—…é™¢','ãŒã‚“æ‹ ç‚¹ç—…é™¢','ä¸€èˆ¬ç—…é™¢'],
Adapter_Status__c:['æœªå°å…¥','å°å…¥ä¸­','å°å…¥å®Œäº†'],
Prefecture__c:['åŒ—æµ·é“','é’æ£®çœŒ','å²©æ‰‹çœŒ','å®®åŸçœŒ','ç§‹ç”°çœŒ','å±±å½¢çœŒ','ç¦å³¶çœŒ','èŒ¨åŸçœŒ','æ ƒæœ¨çœŒ','ç¾¤é¦¬çœŒ','åŸ¼ç‰çœŒ','åƒè‘‰çœŒ','æ±äº¬éƒ½','ç¥å¥ˆå·çœŒ','æ–°æ½ŸçœŒ','å¯Œå±±çœŒ','çŸ³å·çœŒ','ç¦äº•çœŒ','å±±æ¢¨çœŒ','é•·é‡çœŒ','å²é˜œçœŒ','é™å²¡çœŒ','æ„›çŸ¥çœŒ','ä¸‰é‡çœŒ','æ»‹è³€çœŒ','äº¬éƒ½åºœ','å¤§é˜ªåºœ','å…µåº«çœŒ','å¥ˆè‰¯çœŒ','å’Œæ­Œå±±çœŒ','é³¥å–çœŒ','å³¶æ ¹çœŒ','å²¡å±±çœŒ','åºƒå³¶çœŒ','å±±å£çœŒ','å¾³å³¶çœŒ','é¦™å·çœŒ','æ„›åª›çœŒ','é«˜çŸ¥çœŒ','ç¦å²¡çœŒ','ä½è³€çœŒ','é•·å´çœŒ','ç†Šæœ¬çœŒ','å¤§åˆ†çœŒ','å®®å´çœŒ','é¹¿å…å³¶çœŒ','æ²–ç¸„çœŒ'],
Department__c:['è…«ç˜å†…ç§‘','å‘¼å¸å™¨å†…ç§‘','æ¶ˆåŒ–å™¨å†…ç§‘','ä¹³è…ºå¤–ç§‘','ç—…ç†è¨ºæ–­ç§‘'],
Title__c:['æ•™æˆ','å‡†æ•™æˆ','è¬›å¸«','éƒ¨é•·','åŒ»é•·','åŒ»å“¡'],
Relationship_Level__c:['æœªæ¥è§¦','åˆå›é¢è«‡æ¸ˆ','é–¢å¿ƒã‚ã‚Š','æ¤œè¨ä¸­','æ¨é€²è€…','ãƒ•ã‚¡ãƒ³ï¼ˆKOLï¼‰'],
Phase__c:['ãƒªãƒ¼ãƒ‰','ãƒ’ã‚¢ãƒªãƒ³ã‚°','ææ¡ˆ','ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯©æŸ»','å¥‘ç´„äº¤æ¸‰','æˆç´„','å¤±æ³¨'],
Status__c:['ä¼ç”»ä¸­','æº–å‚™ä¸­','å®Ÿæ–½æ¸ˆ','å®Œäº†','æ¤œä½“å¾…ã¡','è§£æä¸­','ãƒ¬ãƒãƒ¼ãƒˆä½œæˆä¸­','ãƒ¬ãƒãƒ¼ãƒˆå®Œäº†','ç´å“æ¸ˆ','ç™ºæ³¨å‰','ç™ºæ³¨æ¸ˆ','é…é”æ¸ˆ'],
Specimen_Status__c:['å—é ˜å¾…ã¡','å—é ˜æ¸ˆ','QCä¸­','QCåˆæ ¼','QCä¸åˆæ ¼','è§£æä¸­','è§£æå®Œäº†','ãƒ¬ãƒãƒ¼ãƒˆç™ºè¡Œæ¸ˆ'],
Cancer_Type__c:['è‚ºãŒã‚“','ä¹³ãŒã‚“','å¤§è…¸ãŒã‚“','èƒƒãŒã‚“','è†µè‡“ãŒã‚“','å‰ç«‹è…ºãŒã‚“','åµå·£ãŒã‚“','è‚è‡“ãŒã‚“'],
Meeting_Result__c:['å¥½æ„Ÿè§¦','ç¶™ç¶šæ¤œè¨','ä¿ç•™','å†è¨ªå•è¦'],
Visit_Purpose__c:['å®šæœŸè¨ªå•','æ–°è¦ç´¹ä»‹','æƒ…å ±æä¾›','ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—','å¥‘ç´„ç¢ºèª'],
Activity_Type__c:['å­¦è¡“è¬›æ¼”ä¼š','ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒªãƒ¼ãƒœãƒ¼ãƒ‰','KOLé¢è«‡','é™¢å†…å‹‰å¼·ä¼š'],
Event_Format__c:['ã‚ªãƒ³ã‚µã‚¤ãƒˆ','ã‚ªãƒ³ãƒ©ã‚¤ãƒ³','ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰'],
Progress_Status__c:['ä¼ç”»ç«‹æ¡ˆ','è¬›å¸«ç¢ºå®š','æº–å‚™ä¸­','é–‹å‚¬æ¸ˆ'],
Analysis_Panel__c:['F1CDx','NCC-OncoPanel','FoundationOne Liquid'],
Operation_Status__c:['é€šå¸¸ç¨¼åƒ','é«˜è² è·','ç«‹ã¡ä¸Šã’ä¸­','ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸­'],
Lab_Type__c:['è§£æãƒ©ãƒœ','ãƒã‚¤ã‚ªãƒãƒ³ã‚¯','ç ”ç©¶ãƒ©ãƒœ'],
Compliance_Check__c:['æ‰¿èªæ¸ˆ','ç¢ºèªä¸­','æœªç¢ºèª'],
Service_Type__c:['XT(çµ„ç¹”)','xF(ãƒªã‚­ãƒƒãƒ‰)','xT+xF','ãƒ‡ãƒ¼ã‚¿è§£æã®ã¿'],
Menu_Type__c:['å¹•ã®å†…','æ¾èŠ±å ‚','ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒ','ãƒ™ã‚¸ã‚¿ãƒªã‚¢ãƒ³','ç‰¹åˆ¥é£Ÿ'],
Attendance_Status__c:['ç™»éŒ²æ¸ˆ','å‡ºå¸­ç¢ºèª','å‡ºå¸­','æ¬ å¸­','ã‚­ãƒ£ãƒ³ã‚»ãƒ«'],
Specialty__c:['è…«ç˜å†…ç§‘','å‘¼å¸å™¨å†…ç§‘','æ¶ˆåŒ–å™¨å†…ç§‘','ä¹³è…ºå¤–ç§‘','ç—…ç†è¨ºæ–­ç§‘','æ³Œå°¿å™¨ç§‘','å©¦äººç§‘'],
StageName:['Prospecting','Qualification','Needs Analysis','Value Proposition','Negotiation/Review','Closed Won','Closed Lost'],
Type:['æ–°è¦','æ—¢å­˜','æ›´æ–°','é¡§å®¢','è¦‹è¾¼ã¿å®¢','ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼','ç«¶åˆä»–ç¤¾','ãã®ä»–'],
Industry:['åŒ»è–¬å“','åŒ»ç™‚æ©Ÿå™¨','IT','è£½é€ æ¥­','é‡‘è','å°å£²','æ•™è‚²','ãã®ä»–'],
LeadSource:['Web','é›»è©±','ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼','å±•ç¤ºä¼š','åºƒå‘Š','ç´¹ä»‹','ãã®ä»–'],
ForecastCategory:['Pipeline','Best Case','Commit','Closed','Omitted'],
Status:['æ–°è¦','é€£çµ¡æ¸ˆ','é©æ ¼','ä¸é©æ ¼','è»¢æ›æ¸ˆ','è¨ˆç”»ä¸­','é€²è¡Œä¸­','å®Œäº†','ä¸­æ­¢','ãƒ‰ãƒ©ãƒ•ãƒˆ','æ‰¿èªãƒ—ãƒ­ã‚»ã‚¹ä¸­','æœ‰åŠ¹','çµ‚äº†','ã‚­ãƒ£ãƒ³ã‚»ãƒ«','é€ä¿¡æ¸ˆ','å¿œç­”æ¸ˆ','å‡ºå¸­','æ¬ å¸­','ãƒ‰ãƒ©ãƒ•ãƒˆ','é€ä»˜æ¸ˆ','å—è«¾','æ‹’å¦','æœªç€æ‰‹','é€²è¡Œä¸­','å®Œäº†','å¾…æ©Ÿä¸­','å»¶æœŸ'],
Priority:['é«˜','ä¸­','ä½'],
Origin:['é›»è©±','ãƒ¡ãƒ¼ãƒ«','Web'],
Role:['æ„æ€æ±ºå®šè€…','è©•ä¾¡è€…','çµŒæ¸ˆçš„è³¼å…¥è€…','æŠ€è¡“çš„è³¼å…¥è€…','ãã®ä»–'],
Family:['ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢','ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢','ã‚µãƒ¼ãƒ“ã‚¹','ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³']
};
const NUM_FIELDS=['Bed_Count__c','Amount__c','Budget__c','Probability__c','Visit_Count__c','Referred_Specimen_Count__c','KOL_Score__c','Sample_Count__c','Participant_Count__c','Attendee_Count__c','Speaker_Fee__c','Operation_Cost__c','Monthly_Capacity__c','Current_Processing__c','Amount','Quantity','UnitPrice','TotalPrice','Discount','Tax','Subtotal','GrandTotal','BudgetedCost','ActualCost','ExpectedRevenue','NumberOfEmployees','AnnualRevenue','ContractTerm','ContentSize','Probability','Quantity__c','Venue_Latitude__c','Venue_Longitude__c'];
const BOOL_FIELDS=['Is_KOL__c','Is_Retest__c','IsActive','IsClosed','IsConverted','IsHighPriority','IsPrimary','IsAllDayEvent','IsStandard','UseStandardPrice','IsEscalated'];
const DATE_FIELDS=['Contract_Start_Date__c','Visit_Date__c','Activity_Date__c','Event_Date__c','Received_Date__c','CloseDate','StartDate','EndDate','ActivityDate','ExpirationDate','EffectiveDate','Birthdate','ServiceDate','Order_Date__c','Registration_Date__c'];

function toast(msg,type){const t=document.createElement('div');t.className='toast '+(type||'success');t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),3000)}

const LOOKUP_REFS={Medical_Institution__c:'Medical_Institution__c',Doctor__c:'Doctor__c',Seminar__c:'Seminar__c',AccountId:'Account',ContactId:'Contact',OpportunityId:'Opportunity',CampaignId:'Campaign',Product2Id:'Product2',OwnerId:'User',WhoId:'Contact',WhatId:'Account',ParentId:'Account',Specimen__c:'Specimen__c',Lab__c:'Lab__c'};
function fieldInput(k,v){
if(BOOL_FIELDS.includes(k))return`<select name="${k}"><option value="true" ${v?'selected':''}>ã¯ã„</option><option value="false" ${!v?'selected':''}>ã„ã„ãˆ</option></select>`;
if(PV[k]){let h=`<select name="${k}"><option value="">--</option>`;PV[k].forEach(o=>h+=`<option ${v===o?'selected':''}>${o}</option>`);return h+'</select>'}
if(LOOKUP_REFS[k]){const refObj=LOOKUP_REFS[k];const uid='lu_'+k+'_'+Date.now();let h=`<select name="${k}" id="${uid}"><option value="">-- é¸æŠ --</option>`;
// Load options from lookup endpoint asynchronously
const recs=D[refObj]||[];recs.forEach(r=>{const rName=r.Name||r.LastName||r.Subject||r.Username||r.Id;h+=`<option value="${r.Id}" ${r.Id===v?'selected':''}>${rName}</option>`});
setTimeout(()=>{fetch('/api/data/'+refObj+'/lookup?limit=500').then(r=>r.json()).then(resp=>{const sel=document.getElementById(uid);if(!sel)return;const existing=new Set();sel.querySelectorAll('option').forEach(o=>existing.add(o.value));(resp.records||[]).forEach(r=>{if(!existing.has(r.Id)){const opt=document.createElement('option');opt.value=r.Id;opt.textContent=r.Name;if(r.Id===v)opt.selected=true;sel.appendChild(opt)}})}).catch(()=>{})},0);
return h+'</select>'}
if(DATE_FIELDS.includes(k))return`<input type="date" name="${k}" value="${v||''}">`;
if(NUM_FIELDS.includes(k))return`<input type="number" name="${k}" value="${v!=null?v:''}">`;
return`<input type="text" name="${k}" value="${v!=null?String(v).replace(/"/g,'&quot;'):''}">`
}

function buildForm(obj,rec,defaults){
var keys=rec?Object.keys(rec).filter(k=>k!=='Id'):Object.keys((D[obj]&&D[obj][0])||{}).filter(k=>k!=='Id');
if(!keys.length&&OK[obj])keys=OK[obj];
let h='';
keys.forEach(k=>{var v=rec?rec[k]:(defaults&&defaults[k]!=null?defaults[k]:null);h+=`<div class="form-group"><label>${fl(k)}</label>${fieldInput(k,v)}</div>`});
return h
}

function getFormData(form){
const fd={};form.querySelectorAll('input,select,textarea').forEach(el=>{
const k=el.name;if(!k)return;let v=el.value;
if(BOOL_FIELDS.includes(k))v=v==='true';
else if(NUM_FIELDS.includes(k))v=v?Number(v):null;
else if(v==='')v=null;
fd[k]=v});return fd}

function closeModal(){const m=document.getElementById('modal');if(m)m.remove()}

function openNew(obj,defaults){
const m=document.createElement('div');m.className='modal-overlay';m.id='modal';
const formH=buildForm(obj,null,defaults);
m.innerHTML='<div class="modal"><div class="modal-hdr"><h3>'+(OL[obj]||obj)+' - æ–°è¦ä½œæˆ</h3><button class="btn sm sec" id="modalClose">âœ•</button></div><form id="recForm"><div class="modal-body">'+formH+'</div><div class="modal-footer"><button type="button" class="btn sec" id="modalCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button type="submit" class="btn">ä¿å­˜</button></div></form></div>';
document.body.appendChild(m);
document.getElementById('modalClose').addEventListener('click',closeModal);
document.getElementById('modalCancel').addEventListener('click',closeModal);
m.querySelector('form').addEventListener('submit',function(e){e.preventDefault();doSaveNew(obj)})
}

function doSaveNew(obj){
const fd=getFormData(document.getElementById('recForm'));
if(!fd.Name&&!fd.LastName&&!fd.Subject){toast('åå‰ã¯å¿…é ˆã§ã™','error');return}
fetch('/api/data/'+obj,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(fd)})
.then(function(r){if(!r.ok)throw new Error('ä½œæˆã«å¤±æ•—');return r.json()})
.then(async function(res){
  closeModal();toast((OL[obj]||obj)+'ã‚’ä½œæˆã—ã¾ã—ãŸ');
  await loadPage(obj,1);nav('obj',obj);
}).catch(function(e){toast(e.message,'error')})
}

function doSaveEdit(){
if(!cr||!co){console.error('doSaveEdit: cr or co is null',cr,co);return}
var grid=document.getElementById('detGrid');
if(!grid){console.error('doSaveEdit: detGrid not found');toast('ãƒ•ã‚©ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“','error');return}
var fd=getFormData(grid);
fetch('/api/data/'+co+'/'+cr.Id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(fd)})
.then(function(r){
  if(!r.ok)return r.json().then(function(b){throw new Error(b.error||'æ›´æ–°ã«å¤±æ•— ('+r.status+')')});
  return r.json()
})
.then(async function(resp){
  // Update current record from server response
  if(resp.record)cr=resp.record;
  else{for(var k in fd)cr[k]=fd[k]}
  isEditing=false;toast('æ›´æ–°ã—ã¾ã—ãŸ');R()
}).catch(function(e){console.error('doSaveEdit error:',e);toast(e.message,'error')})
}

function doDelete(){
if(!cr||!co)return;
if(!confirm((cr.Name||cr.Subject||cr.LastName||'ã“ã®ãƒ¬ã‚³ãƒ¼ãƒ‰')+' ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
fetch('/api/data/'+co+'/'+cr.Id,{method:'DELETE'})
.then(function(r){if(!r.ok)throw new Error('å‰Šé™¤ã«å¤±æ•—');return r.json()})
.then(async function(){
  isEditing=false;toast('å‰Šé™¤ã—ã¾ã—ãŸ');
  await loadPage(co,(pageState[co]||{}).page||1);nav('obj',co);
}).catch(function(e){toast(e.message,'error')})
}

// ===== ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ =====
function rExecDash(){
const opps=D.Pharma_Opportunity__c||[],tos=D.Testing_Order__c||[],specs=D.Specimen__c||[],insts=D.Medical_Institution__c||[],labs=D.Lab__c||[];
const pipe=opps.filter(o=>!['æˆç´„','å¤±æ³¨'].includes(o.Phase__c)).reduce((s,o)=>s+(o.Amount__c||0),0);
const won=opps.filter(o=>o.Phase__c==='æˆç´„').reduce((s,o)=>s+(o.Amount__c||0),0);
const adopted=insts.filter(i=>i.Adapter_Status__c==='å°å…¥å®Œäº†').length;
const avgUtil=labs.length?Math.round(labs.reduce((s,l)=>s+(l.Current_Processing__c||0),0)/labs.reduce((s,l)=>s+(l.Monthly_Capacity__c||1),0)*100):0;
return`<div class="grid grid-4" style="margin-bottom:20px">
<div class="kpi-card" onclick="nav('obj','Pharma_Opportunity__c')"><div class="kv">${fmt(pipe)}</div><div class="kl">ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³é‡‘é¡</div></div>
<div class="kpi-card" onclick="nav('obj','Pharma_Opportunity__c')"><div class="kv">${fmt(won)}</div><div class="kl">æˆç´„é‡‘é¡</div></div>
<div class="kpi-card" onclick="nav('obj','Medical_Institution__c')"><div class="kv">${adopted}/${insts.length}</div><div class="kl">å°å…¥æ¸ˆã¿æ–½è¨­</div></div>
<div class="kpi-card" onclick="nav('obj','Lab__c')"><div class="kv">${avgUtil}%</div><div class="kl">å¹³å‡ãƒ©ãƒœç¨¼åƒç‡</div></div>
</div><div class="grid grid-2">
<div class="chart-box"><h4>æœˆæ¬¡æ¤œæŸ»ãƒœãƒªãƒ¥ãƒ¼ãƒ æ¨ç§»</h4><canvas id="exec-testing"></canvas></div>
<div class="chart-box"><h4>ã‚µãƒ¼ãƒ“ã‚¹åˆ¥ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³</h4><canvas id="exec-service"></canvas></div>
</div>
<div class="card"><h3>ãƒãƒ¼ãƒ æˆç¸¾</h3><table><thead><tr><th>æ‹…å½“è€…</th><th>å½¹å‰²</th><th>ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³</th><th>æˆç´„é‡‘é¡</th><th>æ‹…å½“Dr</th></tr></thead><tbody>`+
USERS.filter(u=>['Sales','MA'].includes(u.team)).map(u=>{
const uOpps=opps.filter(o=>o.Owner_Name__c===u.name);
const uPipe=uOpps.filter(o=>!['æˆç´„','å¤±æ³¨'].includes(o.Phase__c)).reduce((s,o)=>s+(o.Amount__c||0),0);
const uWon=uOpps.filter(o=>o.Phase__c==='æˆç´„').reduce((s,o)=>s+(o.Amount__c||0),0);
const uDocs=(D.Doctor__c||[]).filter(d=>d.Assigned_MR__c===u.name).length;
return`<tr><td>${u.photo} ${u.name}</td><td>${u.role}</td><td>${fmt(uPipe)}</td><td>${fmt(uWon)}</td><td>${uDocs}</td></tr>`}).join('')+
`</tbody></table></div>`}
function iExecDash(){
const mtd=MONTHLY_TESTING_DATA;
mc('exec-testing',{type:'bar',data:{labels:mtd.map(m=>m.month.slice(5)+'æœˆ'),datasets:[{label:'å‡ºä»¶æ•°',data:mtd.map(m=>m.orders),backgroundColor:'#0176d3'},{label:'å®Œäº†æ•°',data:mtd.map(m=>m.completed),backgroundColor:'#2ecc71'}]},options:{responsive:true,plugins:{legend:{position:'top'}}}},'obj:Testing_Order__c');
const svcs=[...new Set((D.Pharma_Opportunity__c||[]).map(o=>o.Service_Type__c).filter(Boolean))];
mc('exec-service',{type:'doughnut',data:{labels:svcs.length?svcs:['ãƒ‡ãƒ¼ã‚¿ãªã—'],datasets:[{data:svcs.length?svcs.map(s=>(D.Pharma_Opportunity__c||[]).filter(o=>o.Service_Type__c===s).reduce((sum,o)=>sum+(o.Amount__c||0),0)):[1],backgroundColor:CL}]},options:{responsive:true,plugins:{legend:{position:'right'}}}},'obj:Pharma_Opportunity__c')}

// ===== MSLãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ =====
function rMSLDash(){
const maUsers=USERS.filter(u=>u.team==='MA');
let h='<div style="margin-bottom:16px"><select id="mslSelect" onchange="showMSL(this.value)" style="padding:8px 12px;border:1px solid #d8dde6;border-radius:6px;font-size:14px">';
maUsers.forEach((u,i)=>h+=`<option value="${u.name}"${i===0?' selected':''}>${u.photo} ${u.name} (${u.role})</option>`);
h+='</select></div><div id="mslContent"></div>';
return h}
function bMSLDash(){const maUsers=USERS.filter(u=>u.team==='MA');if(maUsers.length)showMSL(maUsers[0].name)}
function showMSL(name){
const ma=(D.MA_Activity__c||[]).filter(a=>a.Assigned_MSL__c===name);
const docs=(D.Doctor__c||[]).filter(d=>d.Is_KOL__c);
const vts=(D.Visit_Target__c||[]).filter(v=>{const u=USERS.find(u=>u.name===name);return u&&v.OwnerId===u.id});
const jr=(D.Joint_Research__c||[]);
const achieved=vts.filter(v=>v.Status__c==='é”æˆ').length;
const achRate=vts.length?pct(achieved,vts.length):0;
let h=`<div class="grid grid-6" style="margin-bottom:20px">
<div class="kpi-card" onclick="nav('obj','Doctor__c')"><div class="kv">${docs.length}</div><div class="kl">æ‹…å½“KOL</div></div>
<div class="kpi-card" onclick="nav('obj','MA_Activity__c')"><div class="kv">${ma.length}</div><div class="kl">MAæ´»å‹•</div></div>
<div class="kpi-card" onclick="nav('visit-target')"><div class="kv">${vts.length}</div><div class="kl">è¨ªå•ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ</div></div>
<div class="kpi-card" onclick="nav('visit-target')"><div class="kv">${achRate}%</div><div class="kl">é”æˆç‡</div></div>
<div class="kpi-card" onclick="nav('obj','Joint_Research__c')"><div class="kv">${jr.length}</div><div class="kl">å…±åŒç ”ç©¶</div></div>
<div class="kpi-card" onclick="nav('daily-report')"><div class="kv">${(D.Daily_Report__c||[]).filter(r=>{const u=USERS.find(u=>u.name===name);return u&&r.OwnerId===u.id&&r.Approval_Status__c==='æå‡ºæ¸ˆ'}).length}</div><div class="kl">æœªæ‰¿èªæ—¥å ±</div></div>
</div>`;
if(vts.length){h+=`<div class="card"><h3>è¨ªå•ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ</h3><table><thead><tr><th>ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ</th><th>ãƒ‰ã‚¯ã‚¿ãƒ¼</th><th>ç›®æ¨™</th><th>å®Ÿç¸¾</th><th>é”æˆç‡</th><th>çŠ¶æ…‹</th></tr></thead><tbody>`;
vts.forEach(v=>h+=`<tr><td>${v.Name}</td><td>${dn(v.Doctor__c)}</td><td>${v.Target_Visits__c}</td><td>${v.Actual_Visits__c}</td><td>${v.Achievement_Rate__c||0}%</td><td><span class="sb ${sc(v.Status__c)}">${v.Status__c}</span></td></tr>`);
h+=`</tbody></table></div>`}
h+=`<div class="card"><h3>MAæ´»å‹• (${ma.length}ä»¶)</h3><table><thead><tr><th>æ´»å‹•å</th><th>ç¨®åˆ¥</th><th>å®Ÿæ–½æ—¥</th><th>ãƒ‰ã‚¯ã‚¿ãƒ¼</th><th>çŠ¶æ…‹</th></tr></thead><tbody>`;
ma.sort((a,b)=>(b.Activity_Date__c||'').localeCompare(a.Activity_Date__c||'')).forEach(a=>h+=`<tr onclick="sd('MA_Activity__c','${a.Id}')"><td>${a.Name}</td><td>${a.Activity_Type__c||'-'}</td><td>${a.Activity_Date__c||'-'}</td><td>${dn(a.Doctor__c)}</td><td><span class="sb ${sc(a.Status__c)}">${a.Status__c||'-'}</span></td></tr>`);
h+=`</tbody></table></div>`;
document.getElementById('mslContent').innerHTML=h}

// ===== ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ =====
function rCompDash(){
const ma=D.MA_Activity__c||[],sems=D.Seminar__c||[],ars=D.Approval_Request__c||[],exps=D.Expense_Report__c||[];
const approved=ars.filter(a=>a.Status__c==='æ‰¿èªæ¸ˆ').length;
const compRate=ars.length?pct(approved,ars.length):0;
const pending=ars.filter(a=>['ç”³è«‹ä¸­','æ‰¿èªå¾…ã¡'].includes(a.Status__c)).length;
const unapproved=exps.filter(e=>e.Status__c==='ç”³è«‹ä¸­').length;
const highSem=sems.filter(s=>(s.Speaker_Fee__c||0)+(s.Operation_Cost__c||0)>500000).length;
let h=`<div class="grid grid-4" style="margin-bottom:20px">
<div class="kpi-card" onclick="nav('approval-queue')"><div class="kv">${compRate}%</div><div class="kl">æ‰¿èªå®Œäº†ç‡</div></div>
<div class="kpi-card" onclick="nav('approval-queue')"><div class="kv">${pending}</div><div class="kl">æœªå‡¦ç†æ‰¿èª</div></div>
<div class="kpi-card" onclick="nav('expense-report')"><div class="kv">${unapproved}</div><div class="kl">æœªæ‰¿èªçµŒè²»</div></div>
<div class="kpi-card" onclick="nav('obj','Seminar__c')"><div class="kv">${highSem}</div><div class="kl">é«˜é¡å‹‰å¼·ä¼š</div></div>
</div>`;
h+=`<div class="card"><h3>ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h3><div style="padding:16px">`;
const checks=[
{item:'è¬›æ¼”è¬é‡‘ä¸Šé™ï¼ˆ30ä¸‡å††/å›ï¼‰',ok:true,detail:'å…¨æ¡ˆä»¶ã§ä¸Šé™å†…'},
{item:'ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒªãƒ¼ãƒœãƒ¼ãƒ‰è¬é‡‘ä¸Šé™ï¼ˆ20ä¸‡å††/äººï¼‰',ok:true,detail:'ç›´è¿‘4ä»¶ç¢ºèªæ¸ˆã¿'},
{item:'ã‚±ãƒ¼ã‚¿ãƒªãƒ³ã‚°ä¸Šé™ï¼ˆ5,000å††/äººï¼‰',ok:true,detail:'å¼å½“æ‰‹é…ã®å…¨ä»¶ãŒåŸºæº–å†…'},
{item:'ä¼šå ´é©æ­£æ€§',ok:true,detail:'è¯ç¾ãªä¼šå ´ä½¿ç”¨ãªã—'},
{item:'é€æ˜æ€§ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³',ok:ma.filter(a=>a.Compliance_Check__c==='åˆæ ¼').length>=ma.filter(a=>a.Compliance_Check__c).length*0.8,detail:'MAæ´»å‹•ã®é€æ˜æ€§å ±å‘Š'},
{item:'COIç®¡ç†',ok:true,detail:'åˆ©ç›Šç›¸åç®¡ç†ã®ç¢ºèª'}];
checks.forEach(c=>h+=`<div style="display:flex;align-items:center;padding:10px 0;border-bottom:1px solid #eee"><span style="font-size:20px;margin-right:12px">${c.ok?'âœ…':'âš ï¸'}</span><div><div style="font-weight:600">${c.item}</div><div style="color:#888;font-size:12px">${c.detail}</div></div></div>`);
h+=`</div></div>`;
const highApprovals=ars.filter(a=>a.Amount__c>=500000);
if(highApprovals.length){h+=`<div class="card"><h3>é«˜é¡æ‰¿èªæ¡ˆä»¶ï¼ˆ50ä¸‡å††ä»¥ä¸Šï¼‰</h3><table><thead><tr><th>ç”³è«‹å</th><th>ç¨®åˆ¥</th><th>é‡‘é¡</th><th>ç”³è«‹è€…</th><th>çŠ¶æ…‹</th></tr></thead><tbody>`;
highApprovals.forEach(a=>h+=`<tr><td>${a.Name}</td><td>${a.Request_Type__c}</td><td>Â¥${(a.Amount__c||0).toLocaleString()}</td><td>${userName(a.Requested_By__c)}</td><td><span class="sb ${sc(a.Status__c)}">${a.Status__c}</span></td></tr>`);
h+=`</tbody></table></div>`}
return h}

// ===== æ—¥å ±ç®¡ç† =====
function rDailyRep(){
const reps=D.Daily_Report__c||[];
const submitted=reps.filter(r=>r.Approval_Status__c==='æå‡ºæ¸ˆ').length;
const approved=reps.filter(r=>r.Approval_Status__c==='æ‰¿èªæ¸ˆ').length;
const draft=reps.filter(r=>r.Approval_Status__c==='ä¸‹æ›¸ã').length;
const rejected=reps.filter(r=>r.Approval_Status__c==='å·®æˆ»ã—').length;
let h=`<div class="grid grid-5" style="margin-bottom:20px">
<div class="kpi-card" onclick="nav('obj','Daily_Report__c')"><div class="kv">${reps.length}</div><div class="kl">æ—¥å ±ç·æ•°</div></div>
<div class="kpi-card" onclick="nav('obj','Daily_Report__c')"><div class="kv">${submitted}</div><div class="kl">æå‡ºæ¸ˆ</div></div>
<div class="kpi-card" onclick="nav('obj','Daily_Report__c')"><div class="kv">${approved}</div><div class="kl">æ‰¿èªæ¸ˆ</div></div>
<div class="kpi-card" onclick="nav('obj','Daily_Report__c')"><div class="kv">${draft}</div><div class="kl">ä¸‹æ›¸ã</div></div>
<div class="kpi-card" onclick="nav('obj','Daily_Report__c')"><div class="kv">${rejected}</div><div class="kl">å·®æˆ»ã—</div></div>
</div>`;
const pending=reps.filter(r=>r.Approval_Status__c==='æå‡ºæ¸ˆ');
if(pending.length){h+=`<div class="card"><h3>æ‰¿èªå¾…ã¡æ—¥å ±</h3><table><thead><tr><th>æ—¥ä»˜</th><th>å ±å‘Šè€…</th><th>ç¨®åˆ¥</th><th>è¨ªå•æ•°</th><th>çŠ¶æ…‹</th></tr></thead><tbody>`;
pending.forEach(r=>h+=`<tr onclick="sd('Daily_Report__c','${r.Id}')"><td>${r.Report_Date__c}</td><td>${userName(r.OwnerId)}</td><td>${r.Report_Type__c}</td><td>${r.Visit_Summary__c||0}</td><td><span class="sb ${sc(r.Approval_Status__c)}">${r.Approval_Status__c}</span></td></tr>`);
h+=`</tbody></table></div>`}
h+=`<div class="card"><h3>æ—¥å ±ä¸€è¦§</h3><table><thead><tr><th>ç•ªå·</th><th>æ—¥ä»˜</th><th>å ±å‘Šè€…</th><th>ç¨®åˆ¥</th><th>è¨ªå•æ•°</th><th>çŠ¶æ…‹</th></tr></thead><tbody>`;
reps.sort((a,b)=>(b.Report_Date__c||'').localeCompare(a.Report_Date__c||'')).forEach(r=>h+=`<tr onclick="sd('Daily_Report__c','${r.Id}')"><td>${r.Name}</td><td>${r.Report_Date__c}</td><td>${userName(r.OwnerId)}</td><td>${r.Report_Type__c}</td><td>${r.Visit_Summary__c||0}</td><td><span class="sb ${sc(r.Approval_Status__c)}">${r.Approval_Status__c}</span></td></tr>`);
h+=`</tbody></table></div>`;
return h}

// ===== æ¤œæŸ»ãƒ¬ãƒãƒ¼ãƒˆ =====
function rTestRep(){
const tos=D.Testing_Order__c||[],specs=D.Specimen__c||[],insts=D.Medical_Institution__c||[];
return`<div class="grid grid-2" style="margin-bottom:20px">
<div class="chart-box"><h4>æœˆæ¬¡ã‚ªãƒ¼ãƒ€ãƒ¼æ¨ç§»</h4><canvas id="rpt-monthly"></canvas></div>
<div class="chart-box"><h4>å¹³å‡TATæ¨ç§»</h4><canvas id="rpt-tat"></canvas></div>
</div>
<div class="card"><h3>æ–½è¨­åˆ¥ã‚¯ãƒ­ã‚¹é›†è¨ˆ</h3><table><thead><tr><th>æ–½è¨­</th><th>ã‚ªãƒ¼ãƒ€ãƒ¼æ•°</th><th>å®Œäº†</th><th>é€²è¡Œä¸­</th><th>å¹³å‡TAT</th></tr></thead><tbody>`+
insts.map(inst=>{
const iOrders=tos.filter(t=>t.Institution__c===inst.Id);
const completed=iOrders.filter(t=>t.Status__c==='å®Œäº†');
const inProgress=iOrders.filter(t=>!['å®Œäº†','ã‚­ãƒ£ãƒ³ã‚»ãƒ«'].includes(t.Status__c));
const avgTAT=completed.length?Math.round(completed.reduce((s,t)=>s+(t.TAT_Days__c||0),0)/completed.length):'-';
return iOrders.length?`<tr><td>${inst.Name}</td><td>${iOrders.length}</td><td>${completed.length}</td><td>${inProgress.length}</td><td>${avgTAT}æ—¥</td></tr>`:''}).join('')+
`</tbody></table></div>
<div class="card"><h3>ãŒã‚“ç¨®åˆ¥ã‚¯ãƒ­ã‚¹é›†è¨ˆ</h3><table><thead><tr><th>ãŒã‚“ç¨®</th><th>æ¤œä½“æ•°</th><th>å®Œäº†</th><th>è§£æä¸­</th></tr></thead><tbody>`+
[...new Set(specs.map(s=>s.Cancer_Type__c).filter(Boolean))].map(ct=>{
const ctSpecs=specs.filter(s=>s.Cancer_Type__c===ct);
const done=ctSpecs.filter(s=>['è§£æå®Œäº†','ãƒ¬ãƒãƒ¼ãƒˆç™ºè¡Œæ¸ˆ'].includes(s.Specimen_Status__c));
const analyzing=ctSpecs.filter(s=>s.Specimen_Status__c==='è§£æä¸­');
return`<tr><td>${ct}</td><td>${ctSpecs.length}</td><td>${done.length}</td><td>${analyzing.length}</td></tr>`}).join('')+
`</tbody></table></div>`}
function iTestRep(){
const mtd=MONTHLY_TESTING_DATA;
mc('rpt-monthly',{type:'bar',data:{labels:mtd.map(m=>m.month.slice(5)+'æœˆ'),datasets:[{label:'å‡ºä»¶æ•°',data:mtd.map(m=>m.orders),backgroundColor:'#0176d3'},{label:'å®Œäº†æ•°',data:mtd.map(m=>m.completed),backgroundColor:'#2ecc71'}]},options:{responsive:true,plugins:{legend:{position:'top'}}}},'obj:Testing_Order__c');
mc('rpt-tat',{type:'line',data:{labels:mtd.map(m=>m.month.slice(5)+'æœˆ'),datasets:[{label:'å¹³å‡TAT(æ—¥)',data:mtd.map(m=>m.avgTAT),borderColor:'#e74c3c',backgroundColor:'rgba(231,76,60,.1)',fill:true,tension:.3}]},options:{responsive:true,plugins:{legend:{display:false}}}},'obj:Testing_Order__c')}

// ===== å–¶æ¥­ãƒãƒ¼ãƒ ãƒ¬ãƒãƒ¼ãƒˆ =====
function rSalesTeam(){
const opps=D.Pharma_Opportunity__c||[],vis=D.Visit_Record__c||[];
const salesUsers=USERS.filter(u=>u.team==='Sales');
let h='<div class="grid grid-3">';
salesUsers.forEach(u=>{
const uOpps=opps.filter(o=>o.Owner_Name__c===u.name);
const uWon=uOpps.filter(o=>o.Phase__c==='æˆç´„').reduce((s,o)=>s+(o.Amount__c||0),0);
const uPipe=uOpps.filter(o=>!['æˆç´„','å¤±æ³¨'].includes(o.Phase__c)).reduce((s,o)=>s+(o.Amount__c||0),0);
const uVis=vis.filter(v=>{const docs=(D.Doctor__c||[]).filter(d=>d.Assigned_MR__c===u.name).map(d=>d.Id);return docs.includes(v.Doctor__c)}).length;
h+=`<div class="card" style="text-align:center"><div style="font-size:36px">${u.photo}</div><div style="font-weight:600;margin:8px 0">${u.name}</div><div style="color:#888;font-size:12px;margin-bottom:12px">${u.role}</div>
<div class="grid grid-3" style="gap:8px">
<div style="background:#e8f5e9;padding:8px;border-radius:6px"><div style="font-size:18px;font-weight:700;color:#2e7d32">${fmt(uWon)}</div><div style="font-size:11px;color:#888">æˆç´„</div></div>
<div style="background:#e3f2fd;padding:8px;border-radius:6px"><div style="font-size:18px;font-weight:700;color:#1565c0">${fmt(uPipe)}</div><div style="font-size:11px;color:#888">ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³</div></div>
<div style="background:#fff3e0;padding:8px;border-radius:6px"><div style="font-size:18px;font-weight:700;color:#e65100">${uVis}</div><div style="font-size:11px;color:#888">è¨ªå•æ•°</div></div>
</div></div>`});
h+='</div>';
return h}

// ===== æ‰¿èªã‚­ãƒ¥ãƒ¼ =====
function rApproval(){
const ars=D.Approval_Request__c||[];
const pending=ars.filter(a=>['ç”³è«‹ä¸­','æ‰¿èªå¾…ã¡'].includes(a.Status__c)).length;
const approved=ars.filter(a=>a.Status__c==='æ‰¿èªæ¸ˆ').length;
const totalApproved=ars.filter(a=>a.Status__c==='æ‰¿èªæ¸ˆ').reduce((s,a)=>s+(a.Amount__c||0),0);
let h=`<div class="grid grid-4" style="margin-bottom:20px">
<div class="kpi-card" onclick="nav('obj','Approval_Request__c')"><div class="kv">${pending}</div><div class="kl">æœªå‡¦ç†</div></div>
<div class="kpi-card" onclick="nav('obj','Approval_Request__c')"><div class="kv">${approved}</div><div class="kl">æ‰¿èªæ¸ˆ</div></div>
<div class="kpi-card" onclick="nav('obj','Approval_Request__c')"><div class="kv">Â¥${totalApproved.toLocaleString()}</div><div class="kl">æ‰¿èªæ¸ˆé‡‘é¡</div></div>
<div class="kpi-card" onclick="nav('obj','Approval_Request__c')"><div class="kv">${ars.length}</div><div class="kl">å…¨ç”³è«‹æ•°</div></div>
</div>`;
const actionItems=ars.filter(a=>['ç”³è«‹ä¸­','æ‰¿èªå¾…ã¡'].includes(a.Status__c));
if(actionItems.length){h+=`<div class="card"><h3>å¯¾å¿œãŒå¿…è¦ãªç”³è«‹</h3>`;
actionItems.forEach(a=>{
const prColor={'é«˜':'#e74c3c','ä¸­':'#f39c12','ä½':'#3498db'}[a.Priority__c]||'#888';
h+=`<div style="border:1px solid #e0e0e0;border-radius:8px;padding:16px;margin-bottom:12px;border-left:4px solid ${prColor}">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<div style="font-weight:600">${a.Name}</div>
<span class="sb ${sc(a.Priority__c)}">${a.Priority__c}</span>
</div>
<div style="color:#888;font-size:13px;margin-bottom:8px">${a.Request_Type__c} | Â¥${(a.Amount__c||0).toLocaleString()} | ç”³è«‹è€…: ${userName(a.Requested_By__c)} | ${a.Submitted_Date__c||'-'}</div>
${a.Description__c?`<div style="font-size:13px;color:#555;margin-bottom:8px">${(a.Description__c||'').slice(0,200)}${(a.Description__c||'').length>200?'...':''}</div>`:''}
</div>`});
h+=`</div>`}
h+=`<div class="card"><h3>æ‰¿èªå±¥æ­´</h3><table><thead><tr><th>ç”³è«‹å</th><th>ç¨®åˆ¥</th><th>é‡‘é¡</th><th>ç”³è«‹è€…</th><th>æ‰¿èªè€…</th><th>çŠ¶æ…‹</th><th>æ—¥ä»˜</th></tr></thead><tbody>`;
ars.forEach(a=>h+=`<tr><td>${a.Name}</td><td>${a.Request_Type__c}</td><td>Â¥${(a.Amount__c||0).toLocaleString()}</td><td>${userName(a.Requested_By__c)}</td><td>${userName(a.Approver__c)}</td><td><span class="sb ${sc(a.Status__c)}">${a.Status__c}</span></td><td>${a.Submitted_Date__c||'-'}</td></tr>`);
h+=`</tbody></table></div>`;
return h}

// ===== ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç®¡ç† =====
function rWorkflow(){
const wfs=D.Workflow_Instance__c||[];
const active=wfs.filter(w=>['é€²è¡Œä¸­','æ‰¿èªå¾…ã¡'].includes(w.Status__c));
const overdue=active.filter(w=>w.Due_Date__c&&w.Due_Date__c<new Date().toISOString().slice(0,10));
const completed=wfs.filter(w=>w.Status__c==='å®Œäº†');
let h=`<div class="grid grid-4" style="margin-bottom:20px">
<div class="kpi-card" onclick="nav('obj','Workflow_Instance__c')"><div class="kv">${active.length}</div><div class="kl">é€²è¡Œä¸­</div></div>
<div class="kpi-card" onclick="nav('obj','Workflow_Instance__c')"><div class="kv">${wfs.filter(w=>w.Status__c==='æ‰¿èªå¾…ã¡').length}</div><div class="kl">æ‰¿èªå¾…ã¡</div></div>
<div class="kpi-card" onclick="nav('obj','Workflow_Instance__c')"><div class="kv">${overdue.length}</div><div class="kl">æœŸé™è¶…é</div><div class="ks" style="color:#e74c3c">${overdue.length?'è¦å¯¾å¿œ':''}</div></div>
<div class="kpi-card" onclick="nav('obj','Workflow_Instance__c')"><div class="kv">${completed.length}</div><div class="kl">å®Œäº†</div></div>
</div>`;
h+=`<div style="margin-bottom:16px"><button class="btn pri" onclick="nav('workflow-new')">ï¼‹ æ–°è¦ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼</button></div>`;
h+=`<div class="card"><h3>ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç¨®åˆ¥</h3><div class="grid grid-3" style="padding:16px">`;
Object.entries(WORKFLOW_TEMPLATES).forEach(([type,tmpl])=>{
const typeWfs=wfs.filter(w=>w.Workflow_Type__c===type);
const typeActive=typeWfs.filter(w=>['é€²è¡Œä¸­','æ‰¿èªå¾…ã¡'].includes(w.Status__c)).length;
h+=`<div style="border-left:4px solid ${tmpl.color};padding:12px;background:#f8f8f8;border-radius:6px">
<div style="font-size:20px">${tmpl.icon}</div>
<div style="font-weight:600;margin:4px 0">${tmpl.name}</div>
<div style="color:#888;font-size:12px">é€²è¡Œä¸­: ${typeActive} | å®Œäº†: ${typeWfs.filter(w=>w.Status__c==='å®Œäº†').length} | ã‚¹ãƒ†ãƒƒãƒ—: ${tmpl.steps.length}</div>
</div>`});
h+=`</div></div>`;
h+=`<div class="card"><h3>ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¸€è¦§</h3><table><thead><tr><th>åå‰</th><th>ç¨®åˆ¥</th><th>çŠ¶æ…‹</th><th>å„ªå…ˆåº¦</th><th>é€²æ—</th><th>æœŸé™</th></tr></thead><tbody>`;
wfs.sort((a,b)=>{const so={'é€²è¡Œä¸­':0,'æ‰¿èªå¾…ã¡':1,'æœªé–‹å§‹':2,'å®Œäº†':3,'ä¸­æ­¢':4};return(so[a.Status__c]||9)-(so[b.Status__c]||9)}).forEach(w=>{
const prog=w.Total_Steps__c?Math.round(w.Current_Step__c/w.Total_Steps__c*100):0;
const tmpl=WORKFLOW_TEMPLATES[w.Workflow_Type__c]||{icon:'ğŸ“‹',color:'#888'};
const isOverdue=w.Due_Date__c&&w.Due_Date__c<new Date().toISOString().slice(0,10)&&w.Status__c!=='å®Œäº†';
h+=`<tr onclick="nav('workflow-detail','${w.Id}')" style="cursor:pointer"><td>${tmpl.icon} ${w.Name}</td><td>${w.Workflow_Type__c}</td><td><span class="sb ${sc(w.Status__c)}">${w.Status__c}</span></td><td><span class="sb ${sc(w.Priority__c)}">${w.Priority__c}</span></td><td><div style="display:flex;align-items:center;gap:8px"><div style="width:60px;height:6px;background:#e0e0e0;border-radius:3px"><div style="width:${prog}%;height:100%;background:${tmpl.color};border-radius:3px"></div></div>${prog}%</div></td><td style="${isOverdue?'color:#e74c3c;font-weight:600':''}">${w.Due_Date__c||'-'}${isOverdue?' âš ï¸':''}</td></tr>`});
h+=`</tbody></table></div>`;
return h}

// ===== ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è©³ç´° =====
function rWfDetail(){
const wfId=co;
const wf=(D.Workflow_Instance__c||[]).find(w=>w.Id===wfId);
if(!wf)return`<div class="card"><p>ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p><button class="btn sec" onclick="nav('workflow')">â† æˆ»ã‚‹</button></div>`;
const tmpl=WORKFLOW_TEMPLATES[wf.Workflow_Type__c]||{icon:'ğŸ“‹',color:'#888',steps:[]};
const prog=wf.Total_Steps__c?Math.round(wf.Current_Step__c/wf.Total_Steps__c*100):0;
const isOverdue=wf.Due_Date__c&&wf.Due_Date__c<new Date().toISOString().slice(0,10)&&wf.Status__c!=='å®Œäº†';
let h=`<div style="margin-bottom:16px"><button class="btn sec" onclick="nav('workflow')">â† ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¸€è¦§</button></div>`;
h+=`<div class="card" style="border-left:4px solid ${tmpl.color}">
<div style="display:flex;justify-content:space-between;align-items:flex-start">
<div><h3 style="margin:0">${tmpl.icon} ${wf.Name}</h3>
<div style="margin-top:8px"><span class="sb ${sc(wf.Status__c)}">${wf.Status__c}</span> <span class="sb ${sc(wf.Priority__c)}">${wf.Priority__c}</span></div>
<div style="color:#888;margin-top:8px;font-size:13px">${wf.Description__c||''}</div>
<div style="margin-top:12px;font-size:13px;color:#555">
<div>ç”³è«‹è€…: ${userName(wf.Requested_By__c)} | æ‹…å½“: ${userName(wf.Current_Assignee__c)}</div>
<div>é–‹å§‹: ${wf.Start_Date__c||'-'} | æœŸé™: <span style="${isOverdue?'color:#e74c3c;font-weight:600':''}">${wf.Due_Date__c||'-'}${isOverdue?' âš ï¸':''}</span>${wf.Completed_Date__c?' | å®Œäº†: '+wf.Completed_Date__c:''}</div>
</div></div>
<div style="text-align:center"><div style="width:80px;height:80px;border-radius:50%;border:6px solid ${tmpl.color};display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;color:${tmpl.color}">${prog}%</div><div style="font-size:12px;color:#888;margin-top:4px">${wf.Current_Step__c}/${wf.Total_Steps__c}ã‚¹ãƒ†ãƒƒãƒ—</div></div>
</div></div>`;
h+=`<div class="card"><h3>ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¹ãƒ†ãƒƒãƒ—</h3><div style="padding:16px">`;
tmpl.steps.forEach((step,i)=>{
const stepNum=i+1;
const isDone=stepNum<wf.Current_Step__c;
const isCurrent=stepNum===wf.Current_Step__c;
const dotColor=isDone?'#2ecc71':isCurrent?tmpl.color:'#e0e0e0';
const icon=isDone?'âœ“':isCurrent?'â–¶':stepNum;
h+=`<div style="display:flex;align-items:flex-start;margin-bottom:${i<tmpl.steps.length-1?'0':'0'}px">
<div style="display:flex;flex-direction:column;align-items:center;margin-right:16px">
<div style="width:32px;height:32px;border-radius:50%;background:${dotColor};color:white;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:600">${icon}</div>
${i<tmpl.steps.length-1?`<div style="width:2px;height:32px;background:${isDone?'#2ecc71':'#e0e0e0'}"></div>`:''}
</div>
<div style="padding:4px 0 16px"><div style="font-weight:${isCurrent?'700':'400'}">${step}</div>
<div style="font-size:12px;color:#888">${isDone?'å®Œäº†':isCurrent?'é€²è¡Œä¸­':'æœªç€æ‰‹'}</div>
</div></div>`});
h+=`</div></div>`;
return h}

// ===== ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ–°è¦ä½œæˆ =====
function rWfNew(){
let h=`<div style="margin-bottom:16px"><button class="btn sec" onclick="nav('workflow')">â† ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¸€è¦§</button></div>`;
h+=`<div class="card" style="max-width:800px"><h3>æ–°è¦ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä½œæˆ</h3><div style="padding:16px">
<div style="margin-bottom:16px"><label style="font-weight:600;display:block;margin-bottom:4px">ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç¨®åˆ¥</label>
<select id="wfType" onchange="wfTypeChanged()" style="width:100%;padding:8px;border:1px solid #d8dde6;border-radius:6px">`;
Object.entries(WORKFLOW_TEMPLATES).forEach(([type,tmpl])=>h+=`<option value="${type}">${tmpl.icon} ${tmpl.name}</option>`);
h+=`</select></div>
<div style="margin-bottom:16px"><label style="font-weight:600;display:block;margin-bottom:4px">ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å</label>
<input type="text" id="wfName" placeholder="ä¾‹: ä½è—¤èŠ±å­ ãƒ†ãƒªãƒˆãƒªãƒ¼å¼•ãç¶™ã" style="width:100%;padding:8px;border:1px solid #d8dde6;border-radius:6px"></div>
<div class="grid grid-3" style="margin-bottom:16px">
<div><label style="font-weight:600;display:block;margin-bottom:4px">å„ªå…ˆåº¦</label>
<select id="wfPriority" style="width:100%;padding:8px;border:1px solid #d8dde6;border-radius:6px"><option>ä¸­</option><option>é«˜</option><option>ç·Šæ€¥</option><option>ä½</option></select></div>
<div><label style="font-weight:600;display:block;margin-bottom:4px">é–‹å§‹æ—¥</label>
<input type="date" id="wfStart" value="${new Date().toISOString().slice(0,10)}" style="width:100%;padding:8px;border:1px solid #d8dde6;border-radius:6px"></div>
<div><label style="font-weight:600;display:block;margin-bottom:4px">æœŸé™æ—¥</label>
<input type="date" id="wfDue" style="width:100%;padding:8px;border:1px solid #d8dde6;border-radius:6px"></div>
</div>
<div style="margin-bottom:16px"><label style="font-weight:600;display:block;margin-bottom:4px">èª¬æ˜</label>
<textarea id="wfDesc" rows="3" style="width:100%;padding:8px;border:1px solid #d8dde6;border-radius:6px" placeholder="ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®èª¬æ˜ã‚’å…¥åŠ›..."></textarea></div>
<div id="wfStepsPreview"></div>
<div style="margin-top:20px;display:flex;gap:8px">
<button class="btn pri" onclick="toast('ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä½œæˆæ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™')">ä½œæˆ</button>
<button class="btn sec" onclick="nav('workflow')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div></div></div>`;
return h}
function bWfNew(){wfTypeChanged()}
function wfTypeChanged(){
const type=document.getElementById('wfType').value;
const tmpl=WORKFLOW_TEMPLATES[type];
if(!tmpl)return;
const startEl=document.getElementById('wfStart');
const dueEl=document.getElementById('wfDue');
if(startEl&&dueEl){const start=new Date(startEl.value||Date.now());start.setDate(start.getDate()+tmpl.sla);dueEl.value=start.toISOString().slice(0,10)}
const preview=document.getElementById('wfStepsPreview');
if(preview){let h=`<div style="border-left:4px solid ${tmpl.color};padding:12px;background:#f8f8f8;border-radius:6px"><div style="font-weight:600;margin-bottom:8px">${tmpl.icon} ${tmpl.name} (SLA: ${tmpl.sla}æ—¥)</div><div style="display:flex;gap:4px;margin-bottom:8px">`;
tmpl.steps.forEach((_,i)=>h+=`<div style="width:12px;height:12px;border-radius:50%;background:${tmpl.color};opacity:${0.3+i*0.1}"></div>`);
h+=`</div><table style="width:100%;font-size:13px"><thead><tr><th>#</th><th>ã‚¹ãƒ†ãƒƒãƒ—</th></tr></thead><tbody>`;
tmpl.steps.forEach((s,i)=>h+=`<tr><td>${i+1}</td><td>${s}</td></tr>`);
h+=`</tbody></table></div>`;
preview.innerHTML=h}}

// ===== KOLãƒãƒƒãƒ— =====
function rKOLMap(){
const docs=(D.Doctor__c||[]).filter(d=>d.KOL_Score__c>0).sort((a,b)=>(b.KOL_Score__c||0)-(a.KOL_Score__c||0));
const t1=docs.filter(d=>d.KOL_Score__c>=80),t2=docs.filter(d=>d.KOL_Score__c>=50&&d.KOL_Score__c<80),t3=docs.filter(d=>d.KOL_Score__c>=20&&d.KOL_Score__c<50),t4=docs.filter(d=>d.KOL_Score__c<20);
let h=`<div class="grid grid-4" style="margin-bottom:20px">
<div class="kpi-card" style="border-left:4px solid #e74c3c" onclick="nav('obj','Doctor__c')"><div class="kv">${t1.length}</div><div class="kl">Tier 1 (80+)</div></div>
<div class="kpi-card" style="border-left:4px solid #f39c12" onclick="nav('obj','Doctor__c')"><div class="kv">${t2.length}</div><div class="kl">Tier 2 (50-79)</div></div>
<div class="kpi-card" style="border-left:4px solid #3498db" onclick="nav('obj','Doctor__c')"><div class="kv">${t3.length}</div><div class="kl">Tier 3 (20-49)</div></div>
<div class="kpi-card" style="border-left:4px solid #95a5a6" onclick="nav('obj','Doctor__c')"><div class="kv">${t4.length}</div><div class="kl">Others (<20)</div></div>
</div>`;
h+=`<div class="card"><h3>KOLãƒãƒˆãƒªã‚¯ã‚¹</h3><table><thead><tr><th>ãƒ‰ã‚¯ã‚¿ãƒ¼</th><th>æ–½è¨­</th><th>å°‚é–€</th><th>KOLã‚¹ã‚³ã‚¢</th><th>é–¢ä¿‚æ§‹ç¯‰åº¦</th><th>è¨ªå•å›æ•°</th><th>ç´¹ä»‹æ¤œä½“</th></tr></thead><tbody>`;
docs.forEach(d=>{
const score=d.KOL_Score__c||0;
const barColor=score>=80?'#e74c3c':score>=50?'#f39c12':score>=20?'#3498db':'#95a5a6';
h+=`<tr onclick="sd('Doctor__c','${d.Id}')" style="cursor:pointer"><td>${d.Name}</td><td>${mi(d.Medical_Institution__c)}</td><td>${d.Department__c||'-'}</td>
<td><div style="display:flex;align-items:center;gap:8px"><div style="width:60px;height:8px;background:#e0e0e0;border-radius:4px"><div style="width:${score}%;height:100%;background:${barColor};border-radius:4px"></div></div>${score}</div></td>
<td><span class="sb ${sc(d.Relationship_Level__c)}">${d.Relationship_Level__c||'-'}</span></td><td>${d.Visit_Count__c||0}</td><td>${d.Referred_Specimen_Count__c||0}</td></tr>`});
h+=`</tbody></table></div>`;
return h}

// ===== ç«¶åˆæƒ…å ± =====
function rCompIntel(){
const cis=(D.Competitive_Intel__c||[]).sort((a,b)=>(b.Date__c||'').localeCompare(a.Date__c||''));
const competitors=[...new Set(cis.map(c=>c.Competitor__c).filter(Boolean))];
const highImpact=cis.filter(c=>c.Impact__c==='é«˜').length;
let h=`<div class="grid grid-${2+Math.min(competitors.length,2)}" style="margin-bottom:20px">
<div class="kpi-card" onclick="nav('obj','Competitive_Intel__c')"><div class="kv">${cis.length}</div><div class="kl">æƒ…å ±ä»¶æ•°</div></div>
<div class="kpi-card" onclick="nav('obj','Competitive_Intel__c')"><div class="kv">${highImpact}</div><div class="kl">é«˜ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ</div></div>`;
competitors.slice(0,2).forEach(c=>h+=`<div class="kpi-card" onclick="nav('obj','Competitive_Intel__c')"><div class="kv">${cis.filter(ci=>ci.Competitor__c===c).length}</div><div class="kl">${c.slice(0,15)}</div></div>`);
h+=`</div>`;
h+=`<div class="card"><h3>ç«¶åˆæƒ…å ±ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h3>`;
cis.forEach(c=>{
const impColor={'é«˜':'#e74c3c','ä¸­':'#f39c12','ä½':'#3498db'}[c.Impact__c]||'#888';
h+=`<div style="border-left:4px solid ${impColor};padding:12px 16px;margin:12px 16px;background:#f8f8f8;border-radius:0 6px 6px 0">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
<div style="font-size:12px;color:#888">${c.Date__c||'-'} | ${c.Competitor__c||'-'} | ${c.Intel_Type__c||'-'}</div>
<span class="sb ${sc(c.Impact__c)}">${c.Impact__c}</span>
</div>
<div style="font-weight:600;margin-bottom:4px">${c.Name}</div>
${c.Action_Required__c?`<div style="font-size:13px;color:#555">${c.Action_Required__c}</div>`:''}
</div>`});
h+=`</div>`;
return h}

// ===== ãƒ†ãƒªãƒˆãƒªãƒ¼åˆ†æ =====
function rTerritory(){
const insts=D.Medical_Institution__c||[],docs=D.Doctor__c||[],vis=D.Visit_Record__c||[];
const prefs=[...new Set(insts.map(i=>i.Prefecture__c).filter(Boolean))].sort();
let h=`<div class="card"><h3>éƒ½é“åºœçœŒåˆ¥ã‚«ãƒãƒ¬ãƒƒã‚¸</h3><table><thead><tr><th>éƒ½é“åºœçœŒ</th><th>æ–½è¨­æ•°</th><th>å°å…¥æ¸ˆ</th><th>Dræ•°</th><th>è¨ªå•æ•°</th><th>ã‚«ãƒãƒ¬ãƒƒã‚¸</th></tr></thead><tbody>`;
prefs.forEach(p=>{
const pInsts=insts.filter(i=>i.Prefecture__c===p);
const adopted=pInsts.filter(i=>i.Adapter_Status__c==='å°å…¥å®Œäº†').length;
const pInstIds=pInsts.map(i=>i.Id);
const pDocs=docs.filter(d=>pInstIds.includes(d.Medical_Institution__c)).length;
const pVis=vis.filter(v=>{const doc=(docs).find(d=>d.Id===v.Doctor__c);return doc&&pInstIds.includes(doc.Medical_Institution__c)}).length;
const coverage=pInsts.length?pct(adopted,pInsts.length):0;
const covColor=coverage>=75?'#2ecc71':coverage>=50?'#f39c12':'#e74c3c';
h+=`<tr><td>${p}</td><td>${pInsts.length}</td><td>${adopted}</td><td>${pDocs}</td><td>${pVis}</td>
<td><div style="display:flex;align-items:center;gap:8px"><div style="width:80px;height:8px;background:#e0e0e0;border-radius:4px"><div style="width:${coverage}%;height:100%;background:${covColor};border-radius:4px"></div></div>${coverage}%</div></td></tr>`});
h+=`</tbody></table></div>`;
const salesUsers=USERS.filter(u=>u.team==='Sales');
h+=`<div class="card"><h3>MRåˆ¥ãƒ†ãƒªãƒˆãƒªãƒ¼</h3><div class="grid grid-3" style="padding:16px">`;
salesUsers.forEach(u=>{
const uDocs=docs.filter(d=>d.Assigned_MR__c===u.name);
const uInsts=[...new Set(uDocs.map(d=>d.Medical_Institution__c).filter(Boolean))].length;
const uDocIds=uDocs.map(d=>d.Id);
const uVis=vis.filter(v=>uDocIds.includes(v.Doctor__c)).length;
const uPipe=(D.Pharma_Opportunity__c||[]).filter(o=>o.Owner_Name__c===u.name&&!['æˆç´„','å¤±æ³¨'].includes(o.Phase__c)).reduce((s,o)=>s+(o.Amount__c||0),0);
h+=`<div style="border:1px solid #e0e0e0;border-radius:8px;padding:16px"><div style="display:flex;align-items:center;gap:8px;margin-bottom:12px"><span style="font-size:28px">${u.photo}</span><div><div style="font-weight:600">${u.name}</div><div style="color:#888;font-size:12px">${u.role}</div></div></div>
<div class="grid grid-2" style="gap:8px;font-size:13px">
<div>Dr: ${uDocs.length}å</div><div>æ–½è¨­: ${uInsts}</div><div>è¨ªå•: ${uVis}ä»¶</div><div>PL: ${fmt(uPipe)}</div>
</div></div>`});
h+=`</div></div>`;
return h}

// ===== è¨ªå•ã‚¿ãƒ¼ã‚²ãƒƒãƒˆç®¡ç† =====
function rVisitTarget(){
const vts=D.Visit_Target__c||[];
const achieved=vts.filter(v=>v.Status__c==='é”æˆ').length;
const inProgress=vts.filter(v=>v.Status__c==='é€²è¡Œä¸­').length;
const notStarted=vts.filter(v=>v.Status__c==='æœªç€æ‰‹').length;
const totalTarget=vts.reduce((s,v)=>s+(v.Target_Visits__c||0),0);
const totalActual=vts.reduce((s,v)=>s+(v.Actual_Visits__c||0),0);
const overallAch=totalTarget?pct(totalActual,totalTarget):0;
let h=`<div class="grid grid-6" style="margin-bottom:20px">
<div class="kpi-card" onclick="nav('obj','Visit_Target__c')"><div class="kv">${vts.length}</div><div class="kl">ç·ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ</div></div>
<div class="kpi-card" onclick="nav('obj','Visit_Target__c')"><div class="kv">${achieved}</div><div class="kl">é”æˆ</div></div>
<div class="kpi-card" onclick="nav('obj','Visit_Target__c')"><div class="kv">${inProgress}</div><div class="kl">é€²è¡Œä¸­</div></div>
<div class="kpi-card" onclick="nav('obj','Visit_Target__c')"><div class="kv">${notStarted}</div><div class="kl">æœªç€æ‰‹</div></div>
<div class="kpi-card" onclick="nav('obj','Visit_Record__c')"><div class="kv">${totalActual}/${totalTarget}</div><div class="kl">è¨ªå•æ•°</div></div>
<div class="kpi-card" onclick="nav('obj','Visit_Target__c')"><div class="kv">${overallAch}%</div><div class="kl">å…¨ä½“é”æˆç‡</div></div>
</div>`;
const userIds=[...new Set(vts.map(v=>v.OwnerId).filter(Boolean))];
userIds.forEach(uid=>{
const u=USERS.find(u=>u.id===uid);
if(!u)return;
const uVts=vts.filter(v=>v.OwnerId===uid);
const uAch=uVts.filter(v=>v.Status__c==='é”æˆ').length;
const achRate=uVts.length?pct(uAch,uVts.length):0;
const achColor=achRate>=80?'#2ecc71':achRate>=50?'#f39c12':'#e74c3c';
h+=`<div class="card"><div style="display:flex;align-items:center;gap:12px;margin-bottom:12px"><span style="font-size:28px">${u.photo}</span><div style="flex:1"><div style="font-weight:600">${u.name} <span style="color:#888;font-size:12px">${u.role}</span></div><div style="display:flex;align-items:center;gap:8px;margin-top:4px"><div style="flex:1;height:8px;background:#e0e0e0;border-radius:4px"><div style="width:${achRate}%;height:100%;background:${achColor};border-radius:4px"></div></div><span style="font-weight:600;color:${achColor}">${achRate}%</span></div></div></div>`;
h+=`<table><thead><tr><th>å„ªå…ˆåº¦</th><th>ãƒ‰ã‚¯ã‚¿ãƒ¼</th><th>ç›®çš„</th><th>ç›®æ¨™</th><th>å®Ÿç¸¾</th><th>é”æˆç‡</th><th>æ¬¡å›</th><th>çŠ¶æ…‹</th></tr></thead><tbody>`;
uVts.sort((a,b)=>{const po={'Aï¼ˆæœ€å„ªå…ˆï¼‰':0,'Bï¼ˆé‡è¦ï¼‰':1,'Cï¼ˆé€šå¸¸ï¼‰':2,'Dï¼ˆä½ï¼‰':3};return(po[a.Priority__c]||9)-(po[b.Priority__c]||9)}).forEach(v=>{
h+=`<tr><td><span class="sb ${sc(v.Priority__c)}">${v.Priority__c||'-'}</span></td><td>${dn(v.Doctor__c)}</td><td>${v.Visit_Purpose__c||'-'}</td><td>${v.Target_Visits__c}</td><td>${v.Actual_Visits__c}</td><td>${v.Achievement_Rate__c||0}%</td><td>${v.Next_Visit_Date__c||'-'}</td><td><span class="sb ${sc(v.Status__c)}">${v.Status__c}</span></td></tr>`});
h+=`</tbody></table></div>`});
return h}

// ===== ãƒ‰ã‚¯ã‚¿ãƒ¼ã‚¢ã‚µã‚¤ãƒ³ =====
function rDocAssign(){
const docs=D.Doctor__c||[];
const salesUsers=USERS.filter(u=>['Sales','MA'].includes(u.team));
let h=`<div class="card"><h3>æ‹…å½“è€…åˆ¥ãƒ‰ã‚¯ã‚¿ãƒ¼æ•°</h3><table><thead><tr><th>æ‹…å½“è€…</th><th>å½¹å‰²</th><th>ãƒ‰ã‚¯ã‚¿ãƒ¼æ•°</th><th>KOLæ•°</th></tr></thead><tbody>`;
salesUsers.forEach(u=>{
const uDocs=docs.filter(d=>d.Assigned_MR__c===u.name);
const uKols=uDocs.filter(d=>d.Is_KOL__c);
h+=`<tr><td>${u.photo} ${u.name}</td><td>${u.role}</td><td>${uDocs.length}</td><td>${uKols.length}</td></tr>`});
h+=`</tbody></table></div>`;
h+=`<div class="card"><h3>å¼•ãç¶™ããƒ»ã‚¢ã‚µã‚¤ãƒ³å¤‰æ›´</h3><div style="padding:16px">
<div class="grid grid-2" style="margin-bottom:16px">
<div><label style="font-weight:600;display:block;margin-bottom:4px">å¼•ãç¶™ãå…ƒ</label>
<select id="assignFrom" style="width:100%;padding:8px;border:1px solid #d8dde6;border-radius:6px">
<option value="">é¸æŠã—ã¦ãã ã•ã„</option>`;
salesUsers.forEach(u=>h+=`<option value="${u.name}">${u.photo} ${u.name} (${u.role})</option>`);
h+=`</select></div>
<div><label style="font-weight:600;display:block;margin-bottom:4px">å¼•ãç¶™ãå…ˆ</label>
<select id="assignTo" style="width:100%;padding:8px;border:1px solid #d8dde6;border-radius:6px">
<option value="">é¸æŠã—ã¦ãã ã•ã„</option>`;
salesUsers.forEach(u=>h+=`<option value="${u.name}">${u.photo} ${u.name} (${u.role})</option>`);
h+=`</select></div></div>
<div style="margin-bottom:16px"><label style="font-weight:600;display:block;margin-bottom:4px">ç†ç”±</label>
<select style="width:100%;padding:8px;border:1px solid #d8dde6;border-radius:6px">
<option>é€€è·</option><option>ç•°å‹•</option><option>æ‹…å½“å¤‰æ›´</option><option>ç”£ä¼‘ãƒ»è‚²ä¼‘</option><option>ãã®ä»–</option>
</select></div>
<button class="btn pri" onclick="toast('å¼•ãç¶™ãæ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™')">å¼•ãç¶™ããƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
</div></div>`;
return h}

// ===== æ¤œä½“ãƒˆãƒ©ãƒƒã‚«ãƒ¼ =====
function rSpecTracker(){
const specs=(D.Specimen__c||[]).sort((a,b)=>(b.Received_Date__c||'').localeCompare(a.Received_Date__c||''));
const stages=['å—é ˜å¾…ã¡','å—é ˜æ¸ˆ','QCä¸­','è§£æä¸­','ãƒ¬ãƒãƒ¼ãƒˆç™ºè¡Œæ¸ˆ'];
const stageColors={'å—é ˜å¾…ã¡':'#95a5a6','å—é ˜æ¸ˆ':'#3498db','QCä¸­':'#f39c12','è§£æä¸­':'#9b59b6','ãƒ¬ãƒãƒ¼ãƒˆç™ºè¡Œæ¸ˆ':'#2ecc71'};
const stageProg={'å—é ˜å¾…ã¡':0,'å—é ˜æ¸ˆ':20,'QCä¸­':40,'QCåˆæ ¼':45,'è§£æä¸­':60,'è§£æå®Œäº†':80,'ãƒ¬ãƒãƒ¼ãƒˆç™ºè¡Œæ¸ˆ':100};
let h=`<div class="card"><h3>æ¤œä½“ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³</h3><div style="display:flex;align-items:center;justify-content:center;gap:4px;padding:20px;flex-wrap:wrap">`;
stages.forEach((s,i)=>{
const count=specs.filter(sp=>sp.Specimen_Status__c===s).length;
h+=`<div style="text-align:center;padding:12px 20px;background:${stageColors[s]||'#888'};color:white;border-radius:8px;min-width:100px"><div style="font-size:24px;font-weight:700">${count}</div><div style="font-size:12px">${s}</div></div>`;
if(i<stages.length-1)h+=`<div style="font-size:24px;color:#ccc">â†’</div>`});
h+=`</div></div>`;
h+=`<div class="card"><h3>æ¤œä½“ä¸€è¦§</h3>`;
specs.forEach(sp=>{
const prog=stageProg[sp.Specimen_Status__c]||0;
const stColor=stageColors[sp.Specimen_Status__c]||'#888';
h+=`<div onclick="sd('Specimen__c','${sp.Id}')" style="border:1px solid #e0e0e0;border-radius:8px;padding:12px;margin:8px 16px;cursor:pointer">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<div><span style="font-weight:600">${sp.Name}</span> <span style="color:#888;font-size:12px">${sp.Cancer_Type__c||''} | ${sp.Analysis_Panel__c||''}</span></div>
<span class="sb ${sc(sp.Specimen_Status__c)}">${sp.Specimen_Status__c}</span>
</div>
<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><div style="flex:1;height:6px;background:#e0e0e0;border-radius:3px"><div style="width:${prog}%;height:100%;background:${stColor};border-radius:3px"></div></div><span style="font-size:12px;color:#888">${prog}%</span></div>
<div style="font-size:12px;color:#888">æ–½è¨­: ${mi(sp.Medical_Institution__c)} | å—é ˜æ—¥: ${sp.Received_Date__c||'-'}</div>
</div>`});
h+=`</div>`;
return h}

// ===== çµŒè²»ç²¾ç®— =====
function rExpense(){
const exps=D.Expense_Report__c||[];
const total=exps.reduce((s,e)=>s+(e.Amount__c||0),0);
const pending=exps.filter(e=>e.Status__c==='ç”³è«‹ä¸­').reduce((s,e)=>s+(e.Amount__c||0),0);
const approved=exps.filter(e=>['æ‰¿èªæ¸ˆ','æ”¯æ‰•æ¸ˆ'].includes(e.Status__c)).reduce((s,e)=>s+(e.Amount__c||0),0);
const types=[...new Set(exps.map(e=>e.Expense_Type__c).filter(Boolean))];
const maxTypeAmt=Math.max(...types.map(t=>exps.filter(e=>e.Expense_Type__c===t).reduce((s,e)=>s+(e.Amount__c||0),0)),1);
let h=`<div class="grid grid-3" style="margin-bottom:20px">
<div class="kpi-card" onclick="nav('obj','Expense_Report__c')"><div class="kv">Â¥${total.toLocaleString()}</div><div class="kl">æœˆé–“çµŒè²»åˆè¨ˆ</div></div>
<div class="kpi-card" onclick="nav('obj','Expense_Report__c')"><div class="kv">Â¥${pending.toLocaleString()}</div><div class="kl">ç”³è«‹ä¸­é‡‘é¡</div></div>
<div class="kpi-card" onclick="nav('obj','Expense_Report__c')"><div class="kv">Â¥${approved.toLocaleString()}</div><div class="kl">æ‰¿èªæ¸ˆé‡‘é¡</div></div>
</div>`;
h+=`<div class="card"><h3>çµŒè²»ç¨®åˆ¥å†…è¨³</h3><div style="padding:16px">`;
types.forEach(t=>{
const tAmt=exps.filter(e=>e.Expense_Type__c===t).reduce((s,e)=>s+(e.Amount__c||0),0);
const barW=pct(tAmt,maxTypeAmt);
h+=`<div style="display:flex;align-items:center;gap:12px;margin-bottom:8px"><div style="width:100px;font-size:13px;text-align:right">${t}</div><div style="flex:1;height:20px;background:#e0e0e0;border-radius:4px"><div style="width:${barW}%;height:100%;background:#0176d3;border-radius:4px"></div></div><div style="font-size:13px;width:80px">Â¥${tAmt.toLocaleString()}</div></div>`});
h+=`</div></div>`;
h+=`<div class="card"><h3>çµŒè²»ä¸€è¦§</h3><table><thead><tr><th>ç•ªå·</th><th>æ—¥ä»˜</th><th>ç¨®åˆ¥</th><th>é‡‘é¡</th><th>èª¬æ˜</th><th>é ˜åæ›¸</th><th>çŠ¶æ…‹</th></tr></thead><tbody>`;
exps.sort((a,b)=>(b.Report_Date__c||'').localeCompare(a.Report_Date__c||'')).forEach(e=>h+=`<tr><td>${e.Name}</td><td>${e.Report_Date__c||'-'}</td><td>${e.Expense_Type__c}</td><td>Â¥${(e.Amount__c||0).toLocaleString()}</td><td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${e.Description__c||'-'}</td><td>${e.Receipt_Attached__c?'âœ…':'âŒ'}</td><td><span class="sb ${sc(e.Status__c)}">${e.Status__c}</span></td></tr>`);
h+=`</tbody></table></div>`;
return h}

// ===== ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« =====
let scheduleWeekOffset=0;
function rSchedule(){
const fieldUsers=USERS.filter(u=>u.team!=='External'&&u.team!=='Research');
let h='<div class="tab-bar" id="schTabs">';
fieldUsers.forEach((u,i)=>h+=`<div class="tab-btn${i===0?' active':''}" onclick="showSchedule('${u.id}',this)">${u.photo} ${u.name}</div>`);
h+='</div><div style="display:flex;gap:8px;margin:12px 0"><button class="btn sec sm" onclick="scheduleWeekOffset--;showSchedule(document.querySelector(\'#schTabs .active\')?.textContent?.trim()?.split(\' \')[1]||\'U001\')">â† å‰é€±</button><button class="btn sec sm" onclick="scheduleWeekOffset=0;showSchedule(document.querySelector(\'#schTabs .active\')?.textContent?.trim()?.split(\' \')[1]||\'U001\')">ä»Šé€±</button><button class="btn sec sm" onclick="scheduleWeekOffset++;showSchedule(document.querySelector(\'#schTabs .active\')?.textContent?.trim()?.split(\' \')[1]||\'U001\')">æ¬¡é€± â†’</button></div><div id="schContent"></div>';
return h}
function bSchedule(){const fieldUsers=USERS.filter(u=>u.team!=='External'&&u.team!=='Research');if(fieldUsers.length)showSchedule(fieldUsers[0].id)}
function showSchedule(userId,tab){
if(tab){document.querySelectorAll('#schTabs .tab-btn').forEach(t=>t.classList.remove('active'));tab.classList.add('active')}
const u=USERS.find(u=>u.id===userId);
if(!u){const fieldUsers=USERS.filter(u=>u.team!=='External'&&u.team!=='Research');if(fieldUsers.length)userId=fieldUsers[0].id}
const today=new Date();
const startOfWeek=new Date(today);
startOfWeek.setDate(today.getDate()-today.getDay()+1+scheduleWeekOffset*7);
const vis=(D.Visit_Record__c||[]).filter(v=>{const doc=(D.Doctor__c||[]).find(d=>d.Id===v.Doctor__c);return doc&&doc.Assigned_MR__c===(USERS.find(uu=>uu.id===userId)||{}).name});
const events=D.Event||[];
const sems=D.Seminar__c||[];
let h='<div class="grid grid-7" style="gap:8px">';
for(let i=0;i<7;i++){
const day=new Date(startOfWeek);
day.setDate(startOfWeek.getDate()+i);
const ds=day.toISOString().slice(0,10);
const isToday=ds===today.toISOString().slice(0,10);
const isWeekend=day.getDay()===0||day.getDay()===6;
const dayVis=vis.filter(v=>v.Visit_Date__c===ds);
const dayEvts=events.filter(e=>(e.StartDateTime||'').startsWith(ds));
const daySems=sems.filter(s=>s.Event_Date__c===ds);
const itemCount=dayVis.length+dayEvts.length+daySems.length;
h+=`<div style="border:1px solid ${isToday?'#0176d3':'#e0e0e0'};border-radius:8px;padding:12px;min-height:150px;background:${isToday?'#f0f7ff':isWeekend?'#fafafa':'white'}">
<div style="font-weight:600;margin-bottom:8px;display:flex;justify-content:space-between"><span>${ds.slice(5)} ${'æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ'[day.getDay()]}</span>${itemCount?`<span style="background:#0176d3;color:white;border-radius:10px;padding:2px 8px;font-size:11px">${itemCount}</span>`:''}</div>`;
dayVis.forEach(v=>h+=`<div style="font-size:12px;padding:4px 6px;margin-bottom:4px;background:#e3f2fd;border-radius:4px;border-left:3px solid #1565c0;cursor:pointer" onclick="sd('Visit_Record__c','${v.Id}')">ğŸ¥ ${dn(v.Doctor__c)}</div>`);
daySems.forEach(s=>h+=`<div style="font-size:12px;padding:4px 6px;margin-bottom:4px;background:#f3e5f5;border-radius:4px;border-left:3px solid #6a1b9a;cursor:pointer" onclick="sd('Seminar__c','${s.Id}')">ğŸ“š ${s.Name}</div>`);
dayEvts.forEach(e=>h+=`<div style="font-size:12px;padding:4px 6px;margin-bottom:4px;background:#e8f5e9;border-radius:4px;border-left:3px solid #2e7d32;cursor:pointer" onclick="sd('Event','${e.Id}')">ğŸ“… ${e.Subject||'-'}</div>`);
h+=`</div>`}
h+='</div>';
document.getElementById('schContent').innerHTML=h}

// ===== å‹‰å¼·ä¼šå‡ºå¸­è€…ç®¡ç† =====
function rSemAttendees(){
const sems=D.Seminar__c||[],atts=D.Seminar_Attendee__c||[],bentos=D.Bento_Order__c||[];
const totalAtts=atts.length;
const confirmed=atts.filter(a=>a.Attendance_Status__c==='å‡ºå¸­').length;
const bentoCount=bentos.length;
let h=`<div class="grid grid-4" style="margin-bottom:20px">
<div class="kpi-card" onclick="nav('obj','Seminar__c')"><div class="kv">${sems.length}</div><div class="kl">å‹‰å¼·ä¼šæ•°</div></div>
<div class="kpi-card" onclick="nav('obj','Seminar_Attendee__c')"><div class="kv">${totalAtts}</div><div class="kl">ç™»éŒ²è€…æ•°</div></div>
<div class="kpi-card" onclick="nav('obj','Seminar_Attendee__c')"><div class="kv">${confirmed}</div><div class="kl">å‡ºå¸­ç¢ºèªæ¸ˆ</div></div>
<div class="kpi-card" onclick="nav('bento')"><div class="kv">${bentoCount}</div><div class="kl">å¼å½“æ‰‹é…</div></div>
</div>`;
h+=`<div class="card"><h3>å‹‰å¼·ä¼šåˆ¥å‡ºå¸­è€…</h3><table><thead><tr><th>å‹‰å¼·ä¼š</th><th>æ—¥ä»˜</th><th>å½¢å¼</th><th>ç™»éŒ²æ•°</th><th>å‡ºå¸­</th><th>æ¬ å¸­</th><th>å¼å½“</th></tr></thead><tbody>`;
sems.forEach(s=>{
const sAtts=atts.filter(a=>a.Seminar__c===s.Id);
const attend=sAtts.filter(a=>a.Attendance_Status__c==='å‡ºå¸­').length;
const absent=sAtts.filter(a=>a.Attendance_Status__c==='æ¬ å¸­').length;
const sBentos=bentos.filter(b=>b.Seminar__c===s.Id).reduce((sum,b)=>sum+(b.Quantity__c||0),0);
h+=`<tr onclick="sd('Seminar__c','${s.Id}')"><td>${s.Name}</td><td>${s.Event_Date__c||'-'}</td><td>${s.Event_Format__c||'-'}</td><td>${sAtts.length}</td><td>${attend}</td><td>${absent}</td><td>${sBentos}</td></tr>`});
h+=`</tbody></table></div>`;
h+=`<div class="card"><h3>å…¨å‡ºå¸­è€…ä¸€è¦§</h3><table><thead><tr><th>æ°å</th><th>å‹‰å¼·ä¼š</th><th>æ‰€å±</th><th>ãƒ¡ãƒ¼ãƒ«</th><th>å‡ºæ¬ </th><th>ç™»éŒ²æ—¥</th></tr></thead><tbody>`;
atts.forEach(a=>h+=`<tr><td>${a.Name}</td><td>${dn(a.Seminar__c)}</td><td>${a.Affiliation__c||'-'}</td><td>${a.Email__c||'-'}</td><td><span class="sb ${sc(a.Attendance_Status__c)}">${a.Attendance_Status__c}</span></td><td>${a.Registration_Date__c||'-'}</td></tr>`);
h+=`</tbody></table></div>`;
return h}

// ===== INIT =====
window.addEventListener('popstate',function(e){
  if(e.state){
    cv=e.state.cv||'dashboard';co=e.state.co||null;cr=null;isEditing=false;
    if(e.state.crId&&e.state.co){sd(e.state.co,e.state.crId,true);return}
    if(cv==='obj'&&co){loadPage(co,1,{q:''}).then(()=>R());return}
    R();
  }
});
async function init(){await loadData();fetch('/api/me').then(r=>r.json()).then(u=>{document.getElementById('userName').textContent=u.displayName||u.email;document.getElementById('userBadge').textContent=u.profile;
if(u.isImpersonating){const b=document.getElementById('impersonateBanner');b.style.display='flex';document.getElementById('impersonateMsg').textContent='ä»£ç†ãƒ­ã‚°ã‚¤ãƒ³ä¸­: '+(u.displayName||u.email)+' ('+u.profile+') ã¨ã—ã¦é–²è¦§ä¸­ â€” ç®¡ç†è€…: '+(u.originalUser?.displayName||u.originalUser?.email||'')}
}).catch(()=>{document.getElementById('userName').textContent='ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰'});history.replaceState({cv:cv,co:co,crId:null},'');R()}
init();
</script>
</body>
</html>
